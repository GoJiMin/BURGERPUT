"use strict";(self.webpackChunkzenput_mobile=self.webpackChunkzenput_mobile||[]).push([[448],{"./src/backbone/features/ComplianceProjectCompletionRateReport/RecipientEmailSelector/views.js":function(e,t,i){i.d(t,{E:function(){return n}});var n=Backbone.Marionette.Layout.extend({template:"#tpl_report_recipient_email_selector",className:"card",title:null,userEmail:null,locationEmail:null,emailIsValid:null,saveEmailAddress:null,handleValidEmail:null,handleInvalidEmail:null,handleShowLegend:null,setLocationEmailByDefault:!1,showLegend:!0,events:{"click .show_email_selector_legend":"showSendEmailToLegend","click .email_radio":"toggleCustomEmailInput","change .custom_email_input":"handleEmailChange"},initialize:function(e){e=e||{},this.validateRequiredArguments(e),$.extend(this,e)},validateRequiredArguments:function(e){if([e.userEmail,e.locationEmail,e.title,e.saveEmailAddress,e.handleValidEmail,e.handleInvalidEmail,e.handleShowLegend].some(_.isUndefined))throw new Error("Programmer Error: RecipientEmailSelector must have a userEmail, locationEmail, title, saveEmailAddress, handleValidEmail, handleInvalidEmail and handleShowLegend")},templateHelpers:function(){return{user_email:this.userEmail,location_email:this.locationEmail,title:this.title,show_legend:this.showLegend,location_email_by_default:this.setLocationEmailByDefault,user_email_checked:!this.setLocationEmailByDefault||!this.locationEmail}},showSendEmailToLegend:function(e){this.handleShowLegend(e)},toggleCustomEmailInput:function(e){var t=this,i=e.target.value,n=this.$(".custom_email_input");({custom:function(){n.prop("disabled",!1),n.removeClass("disabled"),t.setEmailAddress(n.val())},location:function(){n.prop("disabled",!0),n.addClass("disabled"),t.setEmailAddress(t.locationEmail)},user:function(){n.prop("disabled",!0),n.addClass("disabled"),t.setEmailAddress(null)}})[i]()},handleEmailChange:function(e){this.setEmailAddress(e.target.value)},setEmailAddress:function(e){var t="user"===this.$(".email_radio:checked").val();if(this.validateCustomEmail(e),t)return this.saveEmailAddress(null),void this.handleValidEmail();this.isValidEmail(e)?(this.saveEmailAddress(e),this.handleValidEmail()):this.handleInvalidEmail()},validateCustomEmail:function(e){var t=this.$(".custom_email_input"),i=t.val(),n=this.isValidEmail(i);(null==i?void 0:i.trim())&&!n?n||t.addClass("invalid"):t.removeClass("invalid")},isValidEmail:function(e){return!e.includes(",")&&$f.utils.validate_email(e)}})},"./src/backbone/features/ComplianceProjectCompletionRateReport/views.js":function(e,t,i){i.d(t,{P:function(){return y}});var n=i("./src/backbone/shared/views/baseLayoutViews.js"),o=i("./src/backbone-unorganized/shared/forms.js"),a=o.Dn.extend({location_id:null,parent_project_id:null,filters:{recipient_email:null,date_start:null,date_end:null},url:function(){var e=new o.Ds,t=this.get("filters");t.recipient_email&&e.set("recipient_email",t.recipient_email),t.date_start&&e.set("date_start",t.date_start),t.date_end&&e.set("date_end",t.date_end);var i=e.get_query_string({attrs:["recipient_email","date_start","date_end"]});return"/api/v3/submissions/export/location/".concat(this.get("location_id"),"/project/").concat(this.get("parent_project_id"),"/?").concat(i)}}),s=o.Dn.extend({location_id:null,filters:{parent_project_id:null,date_start:null,date_end:null},defaults:{completion_rate:null},url:function(){var e=new o.Ds,t=this.get("filters");return t.parent_project_id&&e.set("parent_project_id",t.parent_project_id),t.date_start&&e.set("date_start",t.date_start),t.date_end&&e.set("date_end",t.date_end),"/api/v3/tasks/completion_rate/location/".concat(this.get("location_id"),"/?").concat(e.get_query_string({attrs:["parent_project_id","date_start","date_end"]}))}}),l=i("./src/backbone/shared/views/typeaheads.js"),r=o.DR.extend({model:o.IK,paginator:null,typeahead_search_attrs:["title"],search_param:"search",url:function(){var e=$f.mobile.dashboard.get_active_account(),t=this.paginator.get_query_string({attrs:["start","limit","order_by","search"]});return"/api/v3/projects/parents_recurring_form/location/".concat(e.id,"/?").concat(t)},initialize:function(e,t){t=t||{},$.extend(this,t),this.paginator||(this.paginator=new o.Ds({order_by:"title"}))}}),c=l.kG.extend({collection:new r,toolbarnav_title:function(){return _t("mobile_toolbarnav_title_select_project")},model:null,format_result:function(e){return e.get("title")}}),u=l.y3.extend({model:null,modal_class:c,i18n_key_placeholder:"mobile_toolbarnav_title_select_project",get_default_value:function(){return this.model?this.model.get("title"):""}}),d=Backbone.Marionette.Layout.extend({template:"#tpl_dashboard_project_compliance_date_range_selector",className:"card",title:null,saveDateRange:null,events:{"click .email_radio":"setDateRange"},initialize:function(e){e=e||{},this.validateRequiredArguments(e),$.extend(this,e)},validateRequiredArguments:function(e){if([e.title,e.saveDateRange].some(_.isUndefined))throw new Error("Programmer Error: DateRangeSelector must have a title and saveDateRange")},templateHelpers:function(){return{title:this.title}},setDateRange:function(e){var t=this.$(".email_radio:checked");this.saveDateRange(t.val())}}),m=i("../../../node_modules/date-fns/esm/addMinutes/index.js"),h=i("../../../node_modules/date-fns/esm/format/index.js"),f=i("../../../node_modules/date-fns/esm/endOfDay/index.js"),p=i("../../../node_modules/date-fns/esm/subDays/index.js"),g=i("../../../node_modules/date-fns/esm/startOfDay/index.js"),v=Backbone.Marionette.Layout.extend({template:"#tpl_dashboard_project_compliance_completion_rate",model:null,className:"card",dateRange:null,initialize:function(e){e=e||{},this.validateRequiredArguments(e),$.extend(this,e)},validateRequiredArguments:function(e){if([e.dateRange].some(_.isUndefined))throw new Error("Programmer Error: ProjectCompletionRate must have a dateRange")},templateHelpers:function(){var e=this.model.get("completion_rate"),t=$f.utils.round(100*e),i=t>50;return{completion_percentage:t,title:_t("mobile_compliance_completion_rate_in_last_days",{days:this.dateRange}),completion_rate_class:i?"pass":"fail"}}}),b=i("./src/backbone/features/ComplianceProjectCompletionRateReport/RecipientEmailSelector/views.js"),w=Backbone.Marionette.Layout.extend({template:"#tpl_email_selector_legend_modal",attributes:{id:"email_selector_legend_modal"},ANIMATION_TIME_MS:500,title:null,description:null,_close_trigger_els:null,templateHelpers:function(){return{title:this.title,description:this.description}},initialize:function(e){if(e=e||{},$.extend(this,e),!this.title)throw new Error("Programmer Error: EmailSelectorLegendModal must have a title")},onRender:function(){this._setup_close_events()},onShow:function(){var e=this;$f.mobile.nav.show_modal_touchblock({duration:this.ANIMATION_TIME_MS},(function(){e.close(),e.$el.css("opacity",0),e.$el.velocity({opacity:1},{duration:e.ANIMATION_TIME_MS/2})}))},close:function(){var e=arguments,t=this;this._destroy_close_events(),$f.mobile.nav.hide_modal_touchblock({duration:t.ANIMATION_TIME_MS}),t.$el.velocity({opacity:0},{duration:this.ANIMATION_TIME_MS/2,complete:function(){w.__super__.close.apply(t,e)}})},_setup_close_events:function(){this._close_trigger_els=this.$el.find(".modal_footer .close_modal"),this._destroy_close_events();var e=this;this._close_trigger_els.on("click",(function(t){e.close(t)}))},_destroy_close_events:function(){this._close_trigger_els.off("click")}}),y=n.IO.extend({template:"#tpl_project_compliance_report",allow_reverse_transitions:!0,toolbarnav_show_add_task:!1,toolbarnav_title:function(){return _t("mobile_compliance_submissions_report")},parentProject:null,recipientEmail:null,dateStart:null,dateEnd:null,dateRange:null,regions:{r_info_selector:".r_info_selector",r_info_completion_rate:".r_info_completion_rate",r_info_email_selector:".r_info_email_selector",r_info_date_range_selector:".r_info_date_range_selector"},events:{"click .submit_report":"exportReport"},initialize:function(e){e=e||{},$.extend(this,e);var t=new Date,i=(0,m.Z)(t,t.getTimezoneOffset());this.setDateRange(30),this.dateEnd=(0,h.Z)((0,f.Z)(i),$f.utils.UTC_ISO_FORMAT),this.selectParentProject=this.selectParentProject.bind(this),this.handleInvalidRecipientEmail=this.handleInvalidRecipientEmail.bind(this),this.handleValidRecipientEmail=this.handleValidRecipientEmail.bind(this),this.setRecipientEmailAddress=this.setRecipientEmailAddress.bind(this),this.saveDateRange=this.saveDateRange.bind(this),this.showSendEmailToLegend=this.showSendEmailToLegend.bind(this)},getDateStart:function(e){var t=new Date,i=(0,m.Z)(t,t.getTimezoneOffset()),n=this.getNDaysAgo(i,e);return(0,h.Z)(n,$f.utils.UTC_ISO_FORMAT)},getNDaysAgo:function(e,t){return(0,p.Z)((0,g.Z)(e),t-1)},onRender:function(){this.renderSelector();var e=this.$(".submit_report");this.parentProject&&(e.removeClass("hidden"),this.renderDateRangeSelector(),this.renderCompletionRate(),this.renderEmailSelector())},exportReport:function(e){e.preventDefault(),$f.mobile.notifications.show_loading_dialog();var t=$f.mobile.dashboard.get_active_account_or_group(),i={recipient_email:this.recipientEmail,date_start:this.dateStart,date_end:this.dateEnd};new a({location_id:t.get("id"),parent_project_id:this.parentProject.get("id"),filters:i}).fetch({success:function(e){$f.mobile.notifications.hide_loading_dialog(),$f.mobile.notifications.show_success_msg()},error:function(e){$f.mobile.notifications.hide_loading_dialog(),$f.mobile.notifications.show_error_msg()}})},renderSelector:function(){this.r_info_selector.show(new u({model:this.parentProject,post_on_select:this.selectParentProject}))},selectParentProject:function(e){this.parentProject=e,this.setDateRange(30),this.renderSelector(),this.renderDateRangeSelector(),this.renderCompletionRate(),this.renderEmailSelector();var t=this.$(".submit_report");t.removeClass("hidden"),t.prop("disabled",!1),t.removeClass("disabled")},renderDateRangeSelector:function(){this.r_info_date_range_selector.show(new d({title:_t("mobile_compliance_time_frame"),saveDateRange:this.saveDateRange}))},renderCompletionRate:function(){var e=this,t=$f.mobile.dashboard.get_active_account_or_group().get("id"),i={parent_project_id:this.parentProject.get("id"),date_start:this.dateStart,date_end:this.dateEnd},n=new s({location_id:t,filters:i});n.fetch({success:function(){e.r_info_completion_rate.show(new v({model:n,dateRange:e.dateRange}))},error:function(){e.r_info_completion_rate.show(new v({model:n,dateRange:e.dateRange}))}})},renderEmailSelector:function(){var e=$f.mobile.dashboard.get_active_account_or_group(),t=$f.active_user;this.r_info_email_selector.show(new b.E({title:_t("mobile_compliance_send_submissions_to"),userEmail:t.get("email"),locationEmail:e.get("email"),saveEmailAddress:this.setRecipientEmailAddress,handleValidEmail:this.handleValidRecipientEmail,handleInvalidEmail:this.handleInvalidRecipientEmail,handleShowLegend:this.showSendEmailToLegend}))},setRecipientEmailAddress:function(e){this.recipientEmail=e},setDateRange:function(e){this.dateRange=this.parseDateRange(e),this.dateStart=this.getDateStart(this.dateRange)},saveDateRange:function(e){this.setDateRange(e),this.renderCompletionRate()},parseDateRange:function(e){var t=parseInt(e);return isNaN(t)?30:t},handleValidRecipientEmail:function(){var e=this.$(".submit_report");e.prop("disabled",!1),e.removeClass("disabled")},handleInvalidRecipientEmail:function(){var e=this.$(".submit_report");e.prop("disabled",!0),e.addClass("disabled")},showSendEmailToLegend:function(e){$f.application.content_overlay.show(new w({title:_t("mobile_compliance_send_submissions_to_legend_title"),description:_t("mobile_compliance_send_submissions_to_legend_description_days",{days:this.dateRange})})),e.preventDefault()}})},"./src/backbone/features/EmbeddedAnalytics/models.js":function(e,t,i){i.d(t,{O:function(){return n}});var n=i("./src/backbone-unorganized/shared/forms.js").Dn.extend({defaults:{embed_url:null},url:"/api/v3/sigma/user_embed_url/"})},"./src/backbone/features/PrivacyPolicy/index.js":function(e,t,i){i.d(t,{p:function(){return n}});var n=i("./src/backbone/shared/views/baseLayoutViews.js").IO.extend({template:"#tpl_privacy_policy",toolbarnav_title:function(){return _t("mobile_privacy_policy")}})},"./src/backbone/features/SetupDeviceWizard/DeviceBarcodeStepView/view.js":function(e,t,i){i.d(t,{m:function(){return f}});var n=i("./src/backbone/features/SetupDeviceWizard/WizardStepPage/view.js"),o=i("./src/backbone-unorganized/utils/barcodes.js"),a=i("./src/backbone-unorganized/sensors/sensors.js"),s=Backbone.Marionette.ItemView.extend({template:"#tpl_animated_device_success_image"}),l=Backbone.Marionette.ItemView.extend({template:"#tpl_static_device_success_image"}),r=Backbone.Marionette.Layout.extend({className:"wizard",template:"#tpl_device_success_message_step",regions:{r_success_image:".r_success_image"},onRender:function(){window.customElements?this.r_success_image.show(new s):this.r_success_image.show(new l)}}),_=i("./src/backbone-unorganized/dashboard/views.js"),c=function(){return c=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var o in t=arguments[i])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},c.apply(this,arguments)},u=n.g.extend({template:"#tpl_lorawan_device_step",model:null,stepTitleKey:"mobile_sensors_device_eui_information",success_timeout:3e3,selectedManufacturer:null,events:{"keyup .barcode_value.eui":"updateDeviceId","click .field_action_btn":"scanDevEUI","click .next_step":"assignDevice"},templateHelpers:function(){return c(c({},u.__super__.templateHelpers.apply(this,arguments)),{dev_eui:this._getDeviceId(),dev_eui_title:"DevEUI"})},onRender:function(){this.updateNextButtonState(this._isEnabled())},updateDeviceId:function(e){var t=$(e.target);this.model.set_device_id(t.val()),this.updateNextButtonState(this._isEnabled())},scanDevEUI:function(){return e=this,t=void 0,n=function(){var e;return function(e,t){var i,n,o,a,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(a){return function(l){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,n=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((o=(o=s.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){s.label=a[1];break}if(6===a[0]&&s.label<o[1]){s.label=o[1],o=a;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(a);break}o[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],n=0}finally{i=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}}(this,(function(t){switch(t.label){case 0:return $f.mobile.is.web()?(alert(_t("mobile_alert_please_install_for_native")),[2,!1]):[4,(0,o.Y)()];case 1:return(e=t.sent())?(this.model.update_barcode_value(e,this.selectedManufacturer),this.render(),[2,!1]):[2,!1]}}))},new((i=void 0)||(i=Promise))((function(o,a){function s(e){try{r(n.next(e))}catch(e){a(e)}}function l(e){try{r(n.throw(e))}catch(e){a(e)}}function r(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,l)}r((n=n.apply(e,t||[])).next())}));var e,t,i,n},assignDevice:function(){var e=this,t=this;$f.mobile.notifications.show_loading_dialog(),this.model.set("manufacturer",this.selectedManufacturer);var i=$f.mobile.dashboard.get_active_account_or_group();this.model.sanitize_device_id(),this.model.save({},{type:"POST",success:function(){$f.mobile.notifications.hide_loading_dialog(),$f.mobile.nav.show(r),setTimeout((function(){i.fetch({error:function(){$f.mobile.logging.log_error("Error refetching account after device eui entry",{account:i,device:t.model})},complete:function(){$f.mobile.nav.go_back_to_view(_.MobileDashboard,{active_account_or_group:i,active_tab_id:"sensors",do_not_set_leftnav:!0,reset_active_group_or_account_on_close:!1})}})}),e.success_timeout)},error:function(e,t){$f.mobile.notifications.hide_loading_dialog(),$f.mobile.notifications.show_error_msg($f.mobile.sensors.util.get_error_string_from_response(t,!0))}})},_isEnabled:function(){return(0,a.GB)(this.model.get_device_id())},_getDeviceId:function(){return this.model.get_device_id()}}),d=function(){return d=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var o in t=arguments[i])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},d.apply(this,arguments)},m=n.g.extend({template:"#tpl_monnit_device_step",model:null,stepTitleKey:"mobile_sensors_device_barcode_information",success_timeout:3e3,selectedManufacturer:null,events:{"keyup .barcode_value.id":"updateDeviceId","keyup .barcode_value.sc":"updateDeviceSC","click .field_action_btn":"scanBarcode","click .next_step":"assignDevice"},templateHelpers:function(){return d(d({},m.__super__.templateHelpers.apply(this,arguments)),{id_number:this._getDeviceId(),sc_number:this._getDeviceSC(),id_number_title:_t("mobile_sensors_id_number",{untranslatedID:"ID"}),sc_code_title:_t("mobile_sensors_sc_code",{untranslatedSCCode:"SC"})})},onRender:function(){this.updateNextButtonState(this._isEnabled())},updateDeviceId:function(e){var t=$(e.target);this.model.set_device_id(t.val()),this.updateNextButtonState(this._isEnabled())},updateDeviceSC:function(e){var t=$(e.target);this.isSensorModel()?this.model.set("check_digit",t.val()):this.model.set("secondary_key",t.val()),this.updateNextButtonState(this._isEnabled())},scanBarcode:function(){return e=this,t=void 0,n=function(){var e;return function(e,t){var i,n,o,a,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(a){return function(l){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,n=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((o=(o=s.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){s.label=a[1];break}if(6===a[0]&&s.label<o[1]){s.label=o[1],o=a;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(a);break}o[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],n=0}finally{i=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}}(this,(function(t){switch(t.label){case 0:return $f.mobile.is.web()?(alert(_t("mobile_alert_please_install_for_native")),[2,!1]):[4,(0,o.Y)()];case 1:return(e=t.sent())?(this.model.update_barcode_value(e,this.selectedManufacturer),this.render(),[2,!1]):[2,!1]}}))},new((i=void 0)||(i=Promise))((function(o,a){function s(e){try{r(n.next(e))}catch(e){a(e)}}function l(e){try{r(n.throw(e))}catch(e){a(e)}}function r(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,l)}r((n=n.apply(e,t||[])).next())}));var e,t,i,n},assignDevice:function(){var e=this,t=this;$f.mobile.notifications.show_loading_dialog(),this.model.set("manufacturer",this.selectedManufacturer);var i=$f.mobile.dashboard.get_active_account_or_group();this.model.save({},{type:"POST",success:function(){$f.mobile.notifications.hide_loading_dialog(),$f.mobile.nav.show(r),setTimeout((function(){i.fetch({error:function(){$f.mobile.logging.log_error("Error refetching account after sensor device barcode scan",{account:i,device:t.model})},complete:function(){$f.mobile.nav.go_back_to_view(_.MobileDashboard,{active_account_or_group:i,active_tab_id:"sensors",do_not_set_leftnav:!0,reset_active_group_or_account_on_close:!1})}})}),e.success_timeout)},error:function(e,t){$f.mobile.notifications.hide_loading_dialog(),$f.mobile.notifications.show_error_msg($f.mobile.sensors.util.get_error_string_from_response(t,!0))}})},_isEnabled:function(){var e=this.model.get("external_key")||this.model.get("sensor_id"),t=this.model.get("secondary_key")||this.model.get("check_digit");return e&&t},_getDeviceId:function(){return this.isSensorModel()?this.model.get("sensor_id"):this.model.get("external_key")},_getDeviceSC:function(){return this.isSensorModel()?this.model.get("check_digit"):this.model.get("secondary_key")}}),h=function(){return h=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var o in t=arguments[i])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},h.apply(this,arguments)},f=n.g.extend({template:"#tpl_device_barcode_step",stepTitleKey:"mobile_sensors_device_barcode_information",selectedManufacturer:null,events:{"click .scan_barcode":"scanBarcode","click .enter_barcode_manually":"enterBarcodeManually"},initialize:function(e){e=e||{},$.extend(this,e),f.__super__.initialize.apply(this,arguments),this.selectedManufacturer===$f.mobile.sensors.util.INTEGRATION_TYPE.SENET&&(this.stepTitleKey="mobile_sensors_device_eui_information"),this.selectedManufacturer===$f.mobile.sensors.util.INTEGRATION_TYPE.MONNIT&&(this.stepTitleKey="mobile_sensors_device_barcode_information")},templateHelpers:function(){return h(h({},f.__super__.templateHelpers.apply(this,arguments)),{image_filename:this._getDeviceScanningImage(),scan_code_text:_t("mobile_sensors_scan_qrcode")})},scanBarcode:function(){return e=this,t=void 0,n=function(){var e;return function(e,t){var i,n,o,a,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(a){return function(l){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,n=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((o=(o=s.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){s.label=a[1];break}if(6===a[0]&&s.label<o[1]){s.label=o[1],o=a;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(a);break}o[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],n=0}finally{i=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}}(this,(function(t){switch(t.label){case 0:return $f.mobile.is.web()?(alert(_t("mobile_alert_please_install_for_native")),[2,!1]):[4,(0,o.Y)()];case 1:return(e=t.sent())?(this.model.update_barcode_value(e,this.selectedManufacturer),this.displayAddDeviceManually(),[2,!1]):[2,!1]}}))},new((i=void 0)||(i=Promise))((function(o,a){function s(e){try{r(n.next(e))}catch(e){a(e)}}function l(e){try{r(n.throw(e))}catch(e){a(e)}}function r(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,l)}r((n=n.apply(e,t||[])).next())}));var e,t,i,n},enterBarcodeManually:function(){this.displayAddDeviceManually()},_getDeviceScanningImage:function(){return this.selectedManufacturer===$f.mobile.sensors.util.INTEGRATION_TYPE.SENET?"laird_device_barcode.svg":"device_barcode.svg"},_getBarcodeViewClass:function(){return this.selectedManufacturer===$f.mobile.sensors.util.INTEGRATION_TYPE.SENET?u:m},displayAddDeviceManually:function(){var e=this._getBarcodeViewClass();return $f.mobile.nav.show(e,{model:this.model,stepNumberKey:this.nextStepNumberKey,selectedManufacturer:this.selectedManufacturer})}})},"./src/backbone/features/SetupDeviceWizard/DeviceNameStepView/view.js":function(e,t,i){i.d(t,{H:function(){return s}});var n=i("./src/backbone/features/SetupDeviceWizard/WizardStepPage/view.js"),o=i("./src/backbone/features/SetupDeviceWizard/DeviceBarcodeStepView/view.js"),a=i("./src/backbone-unorganized/shared/sensors/models.js"),s=n.g.extend({template:"#tpl_device_name_step",nextStepViewClass:o.m,stepTitleKey:"mobile_sensors_name_this_gateway",selectedManufacturer:null,placement:a.BI,placement_nicknames:[],events:$.extend({"keyup .watched_input":"titleChanged","change select":"setTitleFromSelect"},n.g.prototype.events),templateHelpers:function(){var e=s.__super__.templateHelpers.apply(this,arguments);return $.extend(e,{nicknames:this.isSensorModel()?this.placement.get("sensor_placement_nicknames"):null})},initialize:function(e){e=e||{},$.extend(this,e),s.__super__.initialize.apply(this,arguments),this.stepTitleKey="mobile_sensors_name_this_".concat(this.isSensorModel()?"sensor":"gateway"),this.isSensorModel()&&this.loadSensorPlacementData()},loadSensorPlacementData:function(){return e=this,t=void 0,n=function(){return function(e,t){var i,n,o,a,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(a){return function(l){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,n=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((o=(o=s.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){s.label=a[1];break}if(6===a[0]&&s.label<o[1]){s.label=o[1],o=a;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(a);break}o[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],n=0}finally{i=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}}(this,(function(e){switch(e.label){case 0:return[4,this.fetchPlacement()];case 1:return e.sent(),this.render(),this.placement.get("sensor_placement_nicknames").length>=1&&this.setTitleToSingleNickname(this.placement.get("sensor_placement_nicknames")[0].name),[2]}}))},new((i=void 0)||(i=Promise))((function(o,a){function s(e){try{r(n.next(e))}catch(e){a(e)}}function l(e){try{r(n.throw(e))}catch(e){a(e)}}function r(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,l)}r((n=n.apply(e,t||[])).next())}));var e,t,i,n},fetchPlacement:function(){var e=this;return this.placement=new a.BI({id:this.model.get("placement").get("id")}),new Promise((function(t,i){e.placement.fetch({success:t,error:i})}))},onRender:function(){this.updateNextButtonState(this._nextButtonIsEnabled())},titleChanged:function(e){var t=$(e.target);this.model.set("name",t.val()),this.updateNextButtonState(this._nextButtonIsEnabled())},setTitleFromSelect:function(e){var t=$(e.target);this.model.set("name",t.val()),this.updateNextButtonState(this._nextButtonIsEnabled())},setTitleToSingleNickname:function(e){this.model.set("name",e),this.updateNextButtonState(this._nextButtonIsEnabled())},_nextButtonIsEnabled:function(){var e,t;return(null===(t=null===(e=this.model.get("name"))||void 0===e?void 0:e.trim())||void 0===t?void 0:t.length)>0},displayNextStep:function(){$f.mobile.nav.show(o.m,{model:this.model,stepNumberKey:this.nextStepNumberKey,selectedManufacturer:this.selectedManufacturer})}})},"./src/backbone/features/SetupDeviceWizard/GatewayTypeStepView/GatewayMessageStepView/view.js":function(e,t,i){i.d(t,{x:function(){return s}});var n=i("./src/backbone/features/SetupDeviceWizard/WizardStepPage/view.js"),o=i("./src/backbone/features/SetupDeviceWizard/DeviceNameStepView/view.js"),a=function(){return a=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var o in t=arguments[i])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},a.apply(this,arguments)},s=n.g.extend({template:"#tpl_gateway_message_step",stepNumberKey:"mobile_sensors_wizard_step_two",stepTitleKey:"mobile_sensors_gateway_plugged_in",nextStepViewClass:o.H,selectedManufacturer:null,templateHelpers:function(){return a(a({},s.__super__.templateHelpers.apply(this,arguments)),{image_filename:"gateway_plug.svg"})},displayNextStep:function(){$f.mobile.nav.show(o.H,{model:this.model,stepNumberKey:this.nextStepNumberKey,selectedManufacturer:this.selectedManufacturer})}})},"./src/backbone/features/SetupDeviceWizard/GatewayTypeStepView/view.js":function(e,t,i){i.d(t,{q:function(){return l}});var n=i("./src/backbone/features/SetupDeviceWizard/WizardStepPage/view.js"),o=i("./src/backbone/features/SetupDeviceWizard/DeviceNameStepView/view.js"),a=i("./src/backbone/features/SetupDeviceWizard/GatewayTypeStepView/GatewayMessageStepView/view.js"),s=function(){return s=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var o in t=arguments[i])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},s.apply(this,arguments)},l=n.g.extend({template:"#tpl_gateway_type_step",stepNumberKey:"mobile_sensors_wizard_step_one",stepTitleKey:"mobile_sensors_select_gateway_type",nextStepViewClass:a.x,templateHelpers:function(){return s(s({},l.__super__.templateHelpers.apply(this,arguments)),{image_filename:"gateway_plug.svg"})},events:{"click .next_step":"displayNextStep"},displayNextStep:function(){var e=this.$el.find("input[name=gateway_type]:checked").val();return this.isSensorModel()?$f.mobile.nav.show(this.nextStepViewClass,{model:this.model,stepNumberKey:this.nextStepNumberKey,selectedManufacturer:e}):e===$f.mobile.sensors.util.MANUFACTURER.MONNIT?$f.mobile.nav.show(a.x,{model:this.model,stepNumberKey:this.nextStepNumberKey,selectedManufacturer:$f.mobile.sensors.util.MANUFACTURER.MONNIT}):$f.mobile.nav.show(o.H,{model:this.model,stepNumberKey:this.nextStepNumberKey,selectedManufacturer:$f.mobile.sensors.util.INTEGRATION_TYPE.SENET})}})},"./src/backbone/features/SetupDeviceWizard/PlacementStepView/view.js":function(e,t,i){i.d(t,{u:function(){return m}});var n=i("./src/backbone/features/SetupDeviceWizard/WizardStepPage/view.js"),o=i("./src/backbone-unorganized/shared/sensors/models.js"),a=Backbone.Marionette.ItemView.extend({template:"#tpl_placement_options",placements:new o.lt,model:null,onSelect:function(){},templateHelpers:function(){var e;return{placements:this.placements,selected_id:null===(e=this.model)||void 0===e?void 0:e.get("id")}},events:{"change input[type=radio]":"handleOnSelect"},initialize:function(e){e=e||{},$.extend(this,e),this.loadInitialData()},loadInitialData:function(){return e=this,t=void 0,n=function(){return function(e,t){var i,n,o,a,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(a){return function(l){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,n=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((o=(o=s.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){s.label=a[1];break}if(6===a[0]&&s.label<o[1]){s.label=o[1],o=a;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(a);break}o[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],n=0}finally{i=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}}(this,(function(e){switch(e.label){case 0:return[4,this.fetchPlacements()];case 1:return e.sent(),this.render(),[2]}}))},new((i=void 0)||(i=Promise))((function(o,a){function s(e){try{r(n.next(e))}catch(e){a(e)}}function l(e){try{r(n.throw(e))}catch(e){a(e)}}function r(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,l)}r((n=n.apply(e,t||[])).next())}));var e,t,i,n},fetchPlacements:function(){var e=this;return this.placements=new o.lt,new Promise((function(t,i){e.placements.fetch({success:t,error:i})}))},handleOnSelect:function(e){var t=$(e.target);this.model||(this.model=new o.BI),this.model.set({id:parseInt(t.attr("id")),name:t.attr("value")}),this.onSelect(this.model)}}),s=i("./src/backbone/features/SetupDeviceWizard/DeviceNameStepView/view.js"),l=i("./src/backbone/shared/views/typeaheads.js"),r=l.g5.extend({template:"#tpl_sensor_equipment_typeahead_item",className:"equipment_typeahead_item",formatTitle:function(e){var t=[];return e.get("equipment")&&t.push(e.get("equipment").get("model_name")),e.get("location_zone")&&t.push(e.get("location_zone")),t.join(" - ")},formatSubtitle:function(e){return e.get("identifier")?e.get("identifier"):""},templateHelpers:function(){return{title:this.formatTitle(this.model),show_checkmark:this.show_checkmark,is_checked:this.model.is_checked,subtitle:this.formatSubtitle(this.model)}}}),_=l.kG.extend({template:"#tpl_sensor_equipment_typeahead_modal",itemView:r,toolbarnav_center_title:!1,toolbarnav_title:function(){return _t("mobile_sensors_add_sensor")}}),c=l.y3.extend({model:null,modal_class:_,className:"equipment_typeahead",i18n_key_placeholder:"mobile_sensors_select_equipment",get_default_value:function(){var e=[];return this.model&&(this.model.get("equipment")&&e.push(this.model.get("equipment").get("model_name")),this.model.get("location_zone")&&e.push(this.model.get("location_zone")),this.model.get("identifier")&&e.push(this.model.get("identifier"))),e.join(" - ")}}),u=i("./src/backbone/features/mobileForm/ingredientEquipmentTemperatureFields/models.js"),d=n.g.extend({template:"#tpl_equipment_step",stepNumberKey:"mobile_sensors_wizard_step_one",stepTitleKey:"mobile_sensors_equipment",regions:{r_equipment_typeahead:".r_equipment_typeahead"},events:{"click .skip_step":"skipStep","click .next_step":"displayNextStep"},onRender:function(){this.displayEquipmentTypeahead(),this.updateNextButtonState(this._isEnabled())},_isEnabled:function(){return!!this.model.get("equipment_location")},skipStep:function(){this.showNextStep()},displayEquipmentTypeahead:function(){var e=this,t=$f.mobile.dashboard.get_active_account_or_group();this.r_equipment_typeahead.show(new c({model:e.model.get("equipment_location"),collection:new u.Re([],{locationId:t.get("id"),excludeEquipmentWithSensorLinked:!0}),post_on_select:function(t){e.model.set("equipment_location",t),e.render()},on_clear:function(){e.model.set("equipment_location",null),e.render()}}))},displayNextStep:function(){this._isEnabled()&&this.showNextStep()},showNextStep:function(){$f.mobile.nav.show(s.H,{model:this.model,stepNumberKey:this.nextStepNumberKey,selectedManufacturer:this.selectedManufacturer})}}),m=n.g.extend({template:"#tpl_placement_step",stepNumberKey:"mobile_sensors_wizard_step_one",stepTitleKey:"mobile_sensor_placement_description",nextStepViewClass:s.H,onRender:function(){this.displayPlacementOptions(),this.updateNextButtonState(this.isNextButtonEnabled())},regions:{r_placement_options:".r_placement_options"},displayPlacementOptions:function(){var e=this;this.r_placement_options.show(new a({model:this.model.get("placement"),onSelect:function(t){e.model.set("placement",t),e.updateNextButtonState(e.isNextButtonEnabled())}}))},isNextButtonEnabled:function(){return!!this.model.get("placement")},displayNextStep:function(){this.isNextButtonEnabled()&&($f.active_company.has_feature("sensor_equipment_readings")?$f.mobile.nav.show(d,{model:this.model,stepNumberKey:this.nextStepNumberKey,selectedManufacturer:this.selectedManufacturer}):$f.mobile.nav.show(s.H,{model:this.model,stepNumberKey:this.nextStepNumberKey,selectedManufacturer:this.selectedManufacturer}))}})},"./src/backbone/features/SetupDeviceWizard/WizardStepPage/view.js":function(e,t,i){i.d(t,{g:function(){return s}});var n=i("./src/backbone/shared/views/baseLayoutViews.js"),o=i("./src/backbone-unorganized/shared/sensors/models.js"),a=i("./src/backbone-unorganized/sensors/models.js"),s=n.IO.extend({toolbarnav_center_title:!1,toolbarnav_show_add_task:!1,use_transitions:!0,toolbarnav_title:function(){return this.isSensorModel()?_t("mobile_sensors_add_sensor"):_t("mobile_sensors_add_gateway")},className:"device_wizard",model:null,stepNumberKey:null,nextStepNumberKey:null,nextStepViewClass:null,stepTitleKey:null,type:"sensor",selectedManufacturer:null,events:{"click .next_step":"displayNextStep"},templateHelpers:function(){return{step_number:this._getStepNumber(),step_title:this._getStepTitle()}},initialize:function(e){e=e||{},$.extend(this,e),this._setupModel(),this._setNextStepNumber()},updateNextButtonState:function(e){e?this.$el.find(".next_step").removeClass("grayed_out"):this.$el.find(".next_step").addClass("grayed_out")},isDisabled:function(){return!1},displayNextStep:function(){$f.mobile.nav.show(this.nextStepViewClass,{model:this.model,stepNumberKey:this.nextStepNumberKey})},isSensorModel:function(){return this.model instanceof o.LM},_getStepNumber:function(){return _t(this.stepNumberKey)},_getStepTitle:function(){return _t(this.stepTitleKey)},_setNextStepNumber:function(){switch(this.stepNumberKey){case"mobile_sensors_wizard_step_one":this.nextStepNumberKey="mobile_sensors_wizard_step_two";break;case"mobile_sensors_wizard_step_two":this.nextStepNumberKey="mobile_sensors_wizard_step_three";break;case"mobile_sensors_wizard_step_three":this.nextStepNumberKey="mobile_sensors_wizard_step_four";break;case"mobile_sensors_wizard_step_four":this.nextStepNumberKey="mobile_sensors_wizard_step_five";break;case"mobile_sensors_wizard_step_five":this.nextStepNumberKey="mobile_sensors_wizard_step_six";break;default:this.nextStepNumberKey="mobile_sensors_wizard_step_one"}},_setupModel:function(){var e=$f.mobile.dashboard.get_active_account_or_group();this.model||("sensor"===this.type?this.model=new o.LM({account:{id:e.id,name:e.get("name")}}):this.model=new a.Mw)}})},"./src/backbone/features/mobileForm/BaseField/models.js":function(e,t,i){i.d(t,{q_:function(){return a},cK:function(){return r},e6:function(){return c}});var n=i("./src/backbone-unorganized/shared/forms.js"),o=i("./src/backbone/features/mobileForm/constants.js"),a=n.ne.extend({is_currently_hidden:!1,unsupported_field_type:!1,is_valid:null,initialize:function(e,t){t=t||{},$.extend(this,t),a.__super__.initialize.call(this,e,t);var i=this;$.each(this.get("events"),(function(e,t){i.listenTo(i,t.event+":value",(function(){i.set_acceptance_value(),i.perform_event(t)}))})),this.listenTo(this,"change",(function(e){var t=e.get("value");t instanceof Array&&0==t.length&&e.set("value","",{silent:!0}),i.set_acceptance_value()})),this.has_dynamic_visibility()&&this.listenTo(this.collection,"dynamicform:location_attributes_fetched",this.set_visibility_based_on_criteria)},set_visibility_based_on_criteria:function(e){if(!1!==this.is_dynamic_visibility_allowed()){var t=this.show.bind(this),i=this.hide.bind(this),n=this.get_metadata_attribute("dynamic_visibility").visibility_choice,o={success:"show"===n?t:i,fail:"show"===n?i:t};e&&new r(this.get_metadata_attribute("dynamic_visibility").attribute_criteria_filters).evaluate(e)?o.success():o.fail()}},hide:function(){var e=$("#field_".concat(this.get("id")));e.hasClass("dependent_field")||(this.set("visible",!1,{silent:!0}),e.hide(),this.is_currently_hidden=!0,this.clear_values(),this.trigger("field:hidden_field:hide",this))},show:function(){var e=$("#field_".concat(this.get("id")));e.hasClass("dependent_field")||(this.set("visible",!0,{silent:!0}),e.show(),this.is_currently_hidden=!1,this.trigger("field:hidden_field:show",this))},prepare_for_submission:function(){},clear_values:function(){(""!==this.get("value")||null!==this.get("file")||void 0!==this.get("notes")&&null!==this.get("notes"))&&(this.set({value:"",file:null,notes:""}),this.trigger("field:value_cleared"))},perform_event:function(e){var t=$("#field_"+e.target);if(!t.length)return!1;var i=$f.mobile.get_window_collection().findWhere({id:e.target});return i?"show"===a.get_dependent_field_action_for_field_value_change(this,e)?(i.is_currently_hidden=!1,t.show(),i.set("visible",!0,{silent:!0}),void i.trigger("field:hidden_field:show",i)):(i.is_currently_hidden=!0,t.hide(),i.set("visible",!1,{silent:!0}),i.clear_values(),void i.trigger("field:hidden_field:hide",i)):void 0},_is_required:function(e,t,i){return!this.is_currently_hidden&&!i.not_compatible&&!(i.hidden&&!$("#field_"+i.id).is(":visible"))&&"section"!==i.type&&"instruction"!==i.type&&i.required},validation:{value:{required:function(e,t,i){return this._is_required(e,t,i)}}},has_value:function(){return!!($.isArray(this.get("file"))?0!=this.get("file").length:this.get("file"))||!$.isArray(this.get("value"))&&null!=this.get("value")&&""!==this.get("value")||!!($.isArray(this.get("value"))&&this.get("value").length>0)},copy_from_past_submission_field:function(e){var t=e.get_attributes_for_autofill();t&&(this.set(t,{silent:!0}),this.set_acceptance_value(!0))},get_attributes_for_autofill:function(){return{value:this.get("value")}}},{get_dependent_field_action_for_field_value_change:function(e,t){var i=e.get("value");return e.has_value()?t.acceptance_values?_.contains(t.acceptance_values,e.get("acceptance_value"))?"show":"hide":"yesno"===e.get("type")&&i===o.NA?"hide":-1==t.value||i==t.value||$.isArray(i)&&_.contains(i,t.value)||t.value instanceof Object&&!isNaN(parseFloat(i))&&(i=parseFloat(i),new n.pI(t.value.criterias).validate_value(i))?"show":"hide":"hide"}}),s=n.Dn.extend({defaults:{attribute_type:null,operator:null,value:null}}),l=n.DR.extend({model:s}),r=n.Dn.extend({defaults:{boolean_operator:null,filters:null},submodels:{filters:l},_get_all_attributes_from_type:function(e,t){return t.filter((function(t){return t.attribute_type===e}))},_evaluate_filter:function(e,t){var i=this._get_all_attributes_from_type(e.get("attribute_type"),t.get("attributes")),n={EQ:function(e){return i.some((function(t){return _.isEqual(e,t.value)}))},NOT_EQ:function(e){return!n.EQ(e)},IN:function(e){if(!Array.isArray(e))throw new Error("IN value should be an array");return e.some(n.EQ)}};return n[e.get("operator")](e.get("value"))},evaluate:function(e){var t=this,i=this.get("filters");return{AND:function(){return i.every((function(i){return t._evaluate_filter(i,e)}))},OR:function(){return i.some((function(i){return t._evaluate_filter(i,e)}))}}[this.get("boolean_operator")]()}}),c=n.rU.extend({comparator:function(e,t){var i=$f.storage.get_file_extension(e.get("url")),n=$f.storage.get_file_extension(t.get("url"));return i===n?0:"pdf"===i?1:"pdf"===n?-1:void 0}})},"./src/backbone/features/mobileForm/BaseField/views.js":function(e,t,i){i.d(t,{fH:function(){return u},cu:function(){return r}});var n=i("./src/backbone-unorganized/utils/setStatusBarColor.ts"),o=i("./src/backbone/shared/views/baseLayoutViews.js").IO.extend({template:"#tpl_image_preview_dialog",is_modal:!0,src:null,allow_delete:!0,templateHelpers:function(){return{src:this.src,allow_delete:this.allow_delete}},events:{"click .delete_image":"remove_image"},initialize:function(e){if(e=e||{},$.extend(this,e),!this.src)throw new Error("Programmer Error: no src set for ImagePreviewModal");(0,n.Q)("#212121")},onRender:function(){this.$el.addClass("image_preview_modal"),this.on_orientation_change();var e=this.$el.find("#image_preview"),t=this.$el.find(".loading_spinner"),i=this.$el.find(".preview_failed");e.css("opacity",0),t.show();var n=$f.storage.get_high_res_url_from_thumbnail(this.src,234),o=$('<img src="'.concat(n,'" />')),a=this;o.load((function(){e.attr("src",n),a.on_orientation_change(),t.hide(),e.velocity({opacity:1},300,(function(){a.enable_pinch_to_zoom(e),a.on_orientation_change()}))})),o.error((function(){t.hide(),i.velocity("fadeIn")}))},on_orientation_change:function(){o.__super__.on_orientation_change.apply(this,arguments);var e=this.$el.find("#image_preview");e.css("margin","-".concat(e.height()/2,"px auto 0 auto"))},on_click_delete:function(){throw new Error("Programmer Error: on_click_delete() not implemented in ImagePreviewModal")},remove_image:function(){var e=this;return $f.mobile.notifications.confirm(_t("mobile_message_image_confirm_remove_image"),(function(t){t&&(e.on_click_delete(),e.close())})),!1},enable_pinch_to_zoom:function(e){e instanceof jQuery&&(e=e.get(0));var t=new Hammer(e,{});t.get("pinch").set({enable:!0});var i=0,n=0,o=1,a=1,s=0,l=0,r=0,_=0,c="",u=e;t.on("doubletap pan pinch panend pinchend",(function(e){if("doubletap"==e.type){c="translate3d(0, 0, 0) scale3d(2, 2, 1) ",o=2,a=2;try{"matrix(1, 0, 0, 1, 0, 0)"!=window.getComputedStyle(u,null).getPropertyValue("-webkit-transform").toString()&&(c="translate3d(0, 0, 0) scale3d(1, 1, 1) ",o=1,a=1)}catch(e){}u.style.webkitTransform=c,c=""}1!=o&&(i=s+e.deltaX,n=l+e.deltaY,r=Math.ceil((o-1)*u.clientWidth/2),_=Math.ceil((o-1)*u.clientHeight/2),i>r&&(i=r),i<-r&&(i=-r),n>_&&(n=_),n<-_&&(n=-_)),"pinch"==e.type&&(o=Math.max(.999,Math.min(a*e.scale,4))),"pinchend"==e.type&&(a=o),"panend"==e.type&&(s=i<r?i:r,l=n<_?n:_),1!=o&&(c="translate3d("+i+"px,"+n+"px, 0) scale3d("+o+", "+o+", 1)"),c&&(u.style.webkitTransform=c)}))},close:function(){o.__super__.close.apply(this,arguments),(0,n.Q)()}}),a=i("./src/backbone/features/mobileForm/BaseField/models.js"),s=i("./src/backbone-unorganized/shared/forms.js"),l=Backbone.Marionette.ItemView.extend({template:"#tpl_title_images_image",model:null,tagName:"a",attributes:function(){return{href:"#",class:this._is_file()?"view_pdf btn full_btn btn_floating":"thumbnail",style:this._is_file()?"":"background-image: url('".concat(this.templateHelpers().thumbnail_url,"')")}},_is_file:function(){if(!this.model)return!1;if(this.model.is_image_data_uri())return!1;var e=$f.storage.get_file_extension(this.model.get("url"));return!_.contains($f.utils.ACCEPTED_INSTRUCTION_FIELD_IMAGE_EXTENSIONS,e)},events:{click:"on_click"},templateHelpers:function(){var e=$f.storage.get_thumbnail(this.model.get_full_url(),234);return $f.storage.is_data_uri(this.model.get_full_url())&&(e=this.model.get_full_url()),{thumbnail_url:e,is_file:this._is_file()}},initialize:function(e){e=e||{},$.extend(this,e),this._is_file()&&this.$el.addClass("clear")},on_click:function(e){if(e.preventDefault(),e.stopPropagation(),!$f.mobile.is.connected())return $f.mobile.notifications.show_offline_msg();if(this._is_file()){if($f.mobile.is.web()||$f.mobile.is.windows())return $f.mobile.open_uri(this.model.get_full_url()),!1;var t=this.model.get("url"),i=$f.storage.get_storage_full_url(t),n=t.substr(t.lastIndexOf("/")+1);return $f.mobile.cordova.zencam.viewDocumentRemote({path:i,original_name:n},(function(){}),(function(e){$f.mobile.notifications.show_error_msg("Unable to open "+n),$f.mobile.logging.log_error("Error opening document",JSON.stringify(e))})),!1}if($f.mobile.is.web())return $f.mobile.nav.show_modal(o,{src:this.model.get_full_url(),allow_delete:!1}),!1;var a=[],s=0,l=this.model.get_full_url(!0);if(this.model.collection.each((function(e,t){var i=e.get_full_url(!0);a.push({url:i,metadata:e.get("metadata")}),l===i&&(s=t)})),this.model.get("metadata")){var r=function(){},_=function(e){$f.mobile.logging.log_error("Error while getting zencam plugin",e)};$f.mobile.is.android()?$f.mobile.cordova.zencam.openGallery({images:a,selectedImageIndex:s,strings:$f.mobile.cordova.get_zencam_localized_strings(),request:{base_url:$f.base_url,storage_base_url:$f.storage.get_storage_base_url(),endpoint_url:"".concat(this.model.collection.url,"/search/"),start:this.model.collection.paginator.get("start"),limit:this.model.collection.paginator.get("limit"),body:JSON.stringify({search_criteria:JSON.stringify(this.model.collection.search_criterias),dashboard_filters:JSON.stringify(this.model.collection.dashboard_filters),order_by:"name",tz:$f.user.time_zone,search_by:"account",select_all:!1})}},r,_):$f.mobile.cordova.zencam.openGallery({images:a,selectedImageIndex:s,strings:$f.mobile.cordova.get_zencam_localized_strings(),request:{base_url:$f.base_url,endpoint_url:"".concat(this.model.collection.url,"/search/"),storage_base_url:$f.storage.get_storage_base_url(),body:this.model.collection.to_endcoded_URI(),start:this.model.collection.paginator.get("start"),limit:this.model.collection.paginator.get("limit")}},r,_)}else $f.mobile.cordova.zencam.getZencam((function(e){}),(function(e){$f.mobile.logging.log_error("Error while getting zencam plugin",e)}),{destinationType:$f.mobile.cordova.zencam.DestinationType.FILE_URI,encodingType:$f.mobile.cordova.zencam.EncodingType.JPEG,inputType:$f.mobile.cordova.zencam.InputType.FILE_ARRAY,inputData:a,upperBound:1e3,allowEdit:!1,allowDelete:!1,strings:$f.mobile.cordova.get_zencam_localized_strings(),selectedImageIndex:s,compressionPercent:90});return!1}}),r=Backbone.Marionette.CollectionView.extend({collection:null,itemView:l,className:"thumbnails",initialize:function(e){if(e=e||{},$.extend(this,e),!this.collection)throw new Error("Programmer Error: collection required for TitleImages")},onRender:function(){this.$el.append('<div class="clear"></div>')}}),c=Backbone.Marionette.Layout.extend({template:"#tpl_field_instructions_and_title_images",model:null,regions:{r_title_images:".title_images"},initialize:function(e){e=e||{},$.extend(this,e)},onRender:function(){this.r_title_images.show(new r({collection:new a.e6(this.model.get("title_image"))}))}}),u=Backbone.Marionette.Layout.extend({tagName:"li",className:"form-field",_is_instructions_expanded:!1,getTemplate:function(){return"#tpl_"+this.model.get("type")+"_field"},templateHelpers:function(){return{model:this.model}},triggers:{request_error_wizard_recalculation_noop:"request_error_wizard_recalculation",prevent_next_reload_on_resume_noop:"prevent_next_reload_on_resume"},regions:{},events:{"keyup textarea":"expand_textarea"},constructor:function(e,t){this.regions.r_instructions=".field_instructions",u.__super__.constructor.apply(this,arguments),this.events["click .expand_instructions_btn"]||(this.events["click .expand_instructions_btn"]="toggle_instructions_title_images_display"),this.listenTo(this.model,"field:value_cleared",(function(){this.render()}))},render:function(){var e=this;if(0==$(this.template).length&&this.$el.hide(),u.__super__.render.apply(this,arguments),this.$el.removeClass("invalid"),this.model.get("value")&&!_.contains(["image","video","email","ingredient_temperature","equipment_temperature"],this.model.get("type"))&&this.$el.find("input, textarea, .fake_input, select").addClass("has_value"),this.$el.find("textarea").length>0&&setTimeout((function(){e.expand_textarea({target:e.$el.find("textarea").get(0)})}),50),"section"!==this.model.get("type")&&(this.model.get("instructions")||this.model.get("title_image")&&this.model.get("title_image").length)&&(this.$el.find(".instructions_field_instructions, .field_title").first().prepend('<a href="#" class="expand_instructions_btn"><i class="df-info"></i><i class="df-remove-circle"></i></a>'),this.delegateEvents(),this.model.get("metadata")&&this.model.get("metadata").expand_instructions&&!this.model.has_value()&&this._show_instructions(!0)),this.model.is_dependent_field()&&this.model.collection instanceof s.zc){var t=this.model.get_dependent_field_level();this.$el.addClass("dependent_field"),this.$el.addClass("dependent_field_level_"+t),_.each(new Array(t),(function(t,i){e.$el.prepend('<div class="dependent_vertical_line_level_'+(i+1)+'" />')}))}!1===this.model.get("visible")&&this.$el.addClass("not_visible")},initialize:function(e){e=e||{},$.extend(this,e);var t=this;this.template=this.getTemplate(),this.listenTo(this,"dom:refresh",this.set_element_id),this.listenTo(this.model,"change",this.handle_change),this.validate_template(),this.listenTo(this.model,"change",(function(e){e.validate()})),Backbone.Validation.unbind(this),Backbone.Validation.bind(this),this.model.unbind("validated:invalid"),this.model.bind("validated:invalid",(function(e,i){t.on_model_invalid.apply(t,arguments)})),this.model.unbind("validated:valid"),this.model.bind("validated:valid",(function(e){t.on_model_valid.apply(t,arguments)})),this.model.is_valid=this.model.isValid(!0,!0)},validate_template:function(){0==$("#tpl_".concat(this.model.get("type"),"_field")).length&&this.model.set("not_compatible",!0)},set_element_id:function(){this.$el.prop("id",this.get_element_id())},get_element_id:function(){return this.$el.parent().closest("li.form-field").length?"field_".concat(this.model.get("id"),"_").concat(_.uniqueId()):"field_".concat(this.model.get("id"))},on_model_invalid:function(e,t){this.model.is_valid=!1,this.$el.addClass("invalid"),this.trigger("request_error_wizard_recalculation",this.model)},on_model_valid:function(e){this.model.is_valid=!0,this.$el.removeClass("invalid"),this.trigger("request_error_wizard_recalculation",this.model)},handle_change:function(e){this.on_change_action(e),(!$f.mobile.is.web()||"image"!=e.get("type")&&"video"!=e.get("type"))&&this.render()},on_change_action:function(e){},save_value:function(e){var t=$(e.target).val();this.$el.removeClass("invalid"),this.model.set({value:t})},toggle_instructions_title_images_display:function(e){return this._is_instructions_expanded?this._hide_instructions():this._show_instructions(),!1},_show_instructions:function(e){this._is_instructions_expanded=!0,this.$el.find(".field_instructions").length||this.$el.find(".".concat($(window).outerWidth()>550?"field_value":"field_title",", .instructions_field_instructions")).first().after('<div class="clear"></div><div class="field_instructions"></div>'),this.r_instructions.currentView||this.r_instructions.show(new c({model:this.model})),this.$el.find(".expand_instructions_btn").addClass("expanded"),e?this.$el.find(".field_instructions").show():this.$el.find(".field_instructions").velocity("slideDown",{duration:200})},_hide_instructions:function(){this._is_instructions_expanded=!1,this.$el.find(".expand_instructions_btn").removeClass("expanded"),this.$el.find(".field_instructions").velocity("slideUp",{duration:200})},_scroll_down_one_field:function(){var e=this.$el;if(e){var t=e.outerHeight(),i=$(".page_scrollable");if(0!==i.length){var n=i[0].getBoundingClientRect().top;if(!(this.el.getBoundingClientRect().top-n<120)){var o=i.scrollTop()+t;i.stop(),i.animate({scrollTop:o},400)}}}},expand_textarea:s.Vl.expand_textarea,_get_acceptance_criteria_class:function(){return this.model.get("acceptance_criteria")&&$f.active_company.has_feature("show_acceptance_crit")?1===this.model.get("acceptance_value")?"acceptance_value_pass":-1===this.model.get("acceptance_value")?"acceptance_value_failure":0===this.model.get("acceptance_value")?"acceptance_value_neutral":"":""}})},"./src/backbone/features/mobileForm/FormTableOfContents/models.js":function(e,t,i){i.d(t,{c:function(){return n},q:function(){return o}});var n=Backbone.Model.extend({defaults:{is_sectionless_section:!1,section:null,num_total:0,num_complete:0,num_incomplete:0,num_optional:0,num_optional_complete:0,num_optional_incomplete:0,num_required:0,num_required_complete:0,num_required_incomplete:0,nesting_level:0},plus_plus:function(e){if(void 0===this.get(e))return this.set(e,1);this.set(e,this.get(e)+1)}}),o=Backbone.Collection.extend({model:n})},"./src/backbone/features/mobileForm/MobileFormStructure/models.js":function(e,t,i){i.d(t,{f2:function(){return z},gF:function(){return R},M5:function(){return S},Jh:function(){return C},El:function(){return I}});var n=i("./src/backbone-unorganized/models.js"),o=i("./src/backbone-unorganized/shared/forms.js"),a=i("./src/backbone/features/mobileForm/BaseField/models.js"),s=a.q_.extend({_show_associate_task_prompt:!1,_show_autofill_prompt:!1,initialize:function(e,t){s.__super__.initialize.apply(this,arguments);var i=this;this.on("change:account",(function(e,t){i.is_primary_location()&&i.collection.trigger("account:change",t?t.id:null)}))},validation:{"account.name":{required:function(e,t,i){return this._is_required(e,t,i)}}}}),l=a.q_.extend({validation:{"value.$date":{required:function(e,t,i){return this._is_required(e,t,i)}}}}),r=i("./src/backbone/features/mobileForm/documentField/models.js"),c=i("./src/backbone/features/mobileForm/emailField/models.js"),u=i("./src/backbone/features/mobileForm/ingredientEquipmentTemperatureFields/models.js"),d=i("./src/backbone/features/mobileForm/models.js"),m=a.q_.extend({validation:{value:{pattern:"number",required:function(e,t,i){return this._is_required(e,t,i)}}}}),h=i("./src/backbone/features/mobileForm/FormTableOfContents/models.js"),f=a.q_.extend({get_fields_in_section:function(){var e=this,t=(this.get_metadata_attribute("section_field_ids")||[]).map((function(t){return e.collection.get(t)}));return _.filter(t,(function(e){return e?"section"!==e.get("type"):(console.warn("Field not found in the fields list."),!1)}))},count_visible_sections:function(){return this.collection.filter((function(e){return"section"===e.get("type")&&!1===e.is_currently_hidden})).length},hide:function(){$("#field_".concat(this.get("id"))).parents(".form_section").hide(),this.is_currently_hidden=!0,this.set("visible",!1,{silent:!0}),this.get_fields_in_section().forEach((function(e){return e.hide()})),0===this.count_visible_sections()&&this.collection.trigger("dynamicform:sections_hidden")},show:function(){$("#field_".concat(this.get("id"))).parents(".form_section").show(),this.is_currently_hidden=!1,this.set("visible",!0,{silent:!0}),this.get_fields_in_section().forEach((function(e){return e.show()})),this.count_visible_sections()>0&&this.collection.trigger("dynamicform:sections_visible")},get_stats:function(){var e=new h.c({section:this,nesting_level:this.get_dependent_field_level()});return this.get_fields_in_section().reduce((function(e,t){if(("ingredient_temperature"===t.get("type")||"equipment_temperature"===t.get("type"))&&t.get("value").length>0){var i=t.get_temperature_field_child_models();return e.push.apply(e,i),e}return e.push(t),e}),[]).forEach((function(t){return!(!t.is_currently_hidden&&!_.contains(["section","formula","instructions"],t.get("type")))||(e.plus_plus("num_total"),t.has_value()?e.plus_plus("num_complete"):e.plus_plus("num_incomplete"),t.get("required")?(e.plus_plus("num_required"),void(t.has_value()?e.plus_plus("num_required_complete"):e.plus_plus("num_required_incomplete"))):(e.plus_plus("num_optional"),void(t.has_value()?e.plus_plus("num_optional_complete"):e.plus_plus("num_optional_incomplete"))))})),e}}),p=i("./src/backbone/features/mobileForm/sensorTemperatureField/models.js"),g=d.v.extend({get_submission_value:function(){return this.get("value")}}),v=m.extend({start_date:null,validation:{value:{fn:function(e,t,i){return!e&&this._is_required(e,t,i)?_t("mobile_message_error_stopwatch_field_required"):!e&&this.start_date?_t("mobile_message_error_stopwatch_field_running"):void 0}}},initialize:function(){var e=this;$f.mobile.settings.get("stopwatch_start_date_"+this.id,(function(t){e.start_date=t?t.start_date:null,e.start_date&&e.trigger("stopwatch_changed")})),v.__super__.initialize.apply(this,arguments)},start_stopwatch:function(e){this.start_date||(this.start_date=new Date,this.collection&&this.collection.trigger("change",this.collection)),$f.mobile.settings.set("stopwatch_start_date_"+this.id,{start_date:this.start_date})},stop_stopwatch:function(e){this.set({value:e},{silent:!0}),this.start_date=null,$f.mobile.settings.remove("stopwatch_start_date_"+this.id)},reset_stopwatch:function(){this.set("value","")}}),b=i("./src/backbone/features/mobileForm/temperatureField/models.js"),w=a.q_.extend({yesno_history_items_by_account:null,initialize:function(e,t){w.__super__.initialize.apply(this,arguments),this.yesno_history_items_by_account=this.yesno_history_items_by_account||{}},get_history:function(e){var t=this;if(!this.collection)return e(null);var i=this.collection.findWhere({type:"account"});if(!i)return e(null);this.collection.get_previous_submissions({account_field:i,success:function(i){if(!i||!i.length)return e(null);var n=new k;i.each((function(e){var i=e.get("form_structure"),o=i.get(t.id);if(!o)return!0;n.add({id:e.id,date_submitted:i.smetadata.get("date_submitted"),value:o.get("value"),acceptance_value:o.get("acceptance_value")})})),e(n)},error:function(){e(null)}})}}),y=o.Dn.extend({defaults:{id:null,date_submitted:null,acceptance_value:null,value:null}}),k=o.DR.extend({model:y,comparator:function(e){return e.get("date_submitted").$date}}),E=function(){return E=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var o in t=arguments[i])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},E.apply(this,arguments)},x=o.Dn.extend({defaults:{id:null,next_id:null,prev_id:null}}),T=o.DR.extend({model:x,form_structure:null,initialize:function(e,t){t=t||{},$.extend(this,t)},add_single:function(e){e instanceof Backbone.Model||(e=new this.model(e)),this.models.push(e),this._byId[e.id]=e,this.length++},get_next:function(e){var t=this.get(e);return t?this.get(t.get("next_id")):null},get_prev:function(e){var t=this.get(e);return t?this.get(t.get("prev_id")):null},get_next_invalid_id:function(e){var t=this.get_next(e);return t?this.form_structure.get(t.id).is_valid?this.get_next_invalid_id(t.id):t.get("id"):null},get_prev_invalid_id:function(e){var t=this.get_prev(e);return t?this.form_structure.get(t.id).is_valid?this.get_prev_invalid_id(t.id):t.get("id"):null}}),S=o.zc.extend({save_url:"/api/v1/forms/save/",field_map:null,_submission_history_by_account:null,model:function(e,t){switch(e.type){case"section":return new f(e,t);case"number":return new m(e,t);case"stopwatch":return new v(e,t);case"email":return new c.fp(e,t);case"image":case"video":return new d.v(e,t);case"signature":return new g(e,t);case"document":return new r.d(e,t);case"datetime":return new l(e,t);case"account":return new s(e,t);case"yesno":return new w(e,t);case"temperature":return new b.J(e,t);case"ingredient_temperature":return new u.fw(e,t);case"equipment_temperature":return new u.w7(e,t);case"sensor_temperature":return new p.R5(e,t);default:return new a.q_(e,t)}},initialize:function(){var e=this;this._submission_history_by_account=this._submission_history_by_account||{},this.field_map=new T([],{form_structure:this}),this.locationFieldOrder=new d.Q,this.on("all",(function(e,t){"change"==e&&(this.is_new()&&$f.utils.formula.calculate_all(this),this.set_guid(),this.smetadata.set("date_modified",{$date:(new Date).getTime()}),$f.mobile.save_active_collection(this))})),this.on("account:change dynamicform:first_load",(function(t){e._handle_location_change(t),e._handle_location_order(t)})),this._activityFieldIdsToOrderId=_.memoize((function(t){return e.find((function(e){return Number(e.get("activity_field_data").field_id)===t})).id}))},_handle_location_order:function(e){var t=this;if(this.metadata.get("order_fields_by_location")&&(e||this._lastLocationId)){if(this._lastLocationId=e,!_.isNumber(e))return this.locationFieldOrder.clear(),this.trigger("reset"),void this.trigger("dynamicform:location_attributes_fetched",null);var i=this.metadata.get("activity_template");if(i){var n=this.get_sorted_fields().map((function(e){return e.get("id")}));this.locationFieldOrder.set({activity_template:i,location:{id:e}}),this.locationFieldOrder.once("sync",(function(){var e=t.get_sorted_fields().map((function(e){return e.get("id")}));_.isEqual(n,e)||t.trigger("reset")})),this.locationFieldOrder.fetch()}}},_handle_location_change:function(e){return t=this,i=void 0,a=function(){var t,i;return function(e,t){var i,n,o,a,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(a){return function(l){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,n=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((o=(o=s.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){s.label=a[1];break}if(6===a[0]&&s.label<o[1]){s.label=o[1],o=a;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(a);break}o[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],n=0}finally{i=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}}(this,(function(o){switch(o.label){case 0:if(!_.isNumber(e))return this._locationAttributes=null,this.trigger("dynamicform:location_attributes_fetched",null),[2];o.label=1;case 1:return o.trys.push([1,3,,4]),[4,n.Dq.get_location_attributes(e)];case 2:return t=o.sent(),this._locationAttributes=t,this.trigger("dynamicform:location_attributes_fetched",t),[3,4];case 3:if(i=o.sent(),!1===$f.mobile.is.connected())return[2,this.trigger("dynamicform:location_attributes_unavailable")];throw new Error("Location Attributes fetching error: ".concat(i));case 4:return[2]}}))},new((o=void 0)||(o=Promise))((function(e,n){function s(e){try{r(a.next(e))}catch(e){n(e)}}function l(e){try{r(a.throw(e))}catch(e){n(e)}}function r(t){var i;t.done?e(t.value):(i=t.value,i instanceof o?i:new o((function(e){e(i)}))).then(s,l)}r((a=a.apply(t,i||[])).next())}));var t,i,o,a},serialize_for_reordering:function(){var e=this;return this.get_sorted_fields().map((function(t){var i=t.is_dynamic_visibility_allowed()&&t.get_metadata_attribute("dynamic_visibility")&&e._locationAttributes,n=t.toJSON();if(!i)return E(E({},n),{is_visible:!0});var o=t.get_metadata_attribute("dynamic_visibility"),s=o.attribute_criteria_filters?new a.cK(o.attribute_criteria_filters):null,l=!s||s.evaluate(e._locationAttributes),r="hide"===o.visibility_choice,_=Boolean(l^r);return E(E({},n),{is_visible:_})}))},set_location_order:function(){if(this.metadata.get("order_fields_by_location")){var e=this.locationFieldOrder.get("field_order");e&&!_.isEmpty(e.field_order)&&this.smetadata.set("location_custom_field_order",e.field_order,{silent:!0})}},set_guid:function(){if(this.smetadata.get("date_created")&&this.smetadata.get("date_created").$date||this.smetadata.set("date_created",{$date:(new Date).getTime()}),!this.smetadata.get("guid")){var e=this.metadata.get("rdbms_id")+"-"+this.smetadata.get("date_created").$date;this.smetadata.set("guid",e)}},is_new:function(){return null==this.smetadata.get("guid")},has_been_submitted:function(){return!(!this.smetadata.get("date_submitted")||!this.smetadata.get("date_submitted").$date)||!(!this._id||!this._id.$oid)},is_started:function(){return null!=this.smetadata.get("date_modified")},is_draft:function(){return!0===this.smetadata.get("draft")},clear_smetadata_and_media_fields:function(){this.smetadata=new o.of,this.smetadata.set("date_modified",{$date:(new Date).getTime()}),delete this._id;var e=[];e=(e=(e=(e=e.concat(this.where({type:"image"}))).concat(this.where({type:"video"}))).concat(this.where({type:"signature"}))).concat(this.where({type:"document"})),$.each(e,(function(e,t){t.set({file:null,value:null,notes:""})}))},construct_activity_submission_data:function(){var e=this.reduce((function(e,t){var i=t.get("activity_field_data");if(!i)throw new Error("No activity_field_data found in legacy field.");var n=i.field_id,o=i.field_version_id;e[n]={field_version:{id:o},value:t.get_submission_value(),visible:t.get("visible")};var a=t.get("acceptance_value");null!==a&&(e[n].acceptance_value=a);var s=t.get("notes");return null!==s&&(e[n].notes=s),"temperature"===t.get("type")&&t.get("reading_method")&&(e[n].reading_method=t.get("reading_method")),e}),{});return{smetadata:this.smetadata.toJSON(),activity_template:this.metadata.get("activity_template"),answers:e}},save_to_new_submission_endpoint:function(e){e=$f.utils.setup_options_callbacks(e);var t=JSON.stringify(this.construct_activity_submission_data());$f.mobile.debugging.is_release_build()||console.log("Post data: ",t);var i=window.pako.deflate(t);$f.mobile.logging.log_event("Activity ready for submission"),$f.mobile.ajax({url:"/api/v2/submissions/",dataType:"json",type:"POST",cache:!1,timeout:6e4,data:i,contentType:"application/bson",headers:{"Content-Encoding":"gzip"},validate:!0,processData:!1,emulateHTTP:!1,emulateJSON:!1,success:function(i){$f.mobile.logging.log_event("Activity submission submitted successfully",{data:t}),e.success(i)},error:function(i){$f.mobile.logging.log_error("Error submitting activity submission",{length:t.length,data:t}),e.error(i)}})},save:function(e){if(null!==this.metadata.get("activity_template")&&this instanceof R==0)try{return this.save_to_new_submission_endpoint(e)}catch(e){$f.mobile.logging.log_error("Failed to send submission with activity template data",{e:e})}e=$f.utils.setup_options_callbacks(e);var t=JSON.stringify(this.toJSON());$f.mobile.debugging.is_release_build()||console.log("Post data: ",t),$f.mobile.logging.log_event("Form ready for submission");var i=window.pako.deflate(t);$f.mobile.ajax({url:this.save_url,dataType:"json",type:"POST",cache:!1,timeout:6e4,data:i,contentType:"application/json",headers:{"Content-Encoding":"gzip"},validate:!0,processData:!1,emulateHTTP:!1,emulateJSON:!1,success:function(i){$f.mobile.logging.log_event("Form submission submitted successfully",{data:t}),e.success(i)},error:function(i){i.already_updated||$f.mobile.logging.log_error("Error submitting form - logging data sent",{length:t.length,data:t}),e.error(i)}})},delete:function(){throw new Error("Programmer Error: MobileFormStructure does not have a delete endpoint")},get_sorted_fields:function(){var e=this.get_order();return this.models.sort((function(t,i){return e.indexOf(t.get("id"))-e.indexOf(i.get("id"))}))},get_order:function(){var e=this.metadata.get("order"),t=this.smetadata.get("location_custom_field_order"),i=this.locationFieldOrder.get("field_order"),n=this.metadata.get("order_fields_by_location");return t?t.map(this._activityFieldIdsToOrderId):n&&i&&i.field_order?i.field_order.map(this._activityFieldIdsToOrderId):e.map((function(e){var t=Number(e);return isNaN(t)?e:t}))},add_item_to_field_map:function(e){var t=this.get_order(),i=t.indexOf(e.id);this.field_map.add_single({id:e.id,next_id:"undefined"!==t[i+1]?t[i+1]:null,prev_id:void 0!==t[i-1]?t[i-1]:null})},get_total_invalid:function(e){var t=0;return this.each((function(i){if(i.unsupported_field_type)return!0;i.get("visible")?"ingredient_temperature"===i.get("type")||"equipment_temperature"===i.get("type")?(t+=i.get_num_invalid(),e&&i.trigger("validated:invalid",i)):i.is_valid?e&&i.trigger("validated:valid",i):(t++,e&&i.trigger("validated:invalid",i)):e&&i.trigger("validated:valid",i)})),t},get_first_invalid:function(){var e=null;return this.each((function(t){return!!e||!!t.is_valid||void(e=t)})),e},get_previous_submissions:function(e){(e=e||{}).success=e.success||function(){},e.error=e.error||function(){};var t=this;if(!e.account_field)return $f.mobile.logging.log_error("Programmer Error: account_field is required if account_id is specified"),e.error(null);try{var i=e.account_field.get("account").id}catch(t){return e.error()}if(this._submission_history_by_account[i])return e.success(this._submission_history_by_account[i]);if(!$f.mobile.is.connected())return e.error(null);var n=new o.Ax([],{metadata:{next_criteria_id:1,simple_logic:"and",display_result_type:"list",rdbms_id:this.metadata.get("rdbms_id")},result_type:{list:{sort:[{field_id:"smetadata.date_submitted",order:-1}],columns:[],type:"list"}}});n.add(new o.O1({field_id:e.account_field.id,operator_id:"=",value:"account~".concat(i)})),this.has_been_submitted()&&n.add(new o.O1({field_id:"smetadata.date_submitted",operator_id:"date_specific_before",value:moment(this.smetadata.get("date_submitted").$date).format("YYYY-MM-DD HH:mm:ss")})),new I([],{search_criterias:n,paginator:new o.Ds({limit:5,data_source:"mongo"}),rdbms_id:this.metadata.get("rdbms_id")}).fetch({success:function(n){t._submission_history_by_account[i]=n,e.success(n)},error:e.error})},autofill_from_previous_submission:function(e){var t=this;e.each((function(e){var i=t.findWhere({id:e.get("id")});if(!i)return!0;i.copy_from_past_submission_field(e)}))},convertToOrderableFields:function(){var e=this;return this.metadata.get("order").map((function(t){var i=e.get(t);return{id:i.id,text:i.get("title"),type:i.get("type")}}))}}),R=S.extend({save_url:"/api/v1/forms/drafts/save/",delete_url:"/api/v1/forms/drafts/delete/",delete:function(e){e=$f.utils.setup_options_callbacks(e);var t="".concat(this.delete_url).concat(this.smetadata.get("guid"),"/");$f.mobile.ajax({url:t,dataType:"json",type:"GET",contentType:"application/json",success:function(t){e.success()},error:function(t){e.error()}})}}),C=o.G$.extend({url:"/api/v1/forms/",initialize:function(e){C.__super__.initialize.apply(this,arguments);var t=this;this._convert_json_to_models(),this.on("change",(function(){t._convert_json_to_models()}))},sync:function(e,t,i){if("read"!=e)throw new Error("Programmer Error: create/update not yet implemented for Submission");return i.url="".concat(t.url,"get/").concat(t.id||"","?include_rules=true"),Backbone.sync(e,t,i)},parse:function(e){return e.fields?{form_structure:e,expanded_metadata:e.expanded_metadata}:e},_convert_json_to_models:function(){this.get("form_structure")?this.get("form_structure")instanceof Backbone.Collection?this.get("form_structure")instanceof S||this.set("form_structure",new S(this.get("form_structure").toJSON())):this.set("form_structure",new S(this.get("form_structure")),{silent:!0}):this.set("form_structure",new S,{silent:!0})}}),I=o.OA.extend({model:C}),z=I.extend({cache_enabled:!0,cache_ttl:12e4,account:null,initialize:function(e,t){if(this.search_criterias=new o.Ax([],{metadata:{next_criteria_id:1,simple_logic:"and",display_result_type:"list"},result_type:{list:{sort:[{field_id:"smetadata.date_submitted",order:-1}],columns:[],type:"list"}}}),z.__super__.initialize.apply(this,arguments),!this.account)throw new Error("Programmer error: please include a Account model with AccountSubmissions");this.cache_key="submissions_for_account_id_"+this.account.id},url:function(){return"/api/v1/accounts/account/list_submissions/"+this.account.get("id")}})},"./src/backbone/features/mobileForm/baseMediaFields/views.js":function(e,t,i){i.d(t,{v:function(){return r}});var n=i("./src/backbone/shared/models/files.js"),o=i("./src/backbone/shared/views/ModalOptionsView.js"),a=i("./src/backbone/features/mobileForm/BaseField/views.js"),s=i("./src/backbone/features/mobileForm/MobileFormStructure/models.js"),l=i("./src/backbone-unorganized/utils/files/index.js"),r=a.fH.extend({hide_caption:!1,events:{"change .notes_field":"save_notes","keyup textarea":"expand_textarea","click .take_photo":"click_take_photo_video","click .take_video":"click_take_photo_video"},templateHelpers:function(){var e=r.__super__.templateHelpers.apply(this,arguments);return $.extend(e,{hide_caption:this.hide_caption})},initialize:function(e){e=e||{},$.extend(this,e),!this.model.has_value()&&this.model.get("hidden")&&this.$el.hide(),r.__super__.initialize.call(this,e)},collect_media_camera:function(){throw new Error("Programmer Error: collect_media_camera() not implemented")},collect_media_gallery:function(){throw new Error("Programmer Error: collect_media_gallery() not implemented")},collect_media_web:function(){throw new Error("Programmer Error: collect_media_web() not implemented")},on_select:function(){},_is_force_camera:function(){return!!(this.model.collection&&this.model.collection instanceof s.M5)&&this.model.collection.metadata.get("is_force_camera")},click_take_photo_video:function(e){var t=this;return $f.mobile.is.web()&&this._is_force_camera()?(alert(_t("mobile_alert_please_install_for_native")),!1):(this.model.collection&&this.model.collection.smetadata.set("date_modified",{$date:(new Date).getTime()}),$f.mobile.is.web()?(this.collect_media_web(),!1):(this._native_decide_use_gallery((function(e){e?t.collect_media_gallery():t.collect_media_camera()})),!1))},_native_decide_use_gallery:function(e){if(this._is_force_camera())return e(!1);var t=this.$el.find(".add_media_btn").get(0).getBoundingClientRect(),i=function(t){3!==t&&e(2===t)};$f.mobile.is.windows()?$f.application.content_overlay.show(new o.Z({top:t.top+this.$el.find(".add_media_btn").outerHeight()+5,right:$f.window.viewport.width-t.right,buttons:[_t("mobile_common_camera"),_t("mobile_action_sheet_media_gallery")],callback:i})):$f.mobile.notifications.decide({position:[t.left-20,t.top+20],androidTheme:$f.mobile.cordova.actionsheet.ANDROID_THEMES.THEME_DEVICE_DEFAULT_LIGHT,buttonLabels:[_t("mobile_common_camera"),_t("mobile_action_sheet_media_gallery")],androidEnableCancelButton:!0,addCancelButtonWithLabel:_t("mobile_action_sheet_cancel")},i)},_to_file_collection:function(e){var t=this;return new n.pm(_.map(e,(function(e,i){if(!e)return null;var n=_.contains(t.model.get("value")||[],e);n||-1!==e.indexOf("://")||(e="file://"+e);var o={id:(0,l.Lk)(i),mimetype:"image"===t.model.get("type")?"image/jpg":"video/mp4"};return n?o.url_s3=e:"string"==typeof e?o.url_native=e:o.raw_file=e,o})))},on_collect_media_success:function(e){var t=this;e&&e.length&&(this.$el.removeClass("invalid"),this.model.is_valid=!0,this.trigger("request_error_wizard_recalculation",this.model),this.model.save_files({add:e},(function(){t.on_select()})))},on_collect_media_error:function(e,t){"object"!=typeof e&&(e={code:"number"==typeof e?e:null,message:"string"==typeof e?e:null}),_.contains(["camera cancelled.","selection cancelled.","no image selected","user didn't choose a file."],(e.message||"").toLowerCase())||3!==e.code&&5!==e.code&&(_.contains([20,4],e.code)||e.message&&(e.message.indexOf("has no access to")>-1||e.message.indexOf("Permission Denial")>-1)?$f.mobile.notifications.show_permission_denied_msg(_t("mobile_message_media_perimission_denied")+("library"===t?_t("mobile_message_media_perimission_denied_device"):_t("mobile_common_camera"))):$f.mobile.is.android()&&30===e.code?$f.mobile.notifications.show_error_msg(e.message):($f.mobile.notifications.show_error_msg(),$f.mobile.logging.log_error("couldnt get media from device",e)))},is_gallery_permission_granted:function(e){if(e=e||function(){},$f.mobile.is.windows())return e(!0);var t=$f.mobile.is.android()?"requestExternalStorageAuthorization":"requestCameraRollAuthorization";$f.mobile.cordova.diagnostic[t]((function(t){return e(t===$f.mobile.cordova.diagnostic.permissionStatus.GRANTED)}),(function(t){return $f.mobile.logging.log_error("Error requesting Camera permission",t),e(!1)}))},save_notes:function(e){this.model.set({notes:$(e.target).val()},{validate:!1})}})},"./src/backbone/features/mobileForm/constants.js":function(e,t,i){i.d(t,{NA:function(){return n},Wh:function(){return o},io:function(){return a},v6:function(){return s},RS:function(){return l}});var n="na",o={PASS:1,FAIL:-1,NEUTRAL:0},a={GT_OP:">",GTE_OP:">=",LT_OP:"<",LTE_OP:"<=",BETWEEN_OP:"between",INCLUSIVE_BETWEEN_OP:"inclusive_between"},s={">":"mobile_field_temperature_greater_range",">=":"mobile_field_temperature_greater_or_equal_range","<":"mobile_field_temperature_less_range","<=":"mobile_field_temperature_less_or_equal_range",between:"mobile_field_temperature_between_range",inclusive_between:"mobile_field_temperature_inclusive_between_range"},l={MANUAL:"manual",PROBE:"probe",SENSOR:"sensor"}},"./src/backbone/features/mobileForm/documentField/models.js":function(e,t,i){i.d(t,{d:function(){return o}});var n=i("./src/backbone/features/mobileForm/models.js"),o=n.v.extend({defaults:$.extend({},n.v.prototype.defaults,{metadata:$.extend({},n.v.prototype.defaults.metadata,{file_metadata:[{id:null,original_name:null,size:null,file_id:null}]})}),initialize:function(e,t){var i=this;t=t||{},$.extend(this,t),o.__super__.initialize.apply(this,arguments),this.on("change:file",(function(){var e=i.get("file");e&&e.length?i.update_metadata({file_metadata:this._format_file_metadata(e)}):this.update_metadata({file_metadata:null})}))},get_display_name:function(e){var t=this.get("metadata");if(!t||!t.file_metadata||!t.file_metadata.length)return"";var i=this._get_file_index_of_current_doc(e);return t.file_metadata[i].original_name},get_display_size:function(e){var t=this.get("metadata");if(!t||!t.file_metadata||!t.file_metadata.length)return"";var i=this._get_file_index_of_current_doc(e);return $f.utils.format_bytes(t.file_metadata[i].size)},get_url:function(e){var t="#",i=this._get_file_index_of_current_doc(e);return this.get("value")&&!this.get("file")&&(t=$f.storage.get_storage_full_url(this.get("value")[i])),t},_get_file_index_of_current_doc:function(e){var t=this.get("metadata").file_metadata.map((function(e){return e.file_id})).indexOf(e);return-1==t&&(t=0),t},_format_file_metadata:function(e){return e.map((function(e){var t=$f.mobile.is.web()?e.get("raw_file").name:e.get("metadata").name,i=$f.mobile.is.web()?e.get("raw_file").size:e.get("metadata").size;return{id:e.get("url_s3"),original_name:t,size:i,file_id:e.get("id")}}))},get_submission_value:function(){var e=this.get_metadata_attribute("file_metadata")||[],t=this.get("value")||[];return 0===e.length?t.map((function(e){return{s3_key:e}})):this._map_values_with_metadatas(t,e)},_map_values_with_metadatas:function(e,t){return e.map((function(e,i){var n=t[i];return{s3_key:e,original_name:n.original_name,size:n.size}}))}})},"./src/backbone/features/mobileForm/documentField/views.js":function(e,t,i){i.d(t,{Tf:function(){return u}});var n=i("./src/backbone/shared/views/ModalOptionsView.js"),o=i("./src/backbone/shared/models/files.js"),a=i("./src/backbone/features/mobileForm/BaseField/views.js"),s=i("./src/backbone-unorganized/utils/files/index.js"),l=n.Z.extend({class_name:"document",top:"20%",right:0,text:"mobile_field_document_message_delete",buttons:["mobile_drafts_button_delete","mobile_action_sheet_cancel"]}),r=Backbone.Marionette.ItemView.extend({template:"#tpl_document_field_thumbnail_item",model:null,form_field:null,allow_delete:function(){return!1},is_draft:!1,events:{"click .document_field.view_pdf":"view_document"},templateHelpers:function(){return{documentName:this.form_field.get_display_name(this.model.id),url:this.form_field.get_url(this.model.id),documentSize:this.form_field.get_display_size(this.model.id),allow_multiples:this.form_field.allow_multiple||!1}},initialize:function(e){e||(e={}),$.extend(this,e)},_to_file_collection:function(e){var t=this;return new o.pm(_.map(e,(function(e,i){return e?_.contains(t.form_field.get("value")||[],e)?{url_s3:e}:void 0:null})))},view_document:function(e){e.preventDefault();var t=this;if(this.form_field.get("value")&&this.form_field.collection.smetadata.get("date_submitted"))return $f.mobile.is.web()?$f.mobile.open_uri(this.form_field.get_url(this.model.id)):this._view_document(),!1;if(!$f.mobile.is.web()){var i=_t("mobile_field_document_alret_button_view"),n=[i,_t("mobile_drafts_button_delete")],o=function(e){if(3!==e)return 1===e?t._view_document():t._delete_document()},a=this.$el.find(".view_pdf").get(0).getBoundingClientRect();return $f.mobile.is.ios()&&$f.mobile.notifications.decide_ios({buttonLabels:[i],addDestructiveButtonWithLabel:_t("mobile_drafts_button_delete"),position:[a.left-20,a.top+20]},o),void($f.mobile.is.android()&&$f.mobile.notifications.decide_android({buttonLabels:n},o))}return $f.application.content_overlay.show(new l({callback:function(e){if(1===e)return t._delete_document()}}))},_delete_document:function(){var e,t=this.form_field.get("metadata").file_metadata.map((function(e){return e.file_id})).indexOf(this.model.id);e=this.form_field.get("file")?new o.pm(this.form_field.get("file").at(t)):this._to_file_collection(this.form_field.get("value")),this.form_field.save_files({delete:e})},_view_document:function(){var e=function(){},t=function(e){$f.mobile.logging.log_error(e)};$f.mobile.is.web()||(this.form_field.get("value")?$f.mobile.cordova.zencam.viewDocumentRemote({path:$f.storage.get_storage_full_url(this.model.get("url_s3")),original_name:this.form_field.get_display_name(this.model.id)},e,t):$f.mobile.cordova.zencam.viewDocument({path:this.model.get("url_native"),original_name:this.form_field.get_display_name(this.model.id)},e,t))}}),c=Backbone.Marionette.CollectionView.extend({itemView:r,itemViewEventPrefix:"thumbnail",collection:null,form_field:null,allow_delete:function(){return!1},itemViewOptions:function(){return{collection:this.collection,allow_delete:this.allow_delete,form_field:this.form_field,is_draft:this.is_draft}},initialize:function(e){e=e||{},$.extend(this,e)}}),u=a.fH.extend({template:"#tpl_document_field",model:null,file:null,events:{"change .file_upload":"browse_files","click .upload_document":"on_upload_clicked"},regions:{r_file_preview:".file_preview"},templateHelpers:function(){return $.extend(u.__super__.templateHelpers.apply(this,arguments),{has_value:this.model.get("value")||this.model.get("file"),allow_multiples:this.model.allow_multiple||!1})},allow_delete:function(){return 0===$(".historical_submission").length},onRender:function(){var e=this,t=!(!this.model.collection||!this.model.collection.is_draft)&&this.model.collection.is_draft();$f.storage.refresh({complete:function(){e.r_file_preview&&e.r_file_preview.show(new c({form_field:e.model,collection:e.model.get_local_and_remote_files(),allow_delete:e.allow_delete,is_draft:t}))}})},on_upload_clicked:function(e){var t=this;if(e.preventDefault(),this.model.collection&&this.model.collection.smetadata.set("date_modified",{$date:(new Date).getTime()}),$f.mobile.is.web())return this.browse_files(e),!1;$f.mobile.cordova.zencam.pickDocument({error_codes:$f.mobile.cordova.error_codes,file_upload_max_size:$f.mobile.cordova.file_upload_max_size},(function(e){t.on_collect_media_success(t._to_file_collection(e))}),(function(e){var t="";t=e===$f.mobile.cordova.error_codes.file_size_too_large_error?_t("mobile_field_document_alert_file_size_error",{count:$f.mobile.cordova.file_upload_max_size/1e6}):_t("mobile_field_document_alert_error"),$f.mobile.logging.log_error("Failed to pick document",{error:e,display_error_message:t}),$f.mobile.notifications.show_error_msg(t)})),this.trigger("prevent_next_reload_on_resume")},_to_file_collection:function(e){var t=this;return new o.pm(_.map(e,(function(e,i){if(!e)return null;var n={};return _.contains(t.model.get("value")||[],e)?(n.url_s3=e,n):(-1===e.url.indexOf("://")&&(e.url="file://".concat(e.url)),n={id:(0,s.Lk)(i),mimetype:e.mimetype,url_native:e.url,metadata:{name:e.name,size:e.size}})})))},browse_files:function(e){var t=this;$f.mobile.uploads.web_filestore.pick_new_file({allowed_file_types:$f.utils.ACCEPTED_DOCUMENT_FILED_TYPES,allow_multiple:!1},(function(e){e.at(0).get("raw_file").size>$f.mobile.cordova.file_upload_max_size?alert(_t("mobile_field_document_alert_file_size_error",{count:$f.mobile.cordova.file_upload_max_size/1e6})):t.on_collect_media_success(e)}))},on_collect_media_success:function(e){0!==e.length&&(this.file=e.at(0),this.model.is_valid=!0,this.$el.removeClass("invalid"),this.model.save_files({add:e}))}})},"./src/backbone/features/mobileForm/emailField/models.js":function(e,t,i){i.d(t,{Gr:function(){return a},fp:function(){return s}});var n=i("./src/backbone/features/mobileForm/BaseField/models.js"),o=Backbone.Model.extend({defaults:{email:null,possible_emails:null},initialize:function(e,t){this.get("possible_emails")||this.set("possible_emails",[]),this._isValid=!0},validation:{email:{pattern:"email",required:!1}}}),a=Backbone.Collection.extend({model:o,is_valid:function(){var e=!0;return this.each((function(t,i){t.isValid(!0)||(e=!1)})),e}}),s=n.q_.extend({emails_collection:null,validation:{value:{fn:function(e,t,i){return!e&&this._is_required(e,t,i)?"Email field is required":this.emails_collection&&0!=this.emails_collection.length?this.emails_collection.is_valid()?void 0:"Invalid email address":void 0}}}})},"./src/backbone/features/mobileForm/imageField/views.js":function(e,t,i){i.d(t,{IL:function(){return r}});var n=i("./src/backbone/shared/models/files.js"),o=i("./src/backbone/shared/views/ImagePreviewModal.js"),a=i("./src/backbone/features/mobileForm/baseMediaFields/views.js"),s=Backbone.Marionette.ItemView.extend({template:"#tpl_image_and_video_field_thumbnail_item",model:null,collection:null,form_field:null,allow_delete:function(){return!1},is_draft:!1,events:{"click .thumbnail":"open_image_preview"},templateHelpers:function(){return{thumbnail_url:this.model.get_display_url(!0,this.is_draft)}},initialize:function(e){e||(e={}),$.extend(this,e)},open_image_preview:function(e){var t=this;if($f.mobile.is.web())return $f.mobile.nav.show_modal(o.e,{src:this.model.get_display_url(!1),allow_delete:this.allow_delete(),on_click_delete:function(){t.trigger("on_images_updated",{deleted:[t.model.id]})}}),!1;var i=this.collection.map((function(e){return e.get_display_url()}));return $f.mobile.cordova.zencam.getZencam((function(e){void 0===e&&(e={}),e.deleted=e.deleted||[],e.modified=e.modified||[];var i=_.map(e.deleted,(function(e){return e.replace($f.storage.get_storage_base_url(),"")}));t.trigger("on_images_updated",{modified:e.modified,deleted:i})}),(function(e){$f.mobile.logging.log_error("Error while getting zencam plugin",e)}),{destinationType:$f.mobile.cordova.zencam.DestinationType.FILE_URI,encodingType:$f.mobile.cordova.zencam.EncodingType.JPEG,inputType:$f.mobile.cordova.zencam.InputType.FILE_ARRAY,inputData:i,selectedImageIndex:this.collection.indexOf(this.model),upperBound:1e3,allowDelete:this.allow_delete(),strings:$f.mobile.cordova.get_zencam_localized_strings(),compressionPercent:90}),!1}}),l=Backbone.Marionette.CollectionView.extend({template:"#tpl_image_field_thumbnails",itemView:s,itemViewEventPrefix:"thumbnail",collection:null,form_field:null,allow_delete:function(){return!1},itemViewOptions:function(){return{collection:this.collection,allow_delete:this.allow_delete,form_field:this.form_field,is_draft:this.is_draft}},initialize:function(e){e=e||{},$.extend(this,e)}}),r=a.v.extend({TARGET_MEDIA_WIDTH:1200,TARGET_MEDIA_HEIGHT:1200,TARGET_MEDIA_COMPRESSION_PCT:90,regions:{r_thumbnails:".thumbnails"},initialize:function(e){r.__super__.initialize.apply(this,arguments),this.listenTo(this.model,"change:file change:value",this.render)},onRender:function(){var e=this,t=!(!this.model.collection||!this.model.collection.is_draft)&&this.model.collection.is_draft();$f.storage.refresh({complete:function(){e.r_thumbnails&&(e.r_thumbnails.show(new l({form_field:e.model,collection:e.model.get_local_and_remote_files(),allow_delete:e.allow_delete,is_draft:t})),e.listenTo(e.r_thumbnails.currentView,"thumbnail:on_images_updated",(function(t,i){var o;o=$f.mobile.is.web()?new n.pm([t.model]):e._to_file_collection(i.deleted),e.model.save_files({modify:e._to_file_collection(i.modified),delete:o})})))}})},allow_delete:function(){return 0===$(".historical_submission").length},collect_media_camera:function(){var e=this;$f.mobile.logging.log_event("User taking picture in-app"),$f.mobile.cordova.zencam.getZencam((function(t){t&&e.on_collect_media_success(e._to_file_collection([t]))}),(function(t){e.on_collect_media_error(t,"camera")}),{destinationType:$f.mobile.cordova.zencam.DestinationType.FILE_URI,encodingType:$f.mobile.cordova.zencam.EncodingType.JPEG,upperBound:1e3,strings:$f.mobile.cordova.get_zencam_localized_strings(),compressionPercent:this.TARGET_MEDIA_COMPRESSION_PCT})},collect_media_gallery:function(){var e=this;$f.mobile.logging.log_event("User selecting picture from gallery"),this.is_gallery_permission_granted((function(t){t?$f.mobile.cordova.imagePicker.getPictures((function(t){t&&t.length&&e.on_collect_media_success(e._to_file_collection(t))}),(function(t){e.on_collect_media_error(t,"library")}),{maximumImagesCount:30,width:e.TARGET_MEDIA_WIDTH,height:e.TARGET_MEDIA_HEIGHT,quality:e.TARGET_MEDIA_COMPRESSION_PCT}):$f.mobile.notifications.show_permission_denied_msg(_t("mobile_message_media_perimission_denied")+_t("mobile_message_media_perimission_denied_device"))}))},collect_media_web:function(){var e=this;$f.mobile.uploads.web_filestore.pick_new_file({allowed_file_types:"image/*",allow_multiple:!0,is_media:!0},(function(t){e.on_collect_media_success(t)}))}})},"./src/backbone/features/mobileForm/ingredientEquipmentTemperatureFields/models.js":function(e,t,i){i.d(t,{fw:function(){return f},w7:function(){return p},$R:function(){return y},aT:function(){return x},Re:function(){return S}});var n=i("./src/backbone-unorganized/shared/forms.js"),o=i("./src/backbone/features/mobileForm/BaseField/models.js"),a=i("./src/backbone/features/mobileForm/constants.js"),s=i("./src/backbone/features/mobileForm/temperatureField/models.js"),l=i("./src/backbone/features/mobileForm/sensorTemperatureField/models.js"),r=function(){return r=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var o in t=arguments[i])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},r.apply(this,arguments)},_=function(e,t){var i={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(i[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(i[n[o]]=e[n[o]])}return i},c=function(e,t,i){if(i||2===arguments.length)for(var n,o=0,a=t.length;o<a;o++)!n&&o in t||(n||(n=Array.prototype.slice.call(t,0,o)),n[o]=t[o]);return e.concat(n||Array.prototype.slice.call(t))},u=function(e,t){return Array.isArray(e)?{min_temp_value:"C"===t?$f.utils.fahrenheit_to_centigrade(e[0],$f.utils.DECIMALS_IN_TEMPERATURE_VALUE):e[0],max_temp_value:"C"===t?$f.utils.fahrenheit_to_centigrade(e[1],$f.utils.DECIMALS_IN_TEMPERATURE_VALUE):e[1],temp_unit:t}:{temp_value:"C"===t?$f.utils.fahrenheit_to_centigrade(e,$f.utils.DECIMALS_IN_TEMPERATURE_VALUE):e,temp_unit:t}},d=o.q_.extend({default:{id:null,title:"",value:null,required:!1},initialize:function(e,t){t=t||{},$.extend(this,t),d.__super__.initialize.call(this,e,t)},validation:{value:function(e){if(this.get("required")&&!0!==e)return _t("mobile_message_error_invalid_ingredient_temperature")}},is_dependent_field:function(){return!0},has_value:function(){return!0===this.get("value")}}),m=n.DR.extend({model:d,required:!1,get_num_errors:function(){return this.filter((function(e){return!e.isValid(!0)})).length},is_valid:function(){return 0===this.get_num_errors()},validate:function(){}}),h=o.q_.extend({getFieldAcceptanceValue:function(e,t){var i=t.where({retemp_original_id:e.id});return 0===i.length?e.get("acceptance_value"):i[i.length-1].get("acceptance_value")},setAcceptanceValue:function(e){var t=this;if(e){var i=e.where({retemp_attempt_number:void 0}).map((function(i){return t.getFieldAcceptanceValue(i,e)})),n=i.every((function(e){return!e}));if(n)this.set("acceptance_value",0);else{var o=i.find((function(e){return e===a.Wh.FAIL}));this.set("acceptance_value",void 0===o?a.Wh.PASS:a.Wh.FAIL)}}}}),f=h.extend({temperature_collection:null,ingredient_temperature_category_id:null,ingredient_temperature_id:null,ingredients_catalog:null,location_id:null,_empty_location_selected:!1,initialize:function(e,t){var i=this;this.ingredient_temperature_id=this.get_metadata_attribute("ingredient_temperature_data").ingredient_id,this.ingredient_temperature_category_id=this.get_metadata_attribute("ingredient_temperature_data").ingredient_category_id,this.temperature_collection=new v(null,{parent_field_id:this.get("id"),required:this.get("required"),ingredients_catalog:null,allow_na:this.get_metadata_attribute("allow_na"),random_check:this.get_metadata_attribute("ingredient_temperature_data").random_check,check_all:this.get_metadata_attribute("ingredient_temperature_data").check_all,form_collection:this.collection}),f.__super__.initialize.apply(this,arguments),this.listenTo(this.temperature_collection,"change add remove",(function(){i.setAcceptanceValue(i.temperature_collection)})),this.listenTo(this.temperature_collection,"follow_up_actions_on_change",(function(){i.validate()}))},save_value:function(){this.set("value",this.temperature_collection.toJSON())},has_value:function(){return this.has_all_values()},get_num_invalid:function(){return null!==this.temperature_collection.get("follow_up_actions")?this.temperature_collection.get_num_invalid():this.is_valid?0:1},change_ingredient_location:function(e,t,i){if(this.location_id!==t){i||this.set("value",[]),this.location_id=t;var n;n=this.ingredient_temperature_id?new y(e.by_location_and_category(t,null).get(this.ingredient_temperature_id)):e.by_location_and_category(t,this.ingredient_temperature_category_id),this._empty_location_selected=this._is_location_without_ingredients(n),this.temperature_collection.set_ingredients_catalog(n,i)}},_is_location_without_ingredients:function(e){return 0===e.length},get_submission_value:function(){var e=this.get("value");return e&&0!==e.length?this._clean_up_values(e):[]},_clean_up_follow_up_actions:function(e){return e.map((function(e){return{id:e.id,title:e.title,value:e.value||!1}}))},_clean_up_values:function(e){var t=this;return e.reduce((function(e,i){var n=i.id,o=i.name,a=i.required,s=i.retemp_attempt,l=i.value,r=i.acceptance_value,_=i.follow_up_actions,c=i.reading_method,u=_?t._clean_up_follow_up_actions(_):null;return l&&e.push({id:n,name:o,required:a,retemp_attempt:s,value:l,acceptance_value:r,follow_up_actions:u,reading_method:c}),e}),[])},has_all_values:function(){var e=this.temperature_collection.filter((function(e){return""===(e.get("value")||"")}));return this.temperature_collection.length>0&&0===e.length},validation:{value:{fn:function(e,t,i){if(!(this.get("required")&&this.location_id&&this._empty_location_selected))return this.get("required")&&0===this.get("value").length||!this.temperature_collection.is_valid()?_t("mobile_message_error_invalid_ingredient_temperature"):void 0}}},get_temperature_field_child_models:function(){var e=[],t=this.temperature_collection.models;if(t){var i=t.reduce((function(e,t){if(t.get("follow_up_actions")){var i=t.get("follow_up_actions").models;return e.push.apply(e,i),e}return e}),c([],t,!0));e.push.apply(e,i)}return e},get_attributes_for_autofill:function(){return{}}}),p=h.extend({temperature_collection:null,equipment_collection:null,sensor_collection:null,equipment_category_id:null,location_id:null,_location_has_equipment:!0,initialize:function(e,t){var i=this;this.equipment_category_id=this.get_metadata_attribute("equipment_temperature_data").equipment_category_id,this.equipment_collection=new x([],{equipment_category_id:this.equipment_category_id}),this.temperature_collection=new C(null,{parent_field_id:this.get("id"),equipment_collection:this.equipment_collection,required:this.get("required"),allow_na:this.get_metadata_attribute("allow_na"),form_collection:this.collection}),this.sensor_collection=new l.O7,p.__super__.initialize.apply(this,arguments),this.listenTo(this.temperature_collection,"change add remove",(function(){i.setAcceptanceValue(i.temperature_collection)})),this.listenTo(this.temperature_collection,"follow_up_actions_on_change",this.validate)},save_value:function(){this.set("value",this.temperature_collection.toJSON())},has_value:function(){return this.has_all_values()},get_num_invalid:function(){return null!==this.temperature_collection.get("follow_up_actions")?this.temperature_collection.get_num_invalid():this.is_valid?0:1},change_equipment_location:function(e,t,i){var n=this;i||this.set("value",[]),this.location_id=t;var o=e.by_location_and_category(t,this.equipment_category_id);this._location_has_equipment=o.length>0;var a=o.map((function(e){return e.get("current_location").id})),s=function(){n.temperature_collection.setEquipmentCollection(o),$f.mobile.notifications.hide_loading_dialog()};this.sensor_collection.get_sensors_with_equipment_locations(a,(function(){o.forEach((function(e){var t=n.sensor_collection.find((function(t){return!!t.get("equipment_location")&&t.get("equipment_location").id===e.get("current_location").id}));t&&e.set({sensor:t})})),s()}),s)},get_submission_value:function(){var e=this.get("value");return e&&0!==e.length?this._clean_up_values(e):[]},_clean_up_follow_up_actions:function(e){return e.map((function(e){return{id:e.id,title:e.title,value:e.value}}))},_clean_up_values:function(e){var t=this;return e.filter((function(e){return Boolean(e.value)})).map((function(e){var i=e.id,n=e.model_name,o=e.required,a=e.value,s=e.acceptance_value,l=e.follow_up_actions,r=e.reading_method;return{id:i,model_name:n,required:o,value:a,acceptance_value:s,follow_up_actions:l?t._clean_up_follow_up_actions(l):null,reading_method:r}}))},has_all_values:function(){var e=this.temperature_collection.filter((function(e){return""===(e.get("value")||"")}));return this.temperature_collection.length>0&&0===e.length},validation:{value:{fn:function(e,t,i){if(this.get("required")){if(this.location_id&&!this._location_has_equipment)return;if(0===this.get("value").length)return _t("mobile_message_error_invalid_ingredient_temperature")}if(!this.temperature_collection.is_valid())return _t("mobile_message_error_invalid_ingredient_temperature")}}},get_temperature_field_child_models:function(){var e=[],t=this.temperature_collection.models;if(t){var i=t.reduce((function(e,t){if(t.get("follow_up_actions")){var i=t.get("follow_up_actions").models;return e.push.apply(e,i),e}return e}),c([],t,!0));e.push.apply(e,i)}return e},get_attributes_for_autofill:function(){return{}}}),g=s.J.extend({defaults:{id:null,acceptance_criteria:{},type:"ingredient_temperature",value:null,acceptance_value:null,follow_up_actions:null,reading_method:null},submodels:{follow_up_actions:m,acceptance_criteria:n.Su},_pass_range_instructions:"",_follow_up_actions_num_errors:0,initialize:function(e,t){var i=this;t=t||{},$.extend(this,t),this._pass_range_instructions=this._get_pass_range_instructions(),g.__super__.initialize.call(this,e,t),this.on("change:acceptance_value",(function(){return i._set_follow_up_actions(i.matched_criteria)}))},validation:{value:{fn:function(e,t,i){if(isNaN(e)&&"na"!==e)return _t("mobile_message_error_invalid_ingredient_temperature")},required:function(){return this.get("required")}}},_map_pass_range_operator_with_instructions:function(e,t){var i=t.get("metadata");if(i&&i.get("acceptance_value")===a.Wh.PASS){var n=t.get("condition").get("operator_id"),o=t.get("condition").get("condition_value"),s=u(o,$f.active_company.get("temperature_unit"));e.push(_t(a.v6[n],s))}return e},_get_pass_range_instructions:function(){return this.get("acceptance_criteria").reduce(this._map_pass_range_operator_with_instructions,[]).join(_t("mobile_field_temperature_operators_separator"))},_reset_acceptance_value:function(e){this.set({acceptance_value:null,follow_up_actions:null},{silent:e})},get_follow_up_actions_num_errors:function(){return!this.get("follow_up_actions")||this.get("follow_up_actions").is_valid()?0:this.get("follow_up_actions").get_num_errors()},set_acceptance_value:function(e){e=void 0!==e&&e;var t=this.get("value");if(null!==t&&""!==t&&t!==a.NA){var i=this.get("acceptance_criteria");if(i&&(this.matched_criteria=i.get_matched_criteria(t),this.matched_criteria)){var n=this.matched_criteria.get("metadata").get("acceptance_value");this.set("acceptance_value",n,{silent:e})}}else this._reset_acceptance_value(e)},_set_follow_up_actions:function(e){var t=this;if(this.get("acceptance_value")===a.Wh.FAIL){this.set("follow_up_actions",e.get("follow_up_actions"));var i=this.get("follow_up_actions");return i&&this.listenTo(i,"change",(function(){t.trigger("follow_up_actions_on_change",t)})),void this.addRetempAttemptField()}this.collection.isEmpty()||(this.is_original_field?this.removeRetempAttempts():this.removeRetempAttemptsFromCurrentId()),this.set("follow_up_actions",null)},get_next_visible_temp:function(){var e=this.get("type"),t=this.collection.indexOf(this),i=t+1;if(i<this.collection.length&&-1!==t)return this.collection.at(i);var n=this.collection.form_collection,o=n.get_order(),a=o.indexOf(this.collection.parent_field_id);if(a>=n.length||-1===a)return null;for(var s=a+1;s<o.length;s++){var l=n.get(o[s]);if(!1===l.get("hidden"))return l.temperature_collection&&l.get("type")===e?l.temperature_collection.at(0):null}return null}}),v=n.DR.extend({model:g,ingredient_temperature_category_id:"",required:!1,allow_na:!1,random_check:!1,check_all:!0,ingredients_catalog:null,all_ingredients_shown:!1,parent_field_id:null,_invalid_temperatures:0,initialize:function(e,t){t=t||{},$.extend(this,t),v.__super__.initialize.call(this,e,t)},is_valid:function(){return(!this.required||0!==this.length)&&0===this.map((function(e){return!(e.get("required")&&!e.get("value"))})).filter((function(e){return!1===e})).length},get_num_invalid:function(){return this.reduce((function(e,t){return!1===t.isValid(!0)&&e++,e+t.get_follow_up_actions_num_errors()}),0)},getAllowedRetemps:function(){return this.form_collection.findWhere({id:this.parent_field_id}).get_metadata_attribute("allowed_retemps")},add_ingredient_temperature:function(e){var t=this,i=new g(e),n=this.getAllowedRetemps();this.random_check&&(i.on("change:value",(function(e,i){i===a.NA&&t.should_get_new_random_ingredient()&&t.get_random_ingredient()})),i.on("change:acceptance_value",(function(e,i){i===a.Wh.FAIL&&t.should_show_all_ingredients()&&!n&&(t.get_all_ingredients(),t.mark_ingredients_as_required())})),this.on("change:acceptance_value",(function(){var e=t.findWhere({retemp_attempt_number:n});(null==e?void 0:e.get("acceptance_value"))===a.Wh.FAIL&&t.check_all&&(t.get_all_ingredients(),t.mark_ingredients_as_required())}))),this.add(i)},set_submitted_values:function(e){var t=this,i=e.map((function(e){return r({allow_na:t.allow_na},e)}));this.add(i)},set_saved_values:function(e){var t=this;e.forEach((function(e){return t.add_ingredient_temperature(r({allow_na:t.allow_na},e))}))},_location_has_random_disabled:function(e){return!!e&&e.get("current_location").location.random_ingredient_temperature_disabled},set_ingredients_catalog:function(e,t){this.ingredients_catalog=e,t||(this.reset(),this.all_ingredients_shown=!1,!this.random_check||this._location_has_random_disabled(e.first())?this.get_all_ingredients():this.get_random_ingredient())},get_all_ingredients:function(){var e=this;if(null!==this.ingredients_catalog){var t=this.ingredients_catalog.map((function(t){return{id:t.id,name:t.get("name"),required:e.required,value:"",allow_na:e.allow_na,acceptance_criteria:t.get("current_location").acceptance_criteria,acceptance_value:null}}));this.add(t)}},mark_ingredients_as_required:function(){this.each((function(e){e.set("required",!0)}))},search_unexisting_random_ingredient:function(){if(this.ingredients_catalog&&0!==this.ingredients_catalog.length){var e=Math.floor(Math.random()*this.ingredients_catalog.length),t=this.ingredients_catalog.at(e);if(this.get(t.id)){if(this.length===this.ingredients_catalog.length)return;return this.search_unexisting_random_ingredient()}return t}},get_random_ingredient:function(){var e=this.search_unexisting_random_ingredient();e&&this.add_ingredient_temperature({id:e.id,name:e.get("name"),required:this.required,value:"",allow_na:this.allow_na,acceptance_criteria:e.get("current_location").acceptance_criteria})},should_get_new_random_ingredient:function(){return 0===this.filter((function(e){return e.get("value")!==a.NA})).length},should_show_all_ingredients:function(){return!(!this.check_all||this.all_ingredients_shown||(this.all_ingredients_shown=!0,0))},search_saved_value:function(e,t){var i=e.filter((function(e){return e.id===t}));return i.length?i[0]:null}}),b=n.o7.extend({defaults:{id:null,name:""},_parse_follow_up_actions:function(e){return e.map((function(e){return{id:e.id,required:e.is_required,title:e.title}}))},_ingredient_ac_to_form_ac:function(e){var t=this;return e.map((function(e){var i=e.condition,n=e.value,o=e.acceptance_value,s=e.follow_up_actions;return{condition:{condition_value:n,operator_id:a.io[i]},metadata:{acceptance_value:o},follow_up_actions:t._parse_follow_up_actions(s)}}))},_parse_ingredient_locations:function(e){var t=this,i=e.ingredient_location,n=_(e,["ingredient_location"]);if(!i||0===i.length)return r({},n);var o=i.map((function(e){var i=e.ingredient_temperature_profiles,n=_(e,["ingredient_temperature_profiles"]);if(0===i.length)return n;var o=i[0].conditions,a=t._ingredient_ac_to_form_ac(o);return r({acceptance_criteria:a},n)}));return r({locations:o},n)},parse:function(e){var t=e.data||e;return this._parse_ingredient_locations(t)}}),w=n.Dn.extend({defaults:{count:0,location_id:[]},initialize:function(e,t){t=t||{},$.extend(this,t),w.__super__.initialize.apply(this,arguments)},url:function(){var e="/api/v3/activities/ingredients/?meta_only=true";return this.location_id?"".concat(e,"&location_ids=").concat(this.location_id,"&temp_profile_type=").concat(2):e},parse:function(e){return e.meta}}),y=n.pn.extend({model:b,paginator:null,cache_enabled:!0,cache_key:"ingredients",cache_fetch_limit:100,location_id:null,ingredients_count:0,cache_disable_url_params:["uncached_location"],cache_merge_on_fetch:!0,initialize:function(e,t){if(t=t||{},$.extend(this,t),!this.paginator){var i=t.location_id,o=t.uncached_location;this.paginator=new n.Ds({location_id:i,uncached_location:o})}y.__super__.initialize.apply(this,arguments)},url:function(){var e="/api/v3/activities/ingredients/?";return this.location_id?"".concat(e,"&location_ids=").concat(this.location_id,"&temp_profile_type=").concat(2,"&limit=").concat(this.ingredients_count):"".concat(e,"&limit=").concat(this.ingredients_count)},_get_ingredients_count:function(e,t){var i=this;return new w(null,{location_id:this.location_id}).fetch({success:function(t){i.ingredients_count=t.get("count"),i.paginator.set("limit",i.ingredients_count),i.set("cache_fetch_limit",i.ingredients_count),e()},error:t})},sync:function(e,t,i){i=i||{},$f.mobile.localization.get_locale((function(n){return n=(n=n||$f.mobile.localization.DEFAULT_LOCALE).replace("_","-"),i.headers=r({"Accept-Language":n},i.headers),Backbone.sync(e,t,i)}))},fetch:function(e){var t=this;void 0===e&&(e={});var i=arguments,n=e.error,o=void 0===n?function(){}:n;this._get_ingredients_count((function(){return y.__super__.fetch.apply(t,i)}),o)},by_location_and_category:function(e,t){var i=this.reduce((function(i,n){if(!n.get("locations"))return i;var o=n.get("locations").find((function(t){return t.location.id===e}));if(o){if(t&&!n.get("categories").some((function(e){return e.id===t})))return i;n.set("current_location",o),i.push(n)}return i}),[]);return new y(i)}},{fetch_ingredients_for_location:function(e,t){return new Promise((function(t,i){if(null===e)return t(new y([]));new y([],{location_id:e,uncached_location:!0}).fetch({success:t,error:i})})).then((function(e){return e}),(function(){return t(),new Promise((function(t,i){$f.mobile.cache.get("ingredients",(function(i){$f.mobile.logging.log_event("Loaded ingredients from cache",{location_id:e}),t(new y(i))}),i)}))}))}}),k=n.Dn.extend({defaults:{count:0},url:function(){return"/api/v2/equipment/equipment/?meta_only=true"},parse:function(e){return e.meta}}),E=n.Dn.extend({defaults:{id:null,model_name:null,unique_id:null},idAttribute:"unique_id",url:function(){return"/api/v2/equipment/equipment/".concat(this.id,"/")},_parse_follow_up_actions:function(e){return e.map((function(e){return{id:e.id,required:e.is_required,title:e.title}}))},_equipment_ac_to_form_ac:function(e){var t=this;return e.map((function(e){var i=e.condition,n=e.value,o=e.acceptance_value,s=e.follow_up_actions;return{condition:{condition_value:n,operator_id:a.io[i]},metadata:{acceptance_value:o},follow_up_actions:t._parse_follow_up_actions(s)}}))},_parse_equipment_locations:function(e){var t=this,i=e.equipment_location,n=_(e,["equipment_location"]);if(!i||0===i.length)return r({},n);var o=i.map((function(e){var i=e.equipment_temperature_profiles,n=_(e,["equipment_temperature_profiles"]);if(0===i.length)return n;var o=i[0].conditions,a=t._equipment_ac_to_form_ac(o);return r({acceptance_criteria:a},n)}));return r({locations:o},n)},parse:function(e){var t=e.data||e;return this._parse_equipment_locations(t)}}),x=n.DR.extend({model:E,location_id:null,equipment_count:0,cache_fetch_limit:100,paginator:null,typeahead_search_attrs:["model_name"],cache_enabled:!0,cache_key:"equipment",cache_disable_url_params:["uncached_location"],cache_merge_on_fetch:!0,initialize:function(e,t){if(t=t||{},$.extend(this,t),!this.paginator){var i=t.location_id,o=t.uncached_location;this.paginator=new n.Ds({location_id:i,uncached_location:o})}x.__super__.initialize.apply(this,arguments)},url:function(){var e="/api/v2/equipment/equipment/";return this.location_id?"".concat(e,"?location_id=").concat(this.location_id,"&limit=").concat(this.equipment_count):"".concat(e,"?limit=").concat(this.equipment_count)},_get_equipment_count:function(e,t){var i=this;return(new k).fetch({success:function(t){i.equipment_count=t.get("count"),i.paginator.set("limit",i.equipment_count),i.set("cache_fetch_limit",i.ingredients_count),e()},error:t})},fetch:function(e){var t=this;void 0===e&&(e={});var i=arguments,n=e.error,o=void 0===n?function(){}:n;this._get_equipment_count((function(){return x.__super__.fetch.apply(t,i)}),o)},by_location_and_category:function(e,t){var i=this.reduce((function(i,n){var o=n.get("locations");if(!o)return i;var a=o.filter((function(t){return t.location.id===e}));return a.forEach((function(e,o){var s=[n.get("model_name"),e.identifier,e.location_zone].filter((function(e){return Boolean(e)})).join(" - ");if(!t||n.get("categories").some((function(e){return e.id===t}))){var l=r(r({},n.toJSON()),{current_location:e,unique_id:a.length>1?"".concat(n.get("id"),"-").concat(o):n.get("id"),model_name:s});i.push(l)}})),i}),[]);return new x(i)}},{fetch_equipment_for_location:function(e,t){return new Promise((function(t,i){if(null===e)return t(new x([]));new x([],{location_id:e,uncached_location:!0}).fetch({success:t,error:i})})).then((function(e){return e}),(function(){return t(),new Promise((function(t,i){return $f.mobile.logging.log_event("Loaded equipment from cache",{location_id:e}),$f.mobile.cache.get("equipment",(function(e){t(new x(e))}),i)}))}))}}),T=n.Dn.extend({defaults:{id:null,location_zone:null,identifier:null,equipment:null},idAttribute:"id",submodels:{equipment:E}}),S=n.DR.extend({paginator:null,model:T,locationId:null,excludeEquipmentWithSensorLinked:!1,typeahead_search_attrs:["searchText"],initialize:function(e,t){t=t||{},$.extend(this,t),this.paginator||(this.paginator=new n.Ds)},url:function(){var e="/api/v2/equipment/location/";return this.locationId&&(e="".concat(e,"?location_id=").concat(this.locationId)),this.paginator.get("search_query")&&(e="".concat(e,"&search=").concat(this.paginator.get("search_query"))),this.excludeEquipmentWithSensorLinked&&(e="".concat(e,"&exclude_equipment_with_sensor_linked=").concat(this.excludeEquipmentWithSensorLinked)),e}}),R=s.J.extend({defaults:{id:null,acceptance_criteria:{},type:"equipment_temperature",value:null,acceptance_value:null,follow_up_actions:null,sensor:null,reading_method:null},submodels:{follow_up_actions:m,acceptance_criteria:n.Su,sensor:l.Em},_pass_range_instructions:"",_follow_up_actions_num_errors:0,initialize:function(e,t){var i=this;t=t||{},$.extend(this,t),this._pass_range_instructions=this._get_pass_range_instructions(),R.__super__.initialize.call(this,e,t),this.on("change:acceptance_value",(function(){return i._set_follow_up_actions(i.matched_criteria)}))},validation:{value:{fn:function(e,t,i){if(isNaN(e)&&"na"!==e)return _t("mobile_message_error_invalid_equipment_temperature")},required:function(){return this.get("required")}}},_map_pass_range_operator_with_instructions:function(e,t){var i=t.get("metadata");if(i&&i.get("acceptance_value")===a.Wh.PASS){var n=t.get("condition").get("operator_id"),o=t.get("condition").get("condition_value"),s=u(o,$f.active_company.get("temperature_unit"));e.push(_t(a.v6[n],s))}return e},_get_pass_range_instructions:function(){return this.get("acceptance_criteria").reduce(this._map_pass_range_operator_with_instructions,[]).join(_t("mobile_field_temperature_operators_separator"))},_reset_acceptance_value:function(e){this.set({acceptance_value:null,follow_up_actions:null},{silent:e})},_set_follow_up_actions:function(e){var t=this;if(this.get("acceptance_value")===a.Wh.FAIL){this.set("follow_up_actions",e.get("follow_up_actions"));var i=this.get("follow_up_actions");return i&&this.listenTo(i,"change",(function(){t.trigger("follow_up_actions_on_change",t)})),void this.addRetempAttemptField()}this.collection.isEmpty()||(this.is_original_field?this.removeRetempAttempts():this.removeRetempAttemptsFromCurrentId()),this.set("follow_up_actions",null)},get_follow_up_actions_num_errors:function(){return!this.get("follow_up_actions")||this.get("follow_up_actions").is_valid()?0:this.get("follow_up_actions").get_num_errors()},set_acceptance_value:function(e){e=void 0!==e&&e;var t=this.get("value");if(null!==t&&""!==t&&t!==a.NA){var i=this.get("acceptance_criteria");if(i&&(this.matched_criteria=i.get_matched_criteria(t),this.matched_criteria)){var n=this.matched_criteria.get("metadata").get("acceptance_value");this.set("acceptance_value",n,{silent:e})}}else this._reset_acceptance_value(e)},get_next_visible_temp:function(){var e=this.get("type"),t=this.collection.indexOf(this),i=t+1;if(i<this.collection.length&&-1!==t)return this.collection.at(i);var n=this.collection.form_collection,o=n.get_order(),a=o.indexOf(this.collection.parent_field_id);if(a>=n.length||-1===a)return null;for(var s=a+1;s<o.length;s++){var l=n.get(o[s]);if(!1===l.get("hidden"))return l.temperature_collection&&l.get("type")===e?l.temperature_collection.at(0):null}return null}}),C=n.DR.extend({model:R,equipment_category_id:"",equipment_collection:null,required:!1,allow_na:!1,parent_field_id:null,_invalid_temperatures:0,initialize:function(e,t){t=t||{},$.extend(this,t),C.__super__.initialize.call(this,e,t)},is_valid:function(){return(!this.required||0!==this.length)&&0===this.map((function(e){return!(e.get("required")&&!e.get("value"))})).filter((function(e){return!1===e})).length},get_num_invalid:function(){return this.reduce((function(e,t){return!1===t.isValid(!0)&&e++,e+t.get_follow_up_actions_num_errors()}),0)},set_submitted_values:function(e){var t=this,i=e.map((function(e){return r({allow_na:t.allow_na},e)}));this.add(i)},set_saved_values:function(e){this.set_submitted_values(e)},setEquipmentCollection:function(e){var t=this;this.equipment_collection=e;var i=this.equipment_collection.map((function(e){var i=t.findWhere({model_name:e.get("model_name")});return{id:e.get("unique_id"),model_name:e.get("model_name"),value:i?i.get("value"):"",required:t.required,allow_na:t.allow_na,acceptance_criteria:e.get("current_location").acceptance_criteria,sensor:e.get("sensor"),acceptance_value:null}}));this.reset(),this.add(i)}})},"./src/backbone/features/mobileForm/models.js":function(e,t,i){i.d(t,{v:function(){return a},Q:function(){return s}});var n=i("./src/backbone/shared/models/MobileMediaField.js"),o=i("./src/backbone-unorganized/shared/forms.js"),a=n.u.extend({get_parent_upload_guid:function(){return this.collection.set_guid(),this.collection.smetadata.get("guid")},create_field_upload_filename:function(e){return $f.storage.create_form_submission_media_filename("signature"===this.get("type")?"zp-signature.png":e.name,this.collection.metadata.get("rdbms_id"),this.collection.metadata.get("company").id)}}),s=o.Dn.extend({url:function(){var e=this.get("activity_template"),t=this.get("location");return"/api/v3/activities/templates/".concat(e.id,"/location_field_order/").concat(t.id)},parse:function(e){return e.data},defaults:{id:null,activity:null,location:null,modified_user:null,field_order:null,date_modified:null,date_created:null}})},"./src/backbone/features/mobileForm/sensorTemperatureField/models.js":function(e,t,i){i.d(t,{Em:function(){return l},O7:function(){return r},R5:function(){return _}});var n=i("./src/backbone-unorganized/shared/forms.js"),o=i("./src/backbone/features/mobileForm/BaseField/models.js"),a=i("./src/backbone/features/mobileForm/constants.js"),s=function(){return s=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var o in t=arguments[i])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},s.apply(this,arguments)},l=n.Dn.extend({defaults:{id:null,name:null,placement:null,timestamp:null,value:null,is_submitted_value:!1,reading_method:a.RS.SENSOR},is_dependent_field:function(){return!1}}),r=n.DR.extend({model:l,initialize:function(e,t){t=t||{},$.extend(this,t)},set_submitted_values:function(e){var t=e.map((function(e){return s({is_online:!!e.value,last_reading_date:e.timestamp,last_reading_value:e.value,is_submitted_value:!0},e)}));this.add(t)},get_sensors_in_location:function(e){if(this.reset(),e){if(this.limit_placements){var t=this.selected_placements.join(",");this.url="/api/v2/sensors/sensors/?account_id=".concat(e,"&placement_id=").concat(t)}else this.url="/api/v2/sensors/sensors/?account_id=".concat(e);return this.fetch()}},get_sensors_with_equipment_locations:function(e,t,i){return e&&0!=e.length||t(),this.url="/api/v2/sensors/sensors/?equipment_location_id=".concat(e.join(",")),this.fetch({success:t,error:i,reset:!0})}}),_=o.q_.extend({sensor_collection:null,location_id:null,selected_placements:[],limit_placements:!1,initialize:function(e,t){var i=this.get_metadata_attribute("sensor_temperature_data");i&&(this.limit_placements=this.get_metadata_attribute("sensor_temperature_data").limit_placements,this.selected_placements=this.get_metadata_attribute("sensor_temperature_data").selected_placements),this.sensor_collection=new r(null,{limit_placements:this.limit_placements,selected_placements:this.selected_placements,form_collection:this.collection}),_.__super__.initialize.apply(this,arguments)},_set_location:function(e){return t=this,i=void 0,o=function(){return function(e,t){var i,n,o,a,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(a){return function(l){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,n=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((o=(o=s.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){s.label=a[1];break}if(6===a[0]&&s.label<o[1]){s.label=o[1],o=a;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(a);break}o[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],n=0}finally{i=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}}(this,(function(t){this.location_id=e;try{this.sensor_collection.get_sensors_in_location(e)}catch(e){$f.mobile.notifications.show_error_msg(_t("mobile_message_show_error_message"))}return[2]}))},new((n=void 0)||(n=Promise))((function(e,a){function s(e){try{r(o.next(e))}catch(e){a(e)}}function l(e){try{r(o.throw(e))}catch(e){a(e)}}function r(t){var i;t.done?e(t.value):(i=t.value,i instanceof n?i:new n((function(e){e(i)}))).then(s,l)}r((o=o.apply(t,i||[])).next())}));var t,i,n,o},set_initial_location:function(e){this._set_location(e),this.isValid(!0)},change_location:function(e){this.location_id!==e&&(this.set("value",[]),this._set_location(e))}})},"./src/backbone/features/mobileForm/temperatureField/models.js":function(e,t,i){i.d(t,{J:function(){return s}});var n=i("./src/backbone/features/mobileForm/BaseField/models.js"),o=function(){return o=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var o in t=arguments[i])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},o.apply(this,arguments)},a=function(e,t,i){if(i||2===arguments.length)for(var n,o=0,a=t.length;o<a;o++)!n&&o in t||(n||(n=Array.prototype.slice.call(t,0,o)),n[o]=t[o]);return e.concat(n||Array.prototype.slice.call(t))},s=n.q_.extend({validation:{value:{pattern:"number",required:function(e,t,i){return this._is_required(e,t,i)}}},get_attributes_for_autofill:function(){return{}},getMaxId:function(e){var t=e.pluck("id"),i=this.collection.pluck("id"),n=_.uniq(a(a([],t,!0),i,!0)).sort();return _.max(n)+1},getLastIndex:function(){var e=this.get("retemp_original_id");if(!e)return this.collection.indexOf(this);var t=this.collection.where({retemp_original_id:e}),i=t[t.length-1];return this.collection.indexOf(i)},getAttributesCopy:function(){return JSON.parse(JSON.stringify(this.attributes))},addRetempAttemptField:function(){var e=this.get("type"),t=this.collection.get(this.get("retemp_original_id")||this.get("id")),i="equipment_temperature"===e?this.collection.equipment_collection:this.collection.ingredients_catalog,n=this.getMaxId(i);if(this.collection.form_collection){var a=this.collection.parent_field_id,s=this.collection.form_collection.findWhere({id:a}).get_metadata_attribute("allowed_retemps");if(void 0!==s){var l=this.get("retemp_attempt_number")?this.get("retemp_attempt_number")+1:1;if(!(l>s)){void 0===this.get("retemp_original_id")&&(this.is_original_field=!0);var r=o(o({},this.getAttributesCopy()),{acceptance_value:null,follow_up_actions:null,id:n+1,retemp_attempt_number:l,value:null,retemp_original_id:t.get("id"),required:!0}),_="equipment_temperature"===e?"model_name":"name";r[_]="".concat(t.get(_)," Retemp #").concat(l),this.collection.add(r,{at:this.getLastIndex()+1})}}}},removeRetempAttempts:function(){var e=this,t=this.collection.filter((function(t){return t.get("retemp_original_id")===e.id}));this.collection.remove(t)},removeRetempAttemptsFromCurrentId:function(){var e=this,t=this.getLastIndex(),i=this.collection.at(t),n=this.collection.filter((function(t){return t.id>e.id&&t.id<=i.id&&t.get("retemp_original_id")===e.get("retemp_original_id")}));this.collection.remove(n)}})},"./src/backbone/features/mobileForm/views.jsx":function(e,t,i){i.r(t),i.d(t,{AllSubmissionsHistoryList:function(){return Ne},AllSubmissionsHistoryListItem:function(){return Ce},BaseSubmissionsHistoryList:function(){return ze},FormSection:function(){return $e},FormSubmissionsHistoryList:function(){return Ae},FormSubmissionsHistoryListItem:function(){return Ie},HistoryListItem:function(){return Re},MobileForm:function(){return Se},MobileFormFields:function(){return Ee},MobileFormPage:function(){return ke},SubmissionsTaskAlertRule:function(){return xe},SubmissionsTasksAlertsRulesCard:function(){return Te},SubmittedFormPage:function(){return Me}});var n=i("./src/backbone-unorganized/models.js"),o=i("./src/backbone-unorganized/shared/forms.js"),a=i("./src/backbone-unorganized/tasks/models.js"),s=i("./src/backbone-unorganized/utils/bluetooth.js"),l=i("./src/backbone-unorganized/views.js"),r=i("./src/react/features/FormReordering/index.ts"),c=i("./src/backbone/shared/models/CommentsPageLayoutMixin.js"),u=i("./src/backbone/shared/views/baseLayoutViews.js"),d=i("./src/backbone/shared/views/EmptyListMessage.js"),m=i("./src/backbone/shared/views/MobileSearchBar.js"),h=u.IO.extend({use_transitions:!0,renderFunction:function(){},initialize:function(e){void 0===e&&(e={}),$.extend(this,e),this.toolbarnav_class=null},render:function(){window.mountReactLegacy(this.el,this.renderFunction)}}),f=i("./src/backbone/shared/views/tabs.js"),p=i("./src/backbone/shared/views/SelectAccountModal.js"),g=i("./src/backbone/features/mobileForm/BaseField/views.js"),v=i("./src/backbone/features/mobileForm/ingredientEquipmentTemperatureFields/models.js"),b=i("./src/backbone/features/mobileForm/MobileFormStructure/models.js"),w=Backbone.Marionette.Layout.extend({template:"#tpl_autofill_previous_submission_explainer",initialize:function(e){e||(e={}),$.extend(this,e)}}),y=Backbone.Marionette.Layout.extend({template:"#tpl_associate_task_explainer",initialize:function(e){e||(e={}),$.extend(this,e)}}),k=g.fH.extend({_most_recent_submission:null,_is_shown:!1,_eligible_task:null,regions:{r_account_field_extra_explainer:".r_account_field_extra_explainer"},triggers:{mobile_form_render_noop:"mobile_form:render"},events:{"click .clear":"clear_account","click .fake_input:not(.clear)":"open_select_account_dialog","click .autofill_form":"autofill_form","click .deny_autofill":"deny_autofill","click .associate_task":"associate_task","click .deny_associate_task":"deny_associate_task"},initialize:function(e){var t=this;k.__super__.initialize.apply(this,arguments);var i=this.model.collection.findWhere({type:"ingredient_temperature"})||this.model.collection.findWhere({type:"equipment_temperature"});i&&!this.form_collection.has_been_submitted()&&(this.model.get("value")&&this._fetch_temperature_data({silent:!0}),this.listenTo(this.model,"change:value",(function(){t._fetch_temperature_data({silent:!1})})))},_fetch_temperature_data:function(e){var t=this,i=e.silent,n=function(){setTimeout((function(){$f.mobile.is.connected()?$f.mobile.notifications.show_error_msg():$f.mobile.notifications.show_offline_msg()}))},o=v.aT.fetch_equipment_for_location(this.model.get("value"),n).then((function(e){t.model.trigger("change:equipmentCollection",e,i)})),a=v.$R.fetch_ingredients_for_location(this.model.get("value"),n).then((function(e){t.model.trigger("change:ingredientCollection",e,i)}));$f.mobile.notifications.show_loading_dialog(),Promise.allSettled([o,a]).then($f.mobile.notifications.hide_loading_dialog,$f.mobile.notifications.hide_loading_dialog)},templateHelpers:function(){var e=k.__super__.templateHelpers.call(this),t={address_more_info:null},i=this.model.get("account");if(i&&i.address&&i.city){var n="".concat(i.address,", ").concat(i.city);n+=i.state?", "+i.state:"",n+=i.phone?", "+i.phone:"",t.address_more_info=n}return $.extend(e,t),e},onRender:function(){this._is_shown&&this._check_for_task_association_eligability()},onShow:function(){this._is_shown=!0,this._check_for_task_association_eligability()},open_select_account_dialog:function(e){var t=this;if($(e.target).hasClass("fake_input"))return $f.mobile.notifications.show_loading_dialog(),$f.mobile.nav.show_modal(p.H,{form_collection:this.form_collection,form_field_model:this.model,post_on_select:function(e){t.model._show_autofill_prompt=!0,t.model._show_associate_task_prompt=!0,t.model.set({value:e.id,account:e.toJSON()})}}),!1},clear_account:function(e){if($(e.target).hasClass("clear"))return this.model.set("value",null),this.model.set("account",null),this.render(),!1},_check_for_previous_submissions:function(){var e=this,t=$f.mobile.get_window_collection();t&&$f.mobile.is.connected()&&this.model._show_autofill_prompt&&(t.has_been_submitted()||t.metadata.get("is_copy_enabled")&&this.model.get("account")&&(delete this.model._show_autofill_prompt,this.model.collection.get_previous_submissions({account_field:this.model,success:function(t){if(t&&t.length&&(e._most_recent_submission=t.at(0).get("form_structure"),e._most_recent_submission=new b.M5(e._most_recent_submission.toJSON()),e.r_account_field_extra_explainer)){var i=e._most_recent_submission.smetadata,n=moment(new Date(i.get("date_submitted").$date)).tz(i.get("time_zone")).format("dddd, MMM D [at] h:mma");e._show_explainer(),e.r_account_field_extra_explainer.show(new w({templateHelpers:function(){return{account_name:e.model.get("account")?e.model.get("account").name:"",last_submission_author:e._most_recent_submission.smetadata.get("created_by").display_name,last_submission_time:n}}}))}},error:function(){}})))},_check_for_task_association_eligability:function(){var e=this;if(this._close_explainer(),$f.mobile.is.connected()&&this.model._show_associate_task_prompt){delete this.model._show_associate_task_prompt;var t=this.model.get("account");if(t){var i=new a.jR(null,{cache_enabled:!1,url:"/api/v1/forms/get_template_tasks/".concat(this.model.collection.metadata.get("rdbms_id"),"?account_id=").concat(t.id)});i.fetch({success:function(){return i.length?(e._eligible_task=i.at(0),e._eligible_task.get("assignee").id===$f.active_user.id?(e._associate_task(e._eligible_task),e._check_for_previous_submissions()):(e._show_explainer(),void e.r_account_field_extra_explainer.show(new y({templateHelpers:function(){return{explainer_text:_t("mobile_forms_task_on_behalf",{user:e._eligible_task.get("assignee").get_display_name()})}}})))):e._check_for_previous_submissions()},error:function(){e._check_for_previous_submissions()}})}}},autofill_form:function(e){var t=this;if(this._most_recent_submission){delete this.model._show_autofill_prompt,$f.mobile.notifications.show_loading_dialog();var i=$f.mobile.get_window_collection();return setTimeout((function(){i.autofill_from_previous_submission(t._most_recent_submission),i.trigger("change"),t.trigger("mobile_form:render"),$f.mobile.notifications.hide_loading_dialog()}),100),!1}},_close_explainer:function(){this.$el.find(".r_account_field_extra_explainer").hide(),this.r_account_field_extra_explainer&&this.r_account_field_extra_explainer.close()},_show_explainer:function(){this.$el.find(".r_account_field_extra_explainer").show()},deny_autofill:function(e){return this._close_explainer(),delete this.model._show_autofill_prompt,!1},associate_task:function(e){return delete this.model._show_associate_task_prompt,this._associate_task(this._eligible_task),this._check_for_previous_submissions(),!1},_associate_task:function(e){this._close_explainer(),this._eligible_task&&($f.mobile.get_window_collection().smetadata.set("task",{id:e.id,title:e.get("title"),account_id:this.model.get("account").id}),$f.mobile.logging.log_event("Associated form with task via location field prompt",{task_id:e.id,account_id:this.model.get("account").id}))},deny_associate_task:function(e){return delete this.model._show_associate_task_prompt,this._close_explainer(),this._check_for_previous_submissions(),!1}}),E=i("./src/backbone-unorganized/utils/barcodes.js"),x=g.fH.extend({events:{"change .barcode_value":"change_barcode_value","click .field_action_btn":"click_barcode"},change_barcode_value:function(e){var t=$(e.target).attr("field_id"),i=$("#field_"+t+" .barcode_value").val();this._update_barcode_value(t,i)},click_barcode:function(e){return t=this,i=void 0,o=function(){var t,i,n;return function(e,t){var i,n,o,a,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(a){return function(l){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,n=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((o=(o=s.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){s.label=a[1];break}if(6===a[0]&&s.label<o[1]){s.label=o[1],o=a;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(a);break}o[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],n=0}finally{i=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}}(this,(function(o){switch(o.label){case 0:return $f.mobile.is.web()?(alert(_t("mobile_alert_please_install_for_native")),[2,!1]):(t=$(e.target),i=t.attr("field_id"),[4,(0,E.Y)()]);case 1:return(n=o.sent())?(this._update_barcode_value(i,n),[2,!1]):[2,!1]}}))},new((n=void 0)||(n=Promise))((function(e,a){function s(e){try{r(o.next(e))}catch(e){a(e)}}function l(e){try{r(o.throw(e))}catch(e){a(e)}}function r(t){var i;t.done?e(t.value):(i=t.value,i instanceof n?i:new n((function(e){e(i)}))).then(s,l)}r((o=o.apply(t,i||[])).next())}));var t,i,n,o},_update_barcode_value:function(e,t){this.model.set({value:t}),$("#field_"+e+" .barcode_value").val(t)}}),T=g.fH.extend({events:{"change input[type=checkbox]":"save_value"},save_value:function(e){var t=this.$el.find(".checkbox_mod");this.model.set({value:t.is(":checked")});var i=this.$el.find(".fake_checkbox");return t.is(":checked")?i.addClass("checked"):i.removeClass("checked"),!1},on_change_action:function(){this._scroll_down_one_field()}}),S=g.fH.extend({picker_type:"date",events:{"click .show_datetime_picker":"show_picker"},onRender:function(){var e=this;this.picker_type=this.model.get("allow_time")?"datetime":"date",this.$el.find(".show_datetime_picker").mobiscroll()[this.picker_type]({theme:"material",display:"bottom",defaultValue:this.model.get("value")?new Date(this.model.get("value").$date):void 0,max:new Date((new Date).getFullYear()+10,11,31),min:new Date(1900,1,1),focusOnClose:!1,dateWheels:"M D d yy",onSet:function(t,i){e.save_value(i.getVal())}})},show_picker:function(e){return this.$el.find(".date input").mobiscroll("show"),!1},save_value:function(e){e.getTime()!=this.model.get("value").$date?this.model.set("value",{$date:"datetime"==this.picker_type?e.getTime():moment(e).endOf("day").toDate().getTime()},{validate:!0}):this.render()}}),R=i("./src/backbone/features/mobileForm/documentField/views.js"),C=i("./src/backbone/features/mobileForm/emailField/models.js"),I=Backbone.Marionette.ItemView.extend({template:"#tpl_email_field_item",model:null,className:"email_value_wrapper",events:{"change input":"set_email","change select":"set_email","click .open_address_book":"open_address_book","click .reset_value":"reset_value"},initialize:function(e){Backbone.Validation.unbind(this),Backbone.Validation.bind(this);var t=this;this.model.unbind("validated:invalid"),this.model.bind("validated:invalid",(function(e,i){t.$el.addClass("invalid")})),this.model.unbind("validated:valid"),this.model.bind("validated:valid",(function(e,i){t.$el.removeClass("invalid")}))},onRender:function(){this.model.get("email")&&this.$el.find("input, select").addClass("has_value"),this.model.isValid(!0)||this.$el.addClass("invalid")},onBeforeClose:function(){Backbone.Validation.unbind(this)},set_email:function(e){var t=$(e.target).val();return this.model.set("email",t),this.render(),this.model.validate&&this.model.validate(),!1},reset_value:function(){return this.model.set({email:null,possible_emails:[]}),1==this.model.collection.length?(this.render(),!1):(this.model.collection.remove(this.model),this.close(),!1)},open_address_book:function(){if($f.mobile.is.web())return alert(_t("mobile_alert_please_install_for_native")),!1;this.trigger("prevent_next_reload_on_resume");var e=this;return $f.mobile.cordova.contacts.pickContact((function(t){if(t.emails&&0!=t.emails.length){var i=[];$.each(t.emails,(function(e,t){if(t.value.indexOf("@")<0)return!0;i.push(t.value)})),0!=i.length&&(e.model.set({email:i.length>1?-1:i[0],possible_emails:i.length>1?i:[]}),e.render(),e.model.validate())}else $f.mobile.notifications.show_error_msg(_t("mobile_message_field_email_error_open_address_book"))}),(function(e){"object"!=typeof e&&(e={code:"number"==typeof e?e:null,message:"string"==typeof e?e:null}),"EXPECTED_FAILURE"!=e.type&&6!=e.code&&(20!=e.code?($f.mobile.logging.log_error("Failed to get contact"),$f.mobile.notifications.show_error_msg()):$f.mobile.notifications.show_permission_denied_msg(_t("mobile_message_field_email_permission_denied_open_address_book")))})),!1}}),z=Backbone.Marionette.CollectionView.extend({itemView:I,collection:null}),A=g.fH.extend({model:null,regions:{r_emails_list:".emails_list"},events:{"change input":"save_value","change select":"save_value","click .add_email":"add_email","keydown input":"on_email_field_keydown"},initialize:function(e){A.__super__.initialize.apply(this,arguments);var t=this;this.model.emails_collection=new C.Gr;var i=this.model.get("value")?this.model.get("value").split(","):[];$.each(i,(function(e,i){t.model.emails_collection.add({email:i})})),this.listenTo(this.model.emails_collection,"change add remove",this.save_value)},onBeforeRender:function(){this.model.emails_collection.remove(this.model.emails_collection.where({email:null})),this.model.emails_collection.remove(this.model.emails_collection.where({email:""})),0==this.model.emails_collection.length&&this.model.emails_collection.add({})},onRender:function(){this.r_emails_list.show(new z({collection:this.model.emails_collection}))},on_model_invalid:function(e,t){this.model.is_valid=!1,this.trigger("request_error_wizard_recalculation",this.model),this.model.emails_collection.is_valid()?this.$el.addClass("invalid"):this.$el.find(".field_title").addClass("invalid")},on_model_valid:function(e){this.$el.removeClass("invalid"),this.model.is_valid=!0,this.$el.find(".field_title").removeClass("invalid"),this.trigger("request_error_wizard_recalculation",this.model)},save_value:function(){var e=[];this.model.emails_collection.each((function(t,i){if(!t.get("email"))return!0;e.push(t.get("email"))})),this.model.get("value")!=e.join(",")&&this.model.set("value",e.join(","))},add_email:function(e,t){return 0==this.$el.find('input[value=""]').not($("input:focus")).length&&this.model.emails_collection.add({}),t||this.$el.find(".email_value").last().focus(),!1},on_email_field_keydown:function(e){return 188!=e.keyCode&&13!=e.keyCode||(this.add_email(),!1)},handle_change:function(){}}),N=i("./src/backbone/features/mobileForm/FormTableOfContents/models.js"),M=u.R1.extend({collection:null,title:"Table of Contents",current_section_id:null,on_click_section:function(){},initialize:function(){if(M.__super__.initialize.apply(this,arguments),!this.collection)throw new Error("Programmer Error: FormTableOfContents requires a collection")},onRender:function(){var e=this,t=this.collection.filter((function(e){return"section"===e.get("type")&&!e.is_currently_hidden})),i=_.sortBy(t,(function(t){return e.collection.metadata.get("order").indexOf(t.id.toString())})),n=new N.q(_.map(i,(function(e){return e.get_stats()})));this.r_bottom_sheet_body.show(new D({collection:n,current_section_id:this.current_section_id,on_click_section:this.on_click_section}))}}),O=Backbone.Marionette.ItemView.extend({template:"#tpl_form_table_of_contents_list_item",model:null,tagName:"li",is_active_section:!1,on_click_section:function(){},events:{"click .navlink":"click_section"},templateHelpers:function(){return{is_active_section:this.is_active_section}},initialize:function(e){e=e||{},$.extend(this,e)},onRender:function(){this.$el.css("padding-left",16*this.model.get("nesting_level"))},click_section:function(e){return this.on_click_section(this.model.get("section")),!1}}),D=Backbone.Marionette.CollectionView.extend({itemView:O,tagName:"ul",className:"pagelist section_stats_list",collection:null,current_section_id:null,on_click_section:function(){},initialize:function(e){e=e||{},$.extend(this,e)},getItemView:function(e){var t=e.get("section")?e.get("section").id:null;return this.itemView.extend({is_active_section:!!this.current_section_id&&this.current_section_id===t,on_click_section:this.on_click_section})}}),j=g.fH.extend({initialize:function(e){this.model.get("hidden")&&(this.$el.hide(),this.$el.addClass("hidden_formula")),j.__super__.initialize.call(this,e);var t=this;_.each(t.model.get("options"),(function(e){var i=t.form_collection.get(e.id);return!!i&&(i.on("change",(function(){$f.utils.formula.calculate(t.model,t.form_collection)})),!0)}))},events:{"change input":"save_value"}}),q=i("./src/backbone/features/mobileForm/imageField/views.js"),B=i("./src/backbone/features/mobileForm/constants.js"),L=g.fH.extend({events:{"keypress input":"strip_non_digits","change input, blur input":"save_value"},strip_non_digits:function(e){return 0==e.keyCode||e.keyCode>=48&&e.keyCode<=57||45==e.keyCode&&-1==e.target.value.indexOf("-")||!(e.target.value.indexOf(".")>-1)&&(46==e.keyCode||8==e.keyCode)},save_value:function(e){e.target.value=e.target.value.replace(/,/g,""),this.fix_event_val_leading_decimal(e),L.__super__.save_value.call(this,e)},fix_event_val_leading_decimal:function(e){var t=$(e.target).val();0==t.indexOf(".")?$(e.target).val("0"+t):1==t.indexOf(".")&&0==t.indexOf("-")&&$(e.target).val("".concat(t.substr(0,1),"0").concat(t.substr(1)))}}),P=L.extend({template:"#tpl_temperature_field",is_polling_field:!1,last_polled_temp:null,events:_.extend({"click .fake_input":"click_probe_input","click .connected .bluetherm_indicator":"poll_start","click .disconnected .bluetherm_indicator":"retry_connect","click .polling .bluetherm_indicator":"click_set_value"},L.prototype.events),templateHelpers:function(){var e="disconnected",t="mobile_placeholder_therm_no_bluetooth",i=$f.mobile.bluetooth.device&&"testo"===$f.mobile.bluetooth.device.get("type");return $f.mobile.bluetooth.supports_bluetooth()&&($f.mobile.bluetooth.is_connecting?(e="connecting",t="mobile_placeholder_blue_therm_connecting"):this.is_polling_field?(e="polling",t=i?"mobile_placeholder_testo_tap":"mobile_placeholder_blue_therm_please_wait"):$f.mobile.bluetooth.is_connected?(e="connected",t=i?"mobile_placeholder_testo_tap":"mobile_placeholder_blue_therm_tap"):t="mobile_placeholder_blue_therm_not_connected"),$.extend({acceptance_value_class:this._get_acceptance_criteria_class(),temperature_value:this.get_company_temperature_value(),connection_state:e,placeholder_text:_t(t)||t,is_force_probe_input:this._should_force_temperature_probe()},P.__super__.templateHelpers.apply(this,arguments))},initialize:function(e){P.__super__.initialize.apply(this,arguments);var t=this;this.listenTo($f.application.vent,"btdevice:connected",(function(){t.render()})),this.listenTo($f.application.vent,"btdevice:disconnected btdevice:connecting",(function(){t.is_polling_field=!1,t.render()})),this.listenTo($f.application.vent,"btdevice:new_reading",(function(e){t.is_polling_field&&-9999!=e&&(t.last_polled_temp=e,isNaN(parseFloat(e))||(e=$f.utils.get_rounded_temperature_in_configured_units(e)),t.$el.find(".fake_input").html(e))})),this.listenTo($f.application.vent,"btdevice:button_pressed",(function(e){t.is_polling_field&&-9999!=e&&t._set_value(e,B.RS.PROBE)})),this.listenTo(this.model,"change:value",this.render),this.listenTo($f.application.vent,"btdevice:clear_polling",(function(e){t.is_polling_field&&t.cid!==e.cid&&t.poll_stop()}))},click_set_value:function(e){return this._set_value(this.last_polled_temp,B.RS.PROBE),!1},click_probe_input:function(e){var t=this;return $f.mobile.bluetooth.is_device_connected((function(i){i?t.poll_start(e):t.retry_connect(e)})),!1},_should_force_temperature_probe:function(){return!$f.mobile.is.windows()&&!$f.mobile.is.web()&&this.model.collection.metadata.get("is_force_probe_input")},on_change_action:function(e){if(null!==e.changed.value){var t=e.get_next_visible();if(t&&"temperature"==t.get("type")&&-1!=["",null].indexOf(t.get("value"))){var i=$("#field_"+t.get("id"));if(i){var n=i.find(".fake_input");n&&(n.focus().click(),setTimeout(this._scroll_down_one_field.bind(this),100))}}}},_set_value:function(e,t){e&&(this._scroll_down_one_field(),this.model.set({value:e,reading_method:t}),this.poll_stop())},save_value:function(e){e.target.value=e.target.value.replace(/,/g,""),this.fix_event_val_leading_decimal(e);var t=$(e.target).val();this.$el.removeClass("invalid");var i=isNaN(parseFloat(t))?t:$f.utils.get_rounded_temperature_in_fahrenheit_units(t);this.model.set({value:i,reading_method:B.RS.MANUAL}),t!=this.model.get("value")&&this.render()},poll_start:function(e){var t=this;return!this.is_polling_field&&($f.mobile.bluetooth.supports_bluetooth()?($f.mobile.bluetooth.is_device_connected((function(e){e?($f.application.vent.trigger("btdevice:clear_polling",t),t.is_polling_field=!0,t.render(),$f.mobile.bluetooth.start_polling({error:function(e){e===s.my.ERROR_PAIR_REQUEST_DENIED&&$f.mobile.bluetooth.disconnect(),t.is_polling_field=!1,t.render()}}),$(window).on("click.bluetherm_stop_polling_"+t.model.get("id"),(function(e){var i=$(e.target);return!!(i.hasClass("bluetherm_indicator")||i.parents(".bluetherm_indicator").length>0)||(t.poll_stop(),!1)}))):t.poll_stop()})),!1):this._error_bluetooth_not_supported())},poll_stop:function(e){return $(window).off("click.bluetherm_stop_polling_"+this.model.get("id")),!!this.is_polling_field&&(this.is_polling_field=!1,$f.mobile.bluetooth.stop_polling(),this.render(),!1)},retry_connect:function(e){return $f.mobile.bluetooth.supports_bluetooth()?($f.mobile.is.android()&&this.trigger("prevent_next_reload_on_resume"),$f.mobile.bluetooth.connect(),!1):(this._error_bluetooth_not_supported(),!1)},_error_bluetooth_not_supported:function(){$f.mobile.is.web()?$f.mobile.notifications.show_error_msg(_t("mobile_alert_please_install_for_native")):$f.mobile.notifications.show_error_msg(_t("mobile_windows_10_bluetherm_not_supported"))},onClose:function(){$(window).off("click.bluetherm_stop_polling_"+this.model.get("id"))},get_company_temperature_value:function(){var e=this.model.get("value");return isNaN(parseFloat(e))?e:$f.utils.get_rounded_temperature_in_configured_units(e)}}),F=i("../../../node_modules/@mui/icons-material/Link.js"),V=i("./src/backbone-unorganized/shared/sensors/util.js"),U=i("../../../node_modules/react/index.js"),H=function(){return H=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var o in t=arguments[i])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},H.apply(this,arguments)},W=T.extend({template:"#tpl_ingredient_equipment_follow_up_actions_list_item",className:"form-field dependent_field",getTemplate:function(){return this.template},onRender:function(){var e,t;null===(t=null===(e=W.__super__)||void 0===e?void 0:e.onRender)||void 0===t||t.apply(this,arguments),"boolean"!=typeof this.model.get("value")||this.model.is_valid||this.$el.addClass("invalid")}}),G=Backbone.Marionette.CollectionView.extend({itemView:W,collection:null,tagName:"ul",handle_change:function(){}}),K=P.extend({tagName:"li",template:"#tpl_ingredient_equipment_temperature_item_field",className:function(){return this.model.get("retemp_attempt")?"retemp-field":""},regions:{r_ingredient_equipment_follow_up_actions:".ingredient_equipment_follow_up_actions"},events:_.extend({"click .ingredient_equipment_temperature_na":"save_na_value"},P.prototype.events),templateHelpers:function(){var e=this.getSensorFields();return this.model.set_acceptance_value(),$.extend(K.__super__.templateHelpers.apply(this,arguments),H({retemp_attempt:this.model.get("retemp_attempt")||null,item_name:"ingredient_temperature"===this.model.get("type")?this.model.get("name"):this.model.get("model_name"),show_na_btn:this.model.get("allow_na"),pass_range_instructions:this.model._pass_range_instructions},e))},getTemplate:function(){return this.template},on_change_action:function(e){if(!this.model.get("follow_up_actions")&&null!==e.changed.value&&void 0!==e.changed.value){var t=e.get_next_visible_temp();if(t&&-1!==["",null].indexOf(t.get("value"))){var i=t.get("id"),n=t.collection.parent_field_id;if(!$f.utils.is_nil(n)){var o=$("#field_".concat(n," #field_").concat(i));if(o){var a=o.find(".fake_input");a&&(a.focus().click(),setTimeout(this._scroll_down_one_field.bind(this),100))}}}}},save_na_value:function(e){var t=$(e.target).attr("value");return this.model.get("value","")===t||this.model.set({value:t}),!1},onRender:function(){if(this.model.get("value")===B.NA&&this.$el.find(".ingredient_equipment_temperature_na").addClass("selected"),$f.active_company.has_feature("sensor_equipment_readings")&&this.model.get("sensor")){var e=this.$(".sensor_link")[0];window.mountReactLegacy(e,(function(){return U.createElement(F.Z,null)}))}var t=this.model.get("follow_up_actions");(null==t?void 0:t.length)>0&&this.r_ingredient_equipment_follow_up_actions.show(new G({collection:t}))},validate_template:function(){},_should_force_temperature_probe:function(){return!$f.mobile.is.windows()&&!$f.mobile.is.web()&&this.model.collection.form_collection.metadata.get("is_force_probe_input")},getSensorFields:function(){var e=this.model.get("sensor");if(!$f.active_company.has_feature("sensor_equipment_readings")||!e)return{has_sensor:!1};var t=e.get("placement"),i=V.Z.isValidSensorTemperatureReading(e.get("is_online"),e.get("last_reading_date"),e.get("last_reading_value"));return i&&this._set_value(e.get("last_reading_value")),{has_sensor:!0,sensor_name:e.get("name"),battery:e.get("battery"),timestamp:e.get("last_reading_date")?V.Z.get_formatted_sensor_timestamp({time_zone:$f.active_user.get("time_zone"),timestamp:e.get("last_reading_date"),format:$f.utils.DATE_AND_TIME_FMT}):null,placement:t?t.name:null,is_valid_sensor_temperature_reading:i,is_online:!!i&&e.get("is_online")}},click_probe_input:function(e){var t,i,n=this.getSensorFields();return n.has_sensor&&n.is_valid_sensor_temperature_reading||null===(i=null===(t=K.__super__)||void 0===t?void 0:t.click_probe_input)||void 0===i||i.apply(this,arguments),!1},retry_connect:function(e){var t,i,n=this.getSensorFields();return n.has_sensor&&n.is_valid_sensor_temperature_reading||null===(i=null===(t=K.__super__)||void 0===t?void 0:t.retry_connect)||void 0===i||i.apply(this,arguments),!1}}),J=Backbone.Marionette.CollectionView.extend({itemView:K,tagName:"ul",collection:null}),Y=g.fH.extend({template:"#tpl_ingredient_equipment_temperature_field",tagName:"li",model:null,regions:{r_ingredient_equipment_temperatures_list:".ingredient_equipment_temperatures_list"},events:{"click .df-arrow-down":"toggle_ingredient_equipment_temperatures","click .df-arrow-up":"toggle_ingredient_equipment_temperatures"},templateHelpers:function(){return $.extend(Y.__super__.templateHelpers.apply(this,arguments),{is_collapsed:this.is_collapsed})},on_model_invalid:function(e,t){this.model.is_valid=!1,this.trigger("request_error_wizard_recalculation",this.model),this.$el.find(".field_title").addClass("invalid")},on_model_valid:function(e){this.$el.removeClass("invalid"),this.model.is_valid=!0,this.$el.find(".field_title").removeClass("invalid"),this.trigger("request_error_wizard_recalculation",this.model)},getTemplate:function(){return this.template},initialize:function(e){var t=this,i=this,n=this.model.collection.findWhere({type:"account"});n&&(e=e||{},$.extend(this,e),this.form_collection.has_been_submitted()&&(this.model.temperature_collection.set_submitted_values(this.model.get("value")||[]),$f.mobile.notifications.hide_loading_dialog()),(this.form_collection.is_draft()||this.model.get("value").length>0)&&this.model.temperature_collection.set_saved_values(this.model.get("value")||[]),Y.__super__.initialize.apply(this,arguments),this.model instanceof v.fw&&this.listenTo(n,"change:ingredientCollection",(function(e,i){return t.model.change_ingredient_location(e,n.get("value"),i)})),this.model instanceof v.w7&&this.listenTo(n,"change:equipmentCollection",(function(e,i){return t.model.change_equipment_location(e,n.get("value"),i)})),this.listenTo(this.model.temperature_collection,"change add remove",(function(){i.save_value(),i.render()})))},onRender:function(){this.r_ingredient_equipment_temperatures_list.show(new J({collection:this.model.temperature_collection}))},save_value:function(){this.model.save_value()},toggle_ingredient_equipment_temperatures:function(){this.is_collapsed=!this.is_collapsed,this.render()},handle_change:function(){}}),Z=g.fH.extend({}),Q=g.fH.extend({onRender:function(){var e=this,t=this.model.get("options")[0]-1,i=this.model.get("value")?this.model.get("value"):t,n=function(i,n){null!=i&&""!==i&&(i=parseInt(i)),i===t&&(i=""),e.$el.find(".slider_value").html(""===i?"&mdash;":i),n&&e.save_value(i)},o=this.$el.find(".noUiSlider").get(0);noUiSlider.create(o,{start:i,connect:[!0,!0],step:1,range:{min:t,max:this.model.get("options")[1]}}),o.noUiSlider.on("update",(function(e,t){n(e[t],!1)})),o.noUiSlider.on("change",(function(e,t){n(e[t],!0)})),n(this.model.get("value"))},save_value:function(e){e&&(e=parseInt(e)),this.model.set({value:e})}}),X=g.fH.extend({getTemplate:function(){return"#tpl_section_header"},tagName:"div",className:"section_header section_field"}),ee=g.fH.extend({className:function(){return _.result(ee.__super__,"className")+" section_field"}}),te=i("./src/backbone/shared/views/typeaheads.js"),ie=Backbone.Collection.extend({model:Backbone.Model.extend({idAttribute:"title",defaults:{title:""}}),initialize:function(e,t){e=this._convert_strings_to_model_json(e),ie.__super__.initialize.call(this,e,t)},add:function(e,t){e=this._convert_strings_to_model_json(e),ie.__super__.add.call(this,e,t)},_convert_strings_to_model_json:function(e){return e instanceof Array||(e=[e]),$.map(e,(function(e,t){return"string"==typeof e&&(e={title:e}),e}))},toJSON:function(){return this.pluck("title")}}),ne=te.kG.extend({collection:null,collection_class:ie,toolbarnav_title:function(){return this.allow_multiple?_t("mobile_toolbarnav_title_select_multiple"):_t("mobile_toolbarnav_title_select_one")},allow_multiple:!0,all_options:null,initialize:function(e){ne.__super__.initialize.apply(this,arguments);var t=this.post_on_select;this.post_on_select=function(e){t(e.toJSON())}},search:function(e){var t=$.grep(this.all_options,(function(t){return!e||t.toLowerCase().indexOf(e.toLowerCase())>-1}));this.collection.reset(),this.collection.add(t),this.register_selected_results()}}),oe=te.y3.extend({model:null,collection_class:ie,modal_class:ne,allow_multiple:!0,all_options:null,get_default_value:function(){return""},initialize:function(e){oe.__super__.initialize.apply(this,arguments);var t=this.on_item_removed;this.on_item_removed=function(e){t(e.toJSON())}},get_modal_options:function(){return $.extend(oe.__super__.get_modal_options.apply(this,arguments),{all_options:this.all_options})}}),ae=g.fH.extend({selections:null,templateHelpers:function(){var e=ae.__super__.templateHelpers.apply(this,arguments);return $.extend(e,{allow_multiselect:this.model.get("metadata")&&!!this.model.get("metadata").is_multiple_choices})},regions:{r_select_field_typeahead:".field_value"},events:{"change select.saveonchange":"save_value"},onRender:function(){if(this.templateHelpers().allow_multiselect){var e=this;this.r_select_field_typeahead.show(new oe({get_current_selections:function(){return e.model.get("value")},all_options:this.model.get("options"),post_on_select:function(t){e._save_value(t),e.isClosed||e.render()},on_item_removed:function(t){e._save_value(t)}}))}},save_value:function(e){this._save_value($(e.target).val())},_save_value:function(e){!e||e instanceof Array||(e=[e]),this.$el.removeClass("invalid"),this.model.set("value",e),this.model.isValid(!0)}}),se=P.extend({template:"#tpl_sensor_temperature_field_item",model:null,tagName:"li",className:"sensor_readings",events:_.extend({"click .sensor_refresh_temp":"refreshSensorReadings"},P.prototype.events),templateHelpers:function(){var e=this.model.get("placement"),t=this.isValidTemperatureReading(this.model.get("is_online"),this.model.get("last_reading_date"),this.model.get("last_reading_value")),i=!this.model.get("is_submitted_value");return $.extend(se.__super__.templateHelpers.apply(this,arguments),{timestamp:V.Z.get_formatted_sensor_timestamp({time_zone:$f.active_user.get("time_zone"),timestamp:this.model.get("last_reading_date"),format:$f.utils.DATE_AND_TIME_FMT}),value:$f.utils.convert_to_company_temperature(this.model.get("last_reading_value")),placementName:e?e.name:"",isActiveSubmissionWithInvalidTempReading:i&&!t,isValidTemperatureReading:t,isActiveSubmission:i})},refreshSensorReadings:function(){$f.application.vent.trigger("sensor:refresh_readings")},getTemplate:function(){return this.template},on_change_action:function(){this._scroll_down_one_field()},_should_force_temperature_probe:function(){return!$f.mobile.is.windows()&&!$f.mobile.is.web()&&this.model.collection.form_collection.metadata.get("is_force_probe_input")},isValidTemperatureReading:function(e,t,i){return V.Z.isValidSensorTemperatureReading(e,t,i)}}),le=Backbone.Marionette.CollectionView.extend({itemView:se,collection:null,initialize:function(e){void 0===e&&(e={}),$.extend(this,e)}}),re=g.fH.extend({template:"#tpl_sensor_temperature_field",model:null,regions:{r_sensor_temperatures_list:".sensor_temperatures_list"},getTemplate:function(){return this.template},initialize:function(e){var t=this,i=this.model.collection.findWhere({type:"account"});if(i){e=e||{},$.extend(this,e);var n=i.get("value");n&&!this.form_collection.has_been_submitted()&&this.model.set_initial_location(n),this.form_collection.has_been_submitted()&&this.model.sensor_collection.set_submitted_values(this.model.get("value")||[]),re.__super__.initialize.apply(this,arguments),this.listenTo(i,"change:value",(function(){return t.model.change_location(i.get("value"))})),this.listenTo(this.model.sensor_collection,"change add remove",this.save_value),this.listenTo($f.application.vent,"sensor:refresh_readings",this.refreshReadings)}},save_value:function(){var e=this;this.model.set("value",this.model.sensor_collection.map((function(t){return{id:t.get("id"),name:t.get("name"),placement:t.get("placement"),timestamp:t.get("is_online")?t.get("last_reading_date"):null,value:e.getSensorReadingValue(t),reading_method:t.get("reading_method")}}))),this.model.trigger("change",this.model)},getSensorReadingValue:function(e){var t=this.isValidTemperatureReading(e.get("is_online"),e.get("last_reading_date"),e.get("last_reading_value"));return t?t?e.get("last_reading_value"):null:e.get("value")},isValidTemperatureReading:function(e,t,i){return V.Z.isValidSensorTemperatureReading(e,t,i)},onRender:function(){this.r_sensor_temperatures_list.show(new le({collection:this.model.sensor_collection}))},handle_change:function(){},refreshReadings:function(){var e=this;this.$el.find(".sensor_refresh_temp").hide(),this.$el.find(".sensor_status_info_box.retry_action .loading_spinner").show(),this.model.sensor_collection.fetch({success:function(){e.render()},error:function(){e.$el.find(".loading_spinner").hide(),e.$el.find(".df-refresh-alert").show()}})}}),_e=i("./src/backbone/shared/models/files.js"),ce=i("./src/backbone-unorganized/utils/files/index.js"),ue=u.c1.extend({template:"#tpl_signature_dialog",id:"signature_base",className:"signature_display",form_collection:null,$signature_field:null,_original_file:null,onRender:function(){this.$signature_field=this.$el.find(".signature_field")},onShow:function(){this.on_orientation_change()},events:{"click .signature_submit":"submit_signature","click .signature_clear":"clear_signature","click .signature_close":"cancel"},initialize:function(e){ue.__super__.initialize.apply(this,arguments),this.model.get("file")&&this.model.get("file").at(0)&&(this._original_file=this.model.get("file").at(0))},submit_signature:function(e){var t=this._get_signature_data();if(!t)return this.close(),!1;var i={name:"signature-".concat(this.model.get("id"),"-").concat((new Date).getTime()),raw:t[1]},n=t[0],o=new _e.$r({id:(0,ce.Lk)(),mimetype:n,raw_file:i,url_base64:"data:".concat(n,",").concat(i.raw)});return i.raw&&i.name!=i.raw||$f.mobile.logging.log_error("Saving signature: file.raw not set properly.",{"file.raw":i.raw}),this.model.set("file",new _e.pm([o])),this.close(),!1},on_orientation_change:function(){this.$signature_field.find("canvas")&&this.$signature_field.jSignature("destroy"),this.$signature_field.jSignature({sizeRatio:3,height:"100%",width:"100%"})},clear_signature:function(){return this.$signature_field.jSignature("reset"),this.model.set({value:"",file:null}),!1},_get_signature_data:function(){if(!this.$signature_field)return null;if(!this.$signature_field.jSignature("getData","native").length)return null;var e=this.$signature_field.jSignature("getData","image");return e.length?e:null},remove:function(){ue.__super__.remove.call(this)},cancel:function(e){e&&e.preventDefault(),this._original_file&&this.model.set("file",[this._original_file]),this.close()},close:function(){ue.__super__.close.call(this),this.on_close()}}),de=g.fH.extend({events:{"click .add_signature_btn":"show_signature"},templateHelpers:function(){var e=de.__super__.templateHelpers.apply(this,arguments),t=this.model.get("value"),i=this.model.get("file")||[],n="";return i.length>0?n=i.at(0).get("url_base64"):t&&(t instanceof Array&&t.length&&(t=t[0]),n=$f.storage.get_storage_full_url(t)),$.extend(e,{src:n})},show_signature:function(e){var t=this;return $f.mobile.nav.show_modal(ue,{form_collection:this.form_collection,model:this.model,on_close:function(){$f.application.vent.trigger("mobile_form:scroll_to_element",{element:t.$el})}}),!1}}),me=g.fH.extend({template:"#tpl_stopwatch_field",model:null,className:"form-field stopwatch_field",interval_id:null,timer_value:0,events:{"click .stopwatch_start_button":"click_start_stopwatch","click .stopwatch_stop_button":"save_field_value","click .stopwatch_reset_button":"reset_stopwatch"},initialize:function(){var e=this;this.listenTo(this.model,"stopwatch_changed",this.render),this.listenTo($f.application.vent,"mobile:blur",(function(){e.clear_interval()})),this.listenTo($f.application.vent,"mobile:focus",(function(){e.model.start_date&&e.render()})),me.__super__.initialize.apply(this,arguments)},templateHelpers:function(){return $.extend({formatted_time:this.model.get("value")?$f.utils.get_string_from_milliseconds(this.model.get("value")):"00:00:00",allow_stopwatch:this.model.get("metadata")&&!!this.model.get("metadata").allow_stopwatch,is_running:!!this.model.start_date,pass_fail_class_name:this._get_acceptance_criteria_class()},me.__super__.templateHelpers.apply(this,arguments))},onRender:function(){var e=this;this.clear_interval(),this.timer_value=0,this.model.start_date&&this.start_stopwatch(!0),this.$el.find(".show_timespan_picker").mobiscroll().timespan({theme:"mobiscroll",display:"bottom",defaultValue:this.model.get("value")||void 0,wheelOrder:"hhiiss",max:86399e3,onSet:function(t,i){e.save_value(i.getVal())}})},clear_interval:function(){clearInterval(this.interval_id),this.interval_id=null},click_start_stopwatch:function(e){return this.start_stopwatch(!1),!1},start_stopwatch:function(e){var t=this;this.timer_value=this.model.start_date?moment()-moment(this.model.start_date):0,this.clear_interval(),this.interval_id=setInterval((function(){t._update_display()}),100),this.model.start_stopwatch(this.interval_id),e||this.render(!1)},save_field_value:function(){return this.save_value(moment()-moment(this.model.start_date)),!1},_update_display:function(){this.timer_value=this.timer_value+100,this.$el.find(".stopwatch_field_timer").text($f.utils.get_string_from_milliseconds(this.timer_value,"centiseconds"))},save_value:function(e){this.$el.removeClass("invalid"),this.model.stop_stopwatch(e),this.model.trigger("change",this.model),this.model.trigger("change:value",this.model)},reset_stopwatch:function(e){return this.timer_value=0,this.model.reset_stopwatch(),this.render(),!1},onClose:function(){this.clear_interval()}}),he=g.fH.extend({events:{"change textarea":"save_value","keyup textarea":"expand_textarea"}}),fe=i("./src/backbone/features/mobileForm/baseMediaFields/views.js").v.extend({collect_media_camera:function(){var e=this;$f.mobile.logging.log_event("User taking video in-app"),$f.mobile.is.windows()?$f.mobile.cordova.zencam.getZencam((function(t){e.on_collect_media_success(e._to_file_collection([t[0].localURL]))}),(function(t){e.on_collect_media_error(t,"camera")}),{videoMode:!0,strings:$f.mobile.cordova.get_zencam_localized_strings()}):this.is_gallery_permission_granted((function(t){t?$f.mobile.cordova.media_capture.captureVideo((function(t){e.on_collect_media_success(e._to_file_collection([t[0].fullPath]))}),(function(t){e.on_collect_media_error(t,"camera")}),{limit:1}):$f.mobile.notifications.show_permission_denied_msg(_t("mobile_message_media_perimission_denied")+_t("mobile_message_media_perimission_denied_device"))}))},collect_media_web:function(){var e=this;return $f.mobile.uploads.web_filestore.pick_new_file({allowed_file_types:"video/*",allow_multiple:!1,is_media:!0},(function(t){e.on_collect_media_success(t)})),!1},collect_media_gallery:function(){var e=this;$f.mobile.logging.log_event("User selecting video from gallery"),$f.mobile.cordova.camera.getPicture((function(t){t&&e.on_collect_media_success(e._to_file_collection([t]))}),(function(t){e.on_collect_media_error(t,"library")}),{saveToPhotoAlbum:!1,correctOrientation:!0,popoverOptions:new $f.mobile.cordova.CameraPopoverOptions(300,300,100,100,$f.mobile.cordova.camera.PopoverArrowDirection.ARROW_ANY),destinationType:$f.mobile.cordova.camera.DestinationType.NATIVE_URI,sourceType:$f.mobile.cordova.camera.PictureSourceType.PHOTOLIBRARY,mediaType:$f.mobile.cordova.camera.MediaType.VIDEO})}}),pe=Backbone.Marionette.ItemView.extend({template:"#tpl_yesno_field_history_list_item",model:null,className:"yesno_history_item",templateHelpers:function(){var e=this.model.get("acceptance_value")||this.model.get("value");if(!0===e||1===e)var t="df-success";else t=!1===e||-1===e?"df-close":e===B.NA||0===e?B.NA:"df-unavailable";return{icon:t}}}),ge=Backbone.Marionette.CollectionView.extend({template:"#tpl_yesno_field_history_list",itemView:pe,className:"yesno_history",collection:null,initialize:function(e){e=e||{},$.extend(this,e)}}),ve=g.fH.extend({regions:{r_yesno_history:".yesno_history_container"},events:{"click .yesno_buttons .btn":"save_value"},templateHelpers:function(){return $.extend(ve.__super__.templateHelpers.apply(this,arguments),{show_na_btn:this.model.get("metadata")&&this.model.get("metadata").allow_na||this.model.get("value")===B.NA})},initialize:function(){var e=this;ve.__super__.initialize.apply(this,arguments);var t=this.model.collection.findWhere({type:"account"});t&&this.listenTo(t,"change:value",(function(){e.toggle_yesno_history()}))},onRender:function(){if(""!==this.model.get("value")){var e,t=this.model.get("acceptance_value");switch($f.active_company.has_feature("show_acceptance_crit")||(t=0),t){case 1:e="selected_pass";break;case-1:e="selected_failure";break;default:e="selected"}var i=this.model.get("value");$f.utils.is_nil(i)&&""!==i||this.$el.find(".yesno_buttons .btn[value=".concat(i,"]")).addClass(e)}this.toggle_yesno_history()},on_change_action:function(){this._scroll_down_one_field()},save_value:function(e){var t=this.model.get("value");if((null==t?void 0:t.toString())==$(e.target).attr("value"))return this.model.set({value:""}),$(e.target).removeClass("selected"),!1;var i=$(e.target).attr("value");try{i=JSON.parse(i)}catch(e){}return this.model.set({value:i}),!1},toggle_yesno_history:function(){var e=this,t=this.model.collection,i=t.findWhere({type:"account"});return t.metadata.get("is_show_yesno_history")&&(this.model.get("acceptance_value")&&-1===this.model.get("acceptance_value")||!this.model.get("acceptance_value")&&!1===this.model.get("value"))&&i&&i.get("value")?void this.model.get_history((function(t){t&&t.length&&e.r_yesno_history&&e.r_yesno_history.show(new ge({collection:t}))})):this.r_yesno_history.close()}}),be=i("../../../node_modules/react/index.js"),we=function(e,t,i,n){return new(i||(i=Promise))((function(o,a){function s(e){try{r(n.next(e))}catch(e){a(e)}}function l(e){try{r(n.throw(e))}catch(e){a(e)}}function r(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,l)}r((n=n.apply(e,t||[])).next())}))},ye=function(e,t){var i,n,o,a,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(a){return function(l){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,n=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((o=(o=s.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){s.label=a[1];break}if(6===a[0]&&s.label<o[1]){s.label=o[1],o=a;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(a);break}o[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],n=0}finally{i=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}},$e=Backbone.Marionette.ItemView.extend({template:"#tpl_form_section",itemViewContainer:"ul.form_container",children_views:null,is_collapsed:!1,SLIDE_TIME_MS:200,section_parent:null,triggers:{expanded_noop:"expanded"},events:{"click .section_header, .section_footer":"toggle_collapse"},templateHelpers:function(){var e={show_section_footer:!!this.section_parent,is_collapsed:this.is_collapsed};if(!this.section_parent)return e;var t=this.section_parent.get_stats(),i=null,n=null;return 0===t.get("num_required_incomplete")||0===t.get("num_required")?(i=_t("mobile_forms_required_questions_complete"),n="required_complete"):(i=_t("mobile_forms_required_remaining",{count:t.get("num_required_incomplete")}),n="required_not_complete"),$.extend(e,{num_total:t.get("num_total"),footer_text:i,is_required_class:n})},initialize:function(e){e=e||{},$.extend(this,e),this.children_views=[]},add_child_view:function(e){var t=this;return this.children_views.push(e),this.listenTo(e.model,"change",(function(e){"section"===e.get("type")&&e.get("metadata")&&!1===e.get("metadata").is_collapsed&&t.expand(),t._update_footer()})),e.model.temperature_collection&&this.listenTo(e.model.temperature_collection,"follow_up_actions_on_change",(function(){t._update_footer()})),this},onBeforeRender:function(){this._add_remove_collapsed_class()},onRender:function(){var e=this;0==this.templateHelpers().num_total&&this.$el.addClass("section_no_fields"),$.each(this.children_views,(function(t,i){if(i.model===e.section_parent)e.$el.prepend(i.$el);else{var n=e.$(e.itemViewContainer),o="#field_".concat(i.model.get("id")),a=n.find(o);a.length&&a.remove(),n.append(i.$el)}}))},toggle_collapse:function(e){return this.is_collapsed?this.expand():this.collapse($(e.target).hasClass("section_footer")),!1},_slide:function(e,t){t||(t=function(){}),this.$el.find(".form_container_wrapper").velocity(e,{duration:this.SLIDE_TIME_MS,easing:"easeInOutCubic",complete:t})},expand:function(e){var t=this,i=e=e||function(){};e=function(){t.trigger("expanded"),i()},this.is_collapsed?(this.is_collapsed=!1,this._add_remove_collapsed_class(),this._update_section_field_metadata(),this._slide("slideDown",(function(){e()}))):e()},collapse:function(e){if(!this.is_collapsed&&(this.is_collapsed=!0,this._add_remove_collapsed_class(),this._update_section_field_metadata(),this._slide("slideUp"),e)){var t=this.$el.find(".section_header"),i=$(".page_scrollable");i.animate({scrollTop:t.offset().top-i.offset().top+i.scrollTop()-100},this.SLIDE_TIME_MS)}},_add_remove_collapsed_class:function(){this.is_collapsed?this.$el.addClass("collapsed"):this.$el.removeClass("collapsed")},has_invalid_fields:function(){return 0!==this.$el.find(".invalid").length},_update_section_field_metadata:function(){var e=$.grep(this.children_views,(function(e,t){return"section"==e.model.get("type")}))[0];e.model.get("metadata")||e.model.set("metadata",{},{silent:!0}),e.model.get("metadata").is_collapsed=this.is_collapsed,e.model.trigger("change",e.model)},_update_footer:function(){this.$el.find(".section_footer").html(this.templateHelpers().footer_text),this.$el.find(".section_footer").removeClass("required_not_complete").removeClass("required_complete").addClass(this.templateHelpers().is_required_class)}}),ke=u.IO.extend({template:"#tpl_mobile_form_page",tabs:[],active_comment_id:null,expanded_metadata:null,events:{"click .view_previous_submissions":"view_previous_submissions","click .view_reorder_page":"view_reorder_page"},regions:{r_tabbed_layout:".mobile_form_tabbed_layout"},initialize:function(){var e=this;if(!this.collection)throw new Error("Programmer error: MobileForm must have a collection.");this.toolbarnav_title=this.collection.metadata.get("title"),this.toolbarnav_actions=[{container_class:"view_previous_submissions",icon_class:"df-history",i18n_key_text:"mobile_mobileform_text"}],this.collection.metadata.get("is_secure")&&(this.toolbarnav_actions=[{display:"icon",icon_class:"df-lock",container_class:"lock_icon"}]);var t=this.collection.metadata.get("order_fields_by_location"),i=this.collection.findWhere({type:"account"});$f.active_company.has_feature("custm_quest_ordering")&&t&&this.toolbarnav_actions.push({container_class:"view_reorder_page ".concat(i?"":"disabled"),icon_class:"",i18n_key_text:"mobile_mobileform_reorder_fields"}),this.tabs=[{id:"mobile_form_info",name:_t("mobile_dashboard_tab_title_info"),view_class:Se,view_options:{collection:this.collection,expanded_metadata:this.expanded_metadata}}],this.listenTo($f.application.vent,"mobile_form:scroll_to_element",(function(t){e.scroll_to_element(t.element,t.speed,t.offset)})),this.listenTo($f.application.vent,"mobile_form:on_orientation_change",(function(){e.on_orientation_change()})),this.listenTo(this.collection,"reset",this.onShow)},onShow:function(){ke.__super__.onShow.apply(this,arguments),this._show_tabbed_layout(),this.is_historic_view&&$f.mobile.nav.restore_scroll_position(),this.on_orientation_change(),this.trigger_dynamic_form_first_load_event()},trigger_dynamic_form_first_load_event:function(){var e=this.collection.findWhere({type:"account"});this.collection.trigger("dynamicform:first_load",e?e.get("value"):null)},toolbarnav_create_task_options:function(){var e=this.collection.findWhere({type:"account"});return e&&!e.get("hidden")&&e.get("value")&&e.get("account")?{default_account:new o.mR(e.get("account"))}:{}},view_previous_submissions:function(e){return $f.application.vent.trigger("mobileform:show_history"),!1},view_reorder_page:function(e){var t=this;e.preventDefault();var i=this.collection.findWhere({type:"account"}),n=this.getLocationValue(),o=i&&i.get("id"),a=!!n,s=!$f.mobile.is.connected(),l=function(){$f.mobile.notifications.hide_loading_dialog(),$f.mobile.notifications.show_success_msg(),t.collection.trigger("reset")},_=function(){$f.mobile.notifications.hide_loading_dialog(),$f.mobile.notifications.show_error_msg()},c=function(e){$f.mobile.notifications.show_loading_dialog(),$f.mobile.nav.go_back(),t.collection.locationFieldOrder.save({field_order:{field_order:e}},{success:l,error:_},{patch:!0})},u=function(e){var t=_t("mobile_message_reordering_confirm");if(!$f.mobile.is.web()){var i={title:_t("mobile_forms_leaving_reordering"),subtitle:t,position:[50,60],addCancelButtonWithLabel:_t("mobile_action_sheet_cancel")};return $f.mobile.is.ios()?(i.buttonLabels=[_t("mobile_forms_reordering_button_save")],i.addDestructiveButtonWithLabel=_t("mobile_common_button_discard"),i.destructiveButtonLast=!0):$f.mobile.is.android()?(i.buttonLabels=[_t("mobile_forms_reordering_button_save"),_t("mobile_common_button_discard")],i.androidTheme=$f.mobile.cordova.actionsheet.ANDROID_THEMES.THEME_DEVICE_DEFAULT_LIGHT,i.androidEnableCancelButton=!0):$f.mobile.is.windows()&&(i.buttonLabels=[_t("mobile_forms_reordering_button_save"),_t("mobile_common_button_discard")]),void $f.mobile.notifications.decide(i,(function(t){3!==t&&(2!==t?c(e):$f.mobile.nav.go_back())}))}$f.mobile.notifications.confirm(t,(function(t){t&&c(e)}),_t("mobile_message_reordering_confirm"),_t("mobile_common_button_yes"),_t("mobile_common_button_no"))};s?$f.mobile.notifications.show_offline_msg():a?$f.mobile.nav.show(h,{renderFunction:function(){return be.createElement(r.Z,{fields:t.collection.serialize_for_reordering(),onGoBack:u,onSave:c,_t:_t})}}):this.$("#field_".concat(o)).addClass("invalid")},go_back:function(e){$f.application.vent.trigger("mobileform:go_back:save_draft")},_show_tabbed_layout:function(){this._tabbedLayout=new f.WD({is_tabs_full_width:!0,hide_tabs:1===this.tabs.length,tab_pages:new n.sR(this.tabs),active_tab_id:this.active_comment_id?$f.shared.comments.utils.COMMENTS_TAB_ID:null}),this.r_tabbed_layout.show(this._tabbedLayout)},getLocationValue:function(){var e=this.collection.findWhere({type:"account"});return e&&e.get("value")}}),Ee=Backbone.Marionette.CollectionView.extend({collection:null,itemViewEventPrefix:"fieldview",_section_views:[],itemViewOptions:function(){return{form_collection:this.collection}},getItemView:function(e){if("document"===e.get("type")&&$f.mobile.is.windows()&&$f.mobile.is.native())return e.unsupported_field_type=!0,u.HN;switch(this.collection.add_item_to_field_map(e),e.get("type")){case"email":return A;case"text":return he;case"number":return L;case"stopwatch":return me;case"formula":return j;case"select":return ae;case"checkbox":return T;case"image":return q.IL;case"video":return fe;case"signature":return de;case"section":return this._is_collapsable_section(e)?X:ee;case"account":return k;case"datetime":return S;case"barcode":return x;case"yesno":return ve;case"range":return Q;case"instructions":return Z;case"temperature":return P;case"ingredient_temperature":case"equipment_temperature":return Y;case"sensor_temperature":return re;case"document":return R.Tf;default:return e.unsupported_field_type=!0,u.HN}},_is_collapsable_section:function(e){return"section"==e.get("type")&&e.get_dependent_field_level()===$f.utils.DEPENDENT_FIELD_TOP_LEVEL},appendHtml:function(e,t){var i=this.$el.find(".form_section:last");i.length&&!this._is_collapsable_section(t.model)||(this.$el.append('<div class="form_section card"></div>'),i=this.$el.find(".form_section:last"),this._section_views.push(new $e({el:i.get(0),$el:i,is_collapsed:!(!t.model.get("metadata")||void 0===t.model.get("metadata").is_collapsed)&&t.model.get("metadata").is_collapsed,section_parent:this._is_collapsable_section(t.model)?t.model:null}))),this._section_views[this._section_views.length-1].add_child_view(t)},onBeforeRender:function(){this._close_section_views()},onRender:function(){$.each(this._section_views,(function(e,t){t.render()}))},expand_invalid_sections:function(e){e=e||function(){},$.each(this._section_views,(function(t,i){if(!i.has_invalid_fields())return!0;i.expand(e)}))},_close_section_views:function(){0!=this._section_views.length&&($.each(this._section_views,(function(e,t){t.close()})),this._section_views=[])},onClose:function(){this._close_section_views()}}),xe=Backbone.Marionette.ItemView.extend({template:"#tpl_submission_tasks_alert_rule"}),Te=Backbone.Marionette.CompositeView.extend({template:"#tpl_submission_tasks_alert_rules_card",itemView:xe,itemViewContainer:".task_alert_rules",collection:null}),Se=f.OY.extend({template:"#tpl_mobile_form",className:function(){return"".concat(Se.__super__.className," wrapper")},tagName:"div",_prevent_next_reload_on_resume:!1,_has_temperature_field:!1,_field_map:null,_last_visited_model_id:null,_total_invalid:0,events:{"click .view_previous_submissions":"view_previous_submissions","click #submit_form":"click_submit","click .prev":"click_error_wizard_button","click .next":"click_error_wizard_button","change .form_field":"field_changed","click .section_sticky_header":"show_table_of_contents"},regions:{r_fields:".form_outer_container",r_submission_tasks_alerts:".submission_tasks_alerts"},templateHelpers:function(){return{metadata:this.collection.metadata,smetadata:this.collection.smetadata,default_sticky_header_text:"",rules:this.expanded_metadata?this.expanded_metadata.rules:null,disable_submit_button:!!window.UNSAVED_CHANGES_FROM_BUILDER}},initialize:function(e){e=e||{},$.extend(this,e);var t=this;$f.window.last_rdbms_id=this.collection.metadata.get("rdbms_id"),$f.mobile.get_device_location({only_if_permission_granted:!0,cache_allowance_ms:0}),this.listenTo($f.application.vent,"mobileform:go_back:save_draft",(function(){t.save_draft((function(){$f.mobile.remove_active_collection((function(){$f.mobile.nav.go_back()}))}))})),this.listenTo($f.application.vent,"mobileform:show_history",(function(){t._show_history()}))},onBeforeRender:function(){this._isRendered&&!this._is_wizard_open&&this.collection.each((function(e){e.is_valid=null}))},onRender:function(){var e=this;this.r_fields.close(),this.r_fields.show(new Ee({collection:this.collection})),this._show_submision_tasks_alerts(),$f.application.vent.trigger("mobile_form:on_orientation_change"),this.stopListening(this.r_fields.currentView,"fieldview:mobile_form:render"),this.listenTo(this.r_fields.currentView,"fieldview:mobile_form:render",(function(){e.render()})),this.stopListening(this.r_fields.currentView,"fieldview:request_error_wizard_recalculation"),this.listenTo(this.r_fields.currentView,"fieldview:request_error_wizard_recalculation",(function(t){e._is_wizard_open&&e.update_error_wizard(t.model)})),this.stopListening(this.r_fields.currentView,"fieldview:prevent_next_reload_on_resume"),this.listenTo(this.r_fields.currentView,"fieldview:prevent_next_reload_on_resume",(function(){e._prevent_next_reload_on_resume=!0})),this._setup_bluetooth(),this.stopListening(this.collection,"field:hidden_field:show"),this.stopListening(this.collection,"field:hidden_field:hide"),this.listenTo(this.collection,"field:hidden_field:show",(function(t){e._is_wizard_open?t.validate():setTimeout((function(){t.is_valid=t.isValid(!0,!0)}))})),this.listenTo(this.collection,"field:hidden_field:hide",(function(e){e.validate()})),this.listenTo(this.collection,"dynamicform:sections_hidden",(function(){this.$el.removeClass("has_sections")})),this.listenTo(this.collection,"dynamicform:sections_visible",(function(){this.$el.addClass("has_sections")})),this.listenTo(this.collection,"dynamicform:location_attributes_unavailable",_.debounce((function(){$f.mobile.notifications.show_error_msg(_t("mobile_message_error_location_attributes_unavailable"))}),100)),this.collection.findWhere({type:"section"})&&(this.$el.addClass("has_sections"),this._update_sticky_section_header(),this.$el.find(".page_scrollable").off("scroll.mobile_form").on("scroll.mobile_form",(function(){e._update_sticky_section_header()}))),this._isShown&&this._on_show_render()},onShow:function(){var e=this;this.$el.find(".form_outer_container").css("visibility","hidden"),setTimeout((function(){e.$el.find(".form_outer_container").css("visibility","")}),0),this._on_show_render(),this.collection.metadata.get("is_secure")&&this._display_secure_form_header()},_on_show_render:function(){this._update_sticky_section_header(),this._perform_form_field_events()},on_resume:function(){var e=this;_.each(this.collection.models,(function(t){"stopwatch"===t.get("type")&&$f.mobile.settings.get("stopwatch_start_date_"+t.id,(function(i){e.r_fields.currentView.children.findByModel(t).render()}))})),this.collection.is_started()||this._prevent_next_reload_on_resume||$f.window.has_received_zenput_uri?this._setup_bluetooth():($f.mobile.load_collection(this.collection.metadata.get("rdbms_id")),this._prevent_next_reload_on_resume=!1)},_update_sticky_section_header:function(){var e,t=this._get_current_section_el(),i=this.$el.find(".section_sticky_header");e=t?t.text().trim():this.templateHelpers().default_sticky_header_text,i.find(".section_sticky_name").text().trim()!==e&&i.find(".section_sticky_name").html(e)},show_table_of_contents:function(e){var t=this,i=this._get_current_section_el(),n=null;return i&&(n=parseInt(i.attr("id").replace("field_",""))),$f.application.bottom_sheet.show(new M({collection:this.collection,current_section_id:n,on_click_section:function(e){if($f.application.bottom_sheet.close(),!e)return t.scroll_to_element(0);e.get("metadata")?(e.get("metadata").is_collapsed=!1,e.trigger("change",e)):e.set("metadata",{is_collapsed:!1}),t.scroll_to_field(e.id,null,-50)}})),!1},click_submit:function(e){e&&e.preventDefault();var t=this,i=$(e.target);if(i.hasClass("disabled")||i.attr("disabled"))return!1;if($f.mobile.is.native()&&$(window).height()<$f.window.viewport.height)return setTimeout((function(){t.click_submit(e)}),300),!1;var n=this.get_running_stopwatches();if(n.length)return $f.mobile.notifications.show_error_msg(_t("mobile_message_error_stopwatch_field_running")),this.scroll_to_field(n[0].id),!1;if($f.mobile.debugging.get_flag("disable_template_validation")&&"production"!==$f.deploy_env);else if(!this.show_error_wizard())return!1;if(!this.collection.is_started())return $f.mobile.notifications.show_error_msg(_t("mobile_message_error_fill_out_form")),!1;this.collection.set_location_order(),t.collection.smetadata.set("date_completed",{$date:(new Date).getTime()}),t.collection.smetadata.set("time_zone",$f.active_user.get("time_zone"));var o=t.collection.smetadata.get("task");if(!o)return t._add_record_and_start_upload(),!1;if(o.account_id&&t.collection.findWhere({type:"account"})){var s=!1;_.each(t.collection.where({type:"account"}),(function(e){e.get("account")&&e.get("account").id===o.account_id&&(s=!0)})),s||(t.collection.smetadata.set({task:null,project:null}),$f.mobile.logging.log_event("Disassociated task from form due to missing Account",{task_id:o.id,missing_account_id:o.account_id}))}return $f.mobile.cache.update_cache_item({item_id:o.id,cache_key_substrs:a.jR.cache_blacklist_key,update_fn:function(e){return e.current_state="processing",e},callback:function(){t._add_record_and_start_upload()}}),!1},_add_to_local_records:function(e,t){return new Promise((function(i,n){e.add_records(t,i,n)}))},_add_record_and_start_upload:function(){var e=this;$f.mobile.logging.log_event("Adding record and uploading"),this._disable_submit_btn(),$f.mobile.pending_form_submissions.add_record(this.collection,(function(){var t;$f.window.last_rdbms_id=e.collection.metadata.get("rdbms_id");var i=Boolean(null===(t=e.collection.smetadata.get("task"))||void 0===t?void 0:t.id),n=function(){return we(e,void 0,void 0,(function(){var e,t;return ye(this,(function(n){switch(n.label){case 0:if($f.mobile.nav.clear(),!i)return $f.mobile.nav.show(l.FormTemplatesPage,{}),[2];e=new a.yO(this.collection.smetadata.get("task")),n.label=1;case 1:return n.trys.push([1,3,,4]),[4,this._add_to_local_records($f.mobile.pending_tasks_in_processing,e)];case 2:return n.sent(),[3,4];case 3:return t=n.sent(),$f.mobile.logging.log_error("Failed to add task to processing queue",{error:t,task:e.toJSON(),rdbms_id:this.collection.metadata.get("rdbms_id")}),[3,4];case 4:return $f.mobile.nav.show(l.TasksPage,{prioritize_cached_results:!0}),[2]}}))}))};$f.mobile.is.web()?$f.mobile.uploads.start_upload({success:function(){$f.mobile.remove_active_collection((function(){var e;window.IS_FORM_BUILDER_PREVIEW?("function"==typeof Event?e=new Event("saved_from_preview"):(e=document.createEvent("Event")).initEvent("saved_from_preview",!0,!0),window.dispatchEvent(e)):n()}))},error:function(){e._enable_submit_btn()}}):$f.mobile.remove_active_collection((function(){return we(e,void 0,void 0,(function(){return ye(this,(function(e){switch(e.label){case 0:return[4,n()];case 1:return e.sent(),$f.mobile.uploads.start_upload(),[2]}}))}))}))}),(function(){$f.mobile.logging.log_error("Failed to add_record() for $f.mobile.pending_form_submissions"),$f.mobile.notifications.show_error_msg(),e._enable_submit_btn()}))},_disable_submit_btn:function(){this.$el.find("#submit_form").html(_t("mobile_html_submitting")).attr("disabled","disabled")},_enable_submit_btn:function(){this.$el.find("#submit_form").removeAttr("disabled").html(_t("mobile_common_button_submit"))},click_error_wizard_button:function(e){var t=null;return $(e.target).hasClass("next")?t=this._field_map.get_next_invalid_id(this._last_visited_model_id):$(e.target).hasClass("prev")&&(t=this._field_map.get_prev_invalid_id(this._last_visited_model_id)),null===t?this.show_error_wizard_buttons():(this._last_visited_model_id=t,this.scroll_to_field(t),this.show_error_wizard_buttons(),!1)},show_error_wizard_buttons:function(){var e=this.$el.find(".next"),t=this.$el.find(".prev"),i=this._field_map.get_next_invalid_id(this._last_visited_model_id),n=this._field_map.get_prev_invalid_id(this._last_visited_model_id);e.css("visibility",null===i?"hidden":"visible"),t.css("visibility",null===n?"hidden":"visible")},hide_error_wizard:function(){this.$el.find(".next_prev").hide(),$f.mobile.nav.add_options({_is_wizard_open:!1})},show_error_wizard:function(e){e=e||{};var t=this;return this._field_map=this.collection.field_map,this._total_invalid=this.collection.get_total_invalid(!0),this._total_invalid?(this._last_visited_model_id=this.collection.get_first_invalid().id,this.$el.find(".next_prev_text").text(_t("mobile_forms_required_remaining",{count:this._total_invalid})),this.$el.find(".next_prev").show(),e.is_resuming||this.r_fields.currentView.expand_invalid_sections((function(){t.scroll_to_field(t._last_visited_model_id),$f.mobile.notifications.show_error_msg(_t("mobile_message_error_fill_require_fields"))})),this.show_error_wizard_buttons(),this._is_wizard_open=!0,$f.mobile.nav.add_options({_is_wizard_open:!0}),!1):(this.hide_error_wizard(),!0)},_show_history:function(){var e=this.collection.where({type:"account"}),t=1==e.length&&e[0].get("account")?e[0].get("account").name:"";$f.mobile.nav.show(Ae,{use_transitions:!0,form_structure:this.collection,rdbms_id:this.collection.metadata.get("rdbms_id"),toolbarnav_title:this.toolbarnav_title,search_query:t})},update_error_wizard:function(e){_.contains(["section","formula"],e.get("type"))||(this._last_visited_model_id=e.id,this._total_invalid=this.collection.get_total_invalid(!1),this._total_invalid?(this.$el.find(".next_prev_text").text(_t("mobile_forms_required_remaining",{count:this._total_invalid})),this.show_error_wizard_buttons()):this.hide_error_wizard())},scroll_to_field:function(e,t,i){i=i||-50;var n=this.$el.find("[id=field_".concat(e,"]")),o=function(){$f.application.vent.trigger("mobile_form:scroll_to_element",{element:n,speed:t,offset:i})};n.parents(".form_section.collapsed").length?this.r_fields.currentView._section_views.forEach((function(t){t.children_views.forEach((function(i){i.model.id===e&&t.expand(o)}))})):o()},get_running_stopwatches:function(){return this.collection.filter((function(e){return!("stopwatch"!==e.get("type")||!e.start_date)}))},_get_current_section_el:function(){var e=this.$el.find(".page_scrollable").scrollTop(),t=this.$el.find(".section_field:visible"),i=null;return t.each((function(t,n){var o=$(n);if(n.offsetTop-($f.mobile.is.ios()?140:80)>e)return!0;i=o})),i},_perform_form_field_events:function(){this.collection.each((function(e){$.each(e.get("events"),(function(t,i){e.perform_event(i)}))})),this.r_fields.currentView&&this.r_fields.currentView._section_views.forEach((function(e){e._update_footer()})),this._is_wizard_open&&this.show_error_wizard({is_resuming:!0})},_count_temperature_fields:function(){return this.collection.filter((function(e){return"temperature"==e.get("type")||"ingredient_temperature"==e.get("type")||"equipment_temperature"==e.get("type")||"sensor_temperature"==e.get("type")})).length},_setup_bluetooth:function(){if($f.mobile.bluetooth.supports_bluetooth()&&!$f.mobile.is.web()&&!this.collection.is_submitted()&&0!=this._count_temperature_fields()&&!this._already_setup_bloothtooth){this._has_temperature_field=!0,this._already_setup_bluetooth=!0;var e=this;$f.mobile.bluetooth.register_callbacks({on_pre_connect:function(){},on_device_connected:function(){e.isClosed?$f.mobile.bluetooth.disconnect():$f.mobile.notifications.show_success_msg(_t("mobile_message_blue_therm_success"))},on_device_disconnected:function(t){e.isClosed||$f.mobile.notifications.show_error_msg(_t("mobile_message_blue_therm_error"))},on_device_connection_failure:function(e){var t=(0,s.f4)(e),i=_t("mobile_message_blue_therm_error_code");e!==s.my.ERROR_BLUETOOTH_DISABLED?$f.mobile.notifications.show_error_msg(t):$f.mobile.notifications.show_error_msg("".concat(i," ").concat(t))},on_reading_received:function(e){},on_button_pressed:function(e){}})}},_sync_draft:function(e){$f.mobile.form_drafts.add_record(this.collection,(function(){return $f.mobile.notifications.toast(_t("mobile_message_drafts_toast_saved"),"","df-success",1500),$f.mobile.notifications.show_upload_success_msg=!1,$f.mobile.uploads.start_upload(),e()}),(function(){$f.mobile.notifications.show_error_msg()}),{is_synced:!1})},_save_draft_confirmation:function(e,t){var i=this;if(e=e||_t("mobile_message_drafts_confirm"),!$f.mobile.is.web()){var n={title:_t("mobile_forms_leaving_form"),subtitle:e,position:[50,60],addCancelButtonWithLabel:_t("mobile_action_sheet_cancel")};return $f.mobile.is.ios()?(n.buttonLabels=[_t("mobile_common_button_save_draft")],n.addDestructiveButtonWithLabel=_t("mobile_common_button_discard"),n.destructiveButtonLast=!0):$f.mobile.is.android()?(n.buttonLabels=[_t("mobile_common_button_save_draft"),_t("mobile_common_button_discard")],n.androidTheme=$f.mobile.cordova.actionsheet.ANDROID_THEMES.THEME_DEVICE_DEFAULT_LIGHT,n.androidEnableCancelButton=!0):$f.mobile.is.windows()&&(n.buttonLabels=[_t("mobile_common_button_save_draft"),_t("mobile_common_button_discard")]),void $f.mobile.notifications.decide(n,(function(e){if(3!==e)return 2===e?($f.mobile.uploads.clear_pending_file_uploads(i.collection.smetadata.get("guid")),t()):void i._sync_draft(t)}))}$f.mobile.notifications.confirm(e,(function(e){if(!e)return t();i._sync_draft(t)}),_t("mobile_common_button_save_draft"),_t("mobile_common_button_yes"),_t("mobile_common_button_no"))},save_draft:function(e){var t=this;if(!this.collection.is_started())return e();if($f.window.uploading)return e();var i=this.get_running_stopwatches(),n=function(e){if(e=e||function(){},!i.length)return e(!0);$f.mobile.notifications.confirm(_t("mobile_message_alert_running_stopwatches"),(function(n){if(!n)return e(!1);!function(e){e=e||function(){};var n=function(){if(0===i.length)return e();var o=i.pop();t.r_fields.currentView.children.findByModel(o).clear_interval(),$f.mobile.settings.get("stopwatch_start_date_"+o.id,(function(e){o.start_date=null,$f.mobile.settings.remove("stopwatch_start_date_"+o.id,(function(){n()}))}))};n()}((function(){e(!0)}))}),_t("mobile_field_stopwatch_stop_stopwatches"),_t("mobile_common_button_yes"),_t("mobile_common_button_no"))};this.collection.is_draft()?$f.mobile.form_drafts.get_record(this.collection.smetadata.get("guid"),null,(function(i){i&&i.smetadata.get("date_modified").$date==t.collection.smetadata.get("date_modified").$date?e():n((function(i){i&&t._save_draft_confirmation(_t("mobile_message_drafts_request_update"),e)}))})):n((function(i){i&&t._save_draft_confirmation(null,e)}))},onClose:function(){this.collection.off("change"),!$f.mobile.is.web()&&this._has_temperature_field&&($f.mobile.bluetooth.unregister_callbacks(),$f.mobile.bluetooth.disconnect()),this.$el.find(".page_scrollable").off("scroll.mobile_form"),this._is_wizard_open||this.collection.each((function(e){e.is_valid=null}))},_display_secure_form_header:function(){var e=$('<i aria-hidden="true" class="nav_icon df-lock"></i>'),t=$("<p> This is a private form. Your submission will only be viewable to those who have access.</p>"),i=$('<div class="secure_form_header"> </div>');$(i).append($(e)),$(i).append($(t)),$(".form_outer_container").prepend($(i))},_show_submision_tasks_alerts:function(){if(this.expanded_metadata&&this.expanded_metadata.rules.length>0){var e=new Backbone.Collection;e.add(this.expanded_metadata.rules),this.r_submission_tasks_alerts.show(new Te({collection:e}))}}}),Re=Backbone.Marionette.ItemView.extend({tagName:"li",events:{"click .navlink":"click_navlink"},initialize:function(e){e=e||{},$.extend(this,e)},templateHelpers:function(){var e=this.model.get("form_structure")?this.model.get("form_structure").smetadata:this.model.get("smetadata");if(e){var t=this.model.get("form_structure").where({type:"account"}),i=t.length>0?t[0].get("account"):null,n=i?i.name:"";return t.length>1&&(n+=" and more"),{date:$f.utils.format_submission_date(e,"ddd, MMM D"),time:$f.utils.format_submission_date(e,"h:mm a z",null,null,!0),location_name:n}}},click_navlink:function(e){var t=this,i=new b.Jh({id:this.model.id});return $f.mobile.notifications.show_loading_dialog(),i.fetch({success:function(e){$f.mobile.notifications.hide_loading_dialog();var n=i.get("expanded_metadata");i.unset("expanded_metadata"),$f.mobile.nav.add_options({collection:t.model.collection}),$f.mobile.nav.show(Me,{collection:i.get("form_structure"),use_transitions:!0,expanded_metadata:n})},error:function(e,t){$f.mobile.notifications.hide_loading_dialog(),t.zenput_code!==$f.zenput_codes.PERMISSION_DENIED?$f.mobile.notifications.show_error_msg():$f.mobile.notifications.show_error_msg(_t("mobile_message_show_submissions_access_denied"))}}),!1}}),Ce=Re.extend({template:"#tpl_submission_history_item"}),Ie=Re.extend({template:"#tpl_form_history_item",templateHelpers:function(){var e=Ie.__super__.templateHelpers.apply(this,arguments),t=this.model.get("form_structure"),i=t.smetadata.get("created_by"),n=i&&i.display_name?i.display_name:"";return $.extend(e,{form_title:n}),e}}),ze=u.mp.extend({template:"#tpl_history_list",itemViewContainer:"ul.pagelist.history_list",className:"form_template_list submissions_list",allow_reverse_transitions:!0,is_search_running:0,search_criteria_list:null,search_criteria:null,search_query:"",_last_fetch_timestamp:null,getEmptyView:function(){return d.G.extend({i18n_key_message:"mobile_empty_list_message_no_submissions"})},initialize:function(e){if(e=e||{},$.extend(this,e),this.collection)return this.search_criteria_list=this.collection.search_criterias,void(this.search_criteria=this.search_criteria_list.at(0));this.search_criteria=new o.O1({value:this.search_query?this.search_query:""}),this.search_criteria_list=new o.Ax([],{metadata:{next_criteria_id:1,simple_logic:"and",display_result_type:"list"},result_type:{list:{sort:[{field_id:"smetadata.date_submitted",order:-1}],columns:[],type:"list"}}}),this.search_criteria_list.add(this.search_criteria),this.collection=new b.El([],{search_criterias:this.search_criteria_list,rdbms_id:this.rdbms_id,paginator_options:{output:"list",data_source:"elastic_search",view_type:"simple"}}),this.collection.paginator.set("limit",25)},onRender:function(){var e=this;if(this.$el.find(".search_bar").html("").append(new m.R({collection:this.collection,default_value:this.search_query,search:function(t,i){e.search(t,i)}}).render().$el),!(this.collection.length>0&&this.is_historic_view)){this.$el.find(".empty_list_message_wrapper").hide(),$f.mobile.notifications.show_loading_dialog();var t=function(){$f.mobile.notifications.hide_loading_dialog(),e.$el.find(".empty_list_message_wrapper").show()};this.collection.fetch({success:t,error:function(){$f.mobile.is.connected()?e.$el.find(".empty_list_message_wrapper p").html(_t("mobile_html_something_went_wrong_try_again")):e.$el.find(".empty_list_message_wrapper p").html(_t("mobile_html_offline_try_again")),t()}})}},onShow:function(){ze.__super__.onShow.call(this),this._setup_infinite_scroll()},search:function(e){this.search_criteria.set("value",e),$f.mobile.nav.add_options({search_query:e}),this.collection.paginator.reset_pagination(),this.collection.fetch({reset:!0,sort:!1,success:function(){$f.mobile.notifications.hide_loading_dialog()},error:function(){$f.mobile.notifications.hide_loading_dialog()}})},_setup_infinite_scroll:function(){var e=this,t=this.$el.find(".page_scrollable");setTimeout((function(){e.is_historic_view||t.scrollTop(0),t.off("scroll"),t.on("scroll",(function(){t.scrollTop()<t.get(0).scrollHeight-t.height()-600||e._last_fetch_timestamp+2e3>(new Date).getTime()||(e._last_fetch_timestamp=(new Date).getTime(),e.$el.find(".infinite_scroll_loading").css("visibility","visible"),e.collection.fetch_next({sort:!1,success:function(){e.$el.find(".infinite_scroll_loading").css("visibility","hidden")},error:function(){e.$el.find(".infinite_scroll_loading").css("visibility","hidden")},remove:!1}))}))}),100)}}),Ae=ze.extend({itemView:Ie,toolbarnav_title:function(){return _t("mobile_toolbarnav_title_form_history")},initialize:function(e){if(!e.rdbms_id)throw new Error("Programmer Error: rdbms_id is missing from FormSubmissionsHistoryList");this.rdbms_id=e.rdbms_id,Ae.__super__.initialize.call(this,e)}}),Ne=ze.extend({itemView:Ce,toolbarnav_title:function(){return _t("mobile_left_menu_my_submissions")},is_top_level_page:!0,initialize:function(e){$f.application.vent.trigger("mobile:set_active_leftmenu_item","nav_history"),Ne.__super__.initialize.call(this,e)}}),Me=ke.extend({expanded_metadata:null,comments:null,auto_resize_page_scrollable:!1,events:{"click .view_pdf":"view_pdf","click .share_link":"share_link"},initialize:function(e){e=e||{},$.extend(this,e),Me.__super__.initialize.apply(this,arguments),this.toolbarnav_actions=[{container_class:"view_pdf",icon_class:"df-history",i18n_key_text:"mobile_view_pdf"}],!1===this.collection.metadata.get("is_secure")&&this.toolbarnav_actions.push({container_class:"share_link",icon_class:"df-send",i18n_key_text:"mobile_share_link"})},onShow:function(){var e=this;Me.__super__.onShow.call(this),this.$el.addClass("historical_submission"),this.$el.find(".hidden_formula").show(),this.$el.find("textarea").attr("disabled","disabled"),this.$el.find("textarea").attr("readonly","readonly"),this.$el.find("select").attr("disabled","disabled"),this.$el.find(".not_visible").hide(),this.fetch_comments({submission:this.collection,success:function(){return we(this,void 0,void 0,(function(){return ye(this,(function(t){switch(t.label){case 0:return $f.mobile.notifications.hide_loading_dialog(),[4,e.add_comments_tab()];case 1:return t.sent(),e._show_tabbed_layout(),e.on_orientation_change(),e.trigger_dynamic_form_first_load_event(),[2]}}))}))},error:function(t){return we(this,void 0,void 0,(function(){return ye(this,(function(i){switch(i.label){case 0:return[4,e.add_comments_tab()];case 1:return i.sent(),e._show_tabbed_layout(),$f.mobile.notifications.hide_loading_dialog(),$f.mobile.notifications.show_error_msg(t&&t.message,null),[2]}}))}))}})},on_orientation_change:function(){return Me.__super__.on_orientation_change.apply(this,arguments)},click_submit:function(e){return!1},go_back:function(){if(this.is_comments_tab())return this.go_back_comments_tab();$f.mobile.nav.go_back()},view_pdf:function(e){var t=this;return e.preventDefault(),this.collection.get_pdf_url((function(e){if(!e)return $f.mobile.notifications.show_success_msg(_t("mobile_no_pdf_generated_message"));if($f.mobile.is.web()||$f.mobile.is.windows())$f.mobile.open_uri(e,"_blank");else{var i="".concat(t.collection.metadata.get("title")).concat(parseInt(1e5*Math.random()),".pdf");$f.mobile.cordova.zencam.viewDocumentRemote({path:e,original_name:i},(function(){}),(function(){$f.mobile.logging.log_error("S3 pdf location could not be loaded.")}))}})),!1},share_link:function(e){e.preventDefault(),o.zc.get_share_link(this.collection._id.$oid,(function(e){$f.mobile.is.web()?window.alert(e):($f.mobile.cordova.clipboard.copy(e),$f.mobile.notifications.show_success_msg(_t("mobile_clipboard_copied_success")))}),(function(){$f.mobile.notifications.show_error_msg()}))}});Cocktail.mixin(Me,c.R)},"./src/backbone/features/toolbarNav/views.js":function(e,t,i){i.d(t,{MV:function(){return m}});var n=i("./src/backbone-unorganized/shared/forms.js"),o=n.Dn.extend({idAttribute:"container_class",defaults:{container_class:"",icon_class:"",text:"",display:"overflow"}}),a=n.DR.extend({model:o}),s=n.Dn.extend({defaults:{value:null,display_value:null,is_selected:!1}}),l=n.DR.extend({model:s}),r=Backbone.Marionette.ItemView.extend({template:"#tpl_toolbarnav_overflow_menu_item",model:null,tagName:"li",templateHelpers:function(){var e=this.model.get("i18n_key_text");return{text:_t(e)||e,icon:this.model.get("icon")}}}),c=Backbone.Marionette.CollectionView.extend({collection:null,itemView:r,tagName:"ul",ANIMATION_TIME_MS:150,onShow:function(){var e=this.$el.css("height"),t=this.$el.parent();t.velocity({height:e},{duration:this.ANIMATION_TIME_MS,easing:"easeOutQuint",begin:function(){t.css({height:0})}})},close:function(){var e=this,t=arguments,i=this.$el.parent();i.velocity({opacity:0},{duration:this.ANIMATION_TIME_MS,easing:"easeOutQuint",complete:function(){i.attr("style",""),c.__super__.close.apply(e,t)}})}}),u=Backbone.Marionette.ItemView.extend({template:"#tpl_toolbarnav_select_option",model:null,tagName:"li"}),d=c.extend({collection:null,itemView:u,ANIMATION_TIME_MS:300}),m=Backbone.Marionette.Layout.extend({template:"#tpl_toolbarnav",page_title:null,page_subtitle:null,show_back_button:!1,show_add_task:!1,show_edit_sensor:!1,toggle_search:!1,create_task_options:null,parent_page:null,center_title:!1,actions:null,_overflow_actions:null,_overflow_tasks_actions:null,_primary_action:null,toolbarnav_select_options:null,_sensor_model:null,triggers:{go_back__noop:"toolbarnav:go_back"},templateHelpers:function(){return{title:this.page_title,subtitle:this.page_subtitle,show_back_button:this.show_back_button,primary_action:this._primary_action,show_add_task:this.show_add_task,show_edit_sensor:this.show_edit_sensor,toggle_search:this.toggle_search,show_overflow_menu:this._overflow_actions&&this._overflow_actions.length>0,center_title:this.center_title,show_select_options:this.show_select_options(),notification_count:$f.mobile.unread_notifications_count.get("count")}},regions:{r_overflow_menu:".overflow_menu",r_toolbar_select_options:".select_options_container"},events:{"click #action_left.toggle_leftmenu":"toggle_leftmenu","click #action_left.go_back":"click_go_back","click .quick_add_task":"show_tasks_menu","click .show_overflow_menu":"show_overflow_menu","click .title_container":"show_select_options_list","click .edit_sensor":"show_edit_sensor_page","click .create_tasks":"show_create_tasks","click .create_project":"show_create_project","click .create_announcement":"show_create_announcement","click .overflow_menu a":function(e){this.hide_overflow_menu()}},initialize:function(e){e=e||{},$.extend(this,e),this.actions||(this.actions=[]),this.actions instanceof Backbone.Collection||(this.actions=new a(this.actions)),this.toolbarnav_select_options&&this.toolbarnav_select_options.length>0&&(this.toolbarnav_select_options=new l(this.toolbarnav_select_options),this.page_title=this.toolbarnav_select_options.findWhere({is_selected:!0}).get("display_value")),this.listenTo($f.mobile.unread_notifications_count,"change",this.render)},onBeforeRender:function(){this.actions.where({display:"icon"}).length>1&&console.warn("Cannot have multiple Toolbarnav Actions with display:icon. Defaulting to just one."),this._overflow_actions=new a(this.actions.toJSON()),this._overflow_tasks_actions=new a,this._primary_action=this._overflow_actions.findWhere({display:"icon"}),this._overflow_actions.remove(this._primary_action),this._overflow_tasks_actions.add([{icon:"df-tasks",container_class:"create_tasks",i18n_key_text:"mobile_tasks_create_task",display:"overflow"},{icon:"df-projects",container_class:"create_project",i18n_key_text:"mobile_projects_create_project",display:"overflow"},{icon:"df-announcement",container_class:"create_announcement",i18n_key_text:"mobile_announcements_create",display:"overflow"}]),this.show_add_task&&(this.show_add_task=!0)},onRender:function(){this.page_subtitle?this.$el.addClass("has_subtitle"):this.$el.removeClass("has_subtitle"),this.templateHelpers().show_overflow_menu?this.$el.addClass("has_overflow_menu"):this.$el.removeClass("has_overflow_menu")},on_show:function(){$f.mobile.notifications.show_upload_progress()},_show_touchblock:function(){var e=this;$f.mobile.show_overflow_touchblock($(".overflow_touchblock"),(function(){return e.hide_overflow_menu(),e.hide_select_options_list(),$f.mobile.hide_overflow_touchblock(),!1}))},show_overflow_menu:function(e){if(!this._overflow_actions||!this._overflow_actions.length)return!1;this.r_overflow_menu.show(new c({collection:this._overflow_actions})),this._show_touchblock()},hide_overflow_menu:function(e){return this.r_overflow_menu.close(),$f.mobile.hide_overflow_touchblock(),!1},show_select_options_list:function(){return $f.active_user.is_submitter()||!this.toolbarnav_select_options||0==this.toolbarnav_select_options.length||(this.r_toolbar_select_options.show(new d({collection:this.toolbarnav_select_options})),this._show_touchblock()),!1},set_sensor_model:function(e){this._sensor_model=e},show_edit_sensor_page:function(e){var t=this;e.preventDefault(),Promise.resolve().then(i.bind(i,"./src/backbone-unorganized/sensors/views.js")).then((function(e){$f.mobile.nav.show(e.SensorSettingsPage,{model:t._sensor_model})}))},show_create_tasks:function(e){e.preventDefault(),Promise.resolve().then(i.bind(i,"./src/backbone-unorganized/tasks/views.js")).then((function(e){$f.mobile.nav.show(e.FastTasksPage,{})}))},show_create_announcement:function(e){e.preventDefault(),i.e(511).then(i.bind(i,"./src/backbone-unorganized/announcements/views.js")).then((function(e){$f.mobile.nav.show(e.AnnouncementCreator,{})}))},show_create_project:function(e){e.preventDefault();var t=this.create_task_options||{};_.isFunction(t)&&(t=t.apply(this.parent_page,[])),Promise.resolve().then(i.bind(i,"./src/backbone-unorganized/views.js")).then((function(e){$f.mobile.nav.show(e.ProjectCreator,t)}))},show_select_options:function(){return!$f.active_user.is_submitter()&&this.toolbarnav_select_options&&this.toolbarnav_select_options.length},hide_select_options_list:function(e){return this.r_toolbar_select_options.close(),!1},toggle_leftmenu:function(){return $f.application.vent.trigger("mobile:toggle_leftmenu"),!1},click_go_back:function(){return this.trigger("toolbarnav:go_back"),!1},add_actions:function(e){var t=e instanceof Backbone.Collection?e.toJSON():e;this.actions.add(t),this.render()},show_tasks_menu:function(e){return $f.mobile.is.connected()?$f.active_user.is_submitter()?(this.show_create_tasks(e),!1):(this.r_overflow_menu.show(new c({collection:this._overflow_tasks_actions})),this._show_touchblock(),!1):($f.mobile.notifications.show_error_msg(_t("mobile_message_error_create_task")),!1)}})},"./src/backbone/shared/models/BluetoothDeviceAPI.js":function(e,t,i){i.d(t,{MC:function(){return s},qf:function(){return l},EX:function(){return r},Q8:function(){return _},pG:function(){return c},l4:function(){return u}});var n=i("./src/backbone-unorganized/shared/forms.js"),o=i("./src/backbone-unorganized/utils/bluetooth.js"),a=n.Dn.extend({CONNECT_TIMEOUT_MS:3e3,DISCOVERY_DELAY_MS:1e3,UUIDS:{BLE_TEMPERATURE_SERVICE:null,BLE_TEMPERATURE_CHARACTERISTIC:null,BLE_TEMPERATURE_CHARACTERISTIC_NOTIF:null},_active_address:null,defaults:{},constructor:function(e){e=e||{},$.extend(this,e),a.__super__.constructor.call(this,[],e)},on_pre_connect:function(e){},on_device_connected:function(){},on_device_connection_failure:function(){},on_device_disconnected:function(e){},on_reading_received:function(e){},on_button_pressed:function(e){},_get_connect_fn:function(e){$f.mobile.cordova.bluetoothle.wasConnected((function(t){e(t.wasConnected?"reconnect":"connect")}),(function(t){e("connect")}),{address:this._active_address})},_clear_connect_timeout:function(){this._connect_timeout_id&&(clearTimeout(this._connect_timeout_id),this._connect_timeout_id=null)},_start_connect_timeout:function(){var e=this;this._clear_connect_timeout(),this._connect_timeout_id=setTimeout((function(){var t=function(){e.on_device_connection_failure(o.my.ERROR_FAILURE_TO_CONNECT)};$f.mobile.cordova.bluetoothle.close(t,t,{address:e._active_address})}),this.CONNECT_TIMEOUT_MS)},_connect:function(e){var t=this;t._active_address=e,t._get_connect_fn((function(e){t._start_connect_timeout(),$f.mobile.cordova.bluetoothle[e]((function(e){if(t._clear_connect_timeout(),"connected"!==e.status)return t.on_device_disconnected(o.my.ERROR_FAILURE_TO_CONNECT,"Status reports not connected");t.on_device_connected()}),(function(e){return t._clear_connect_timeout(),"enable"===e.error?t.on_device_connection_failure(o.my.ERROR_BLUETOOTH_DISABLED):"isNotDisconnected"===e.error?t.on_device_connection_failure(o.my.ERROR_FAILURE_TO_CONNECT):void t.on_device_connection_failure(o.my.ERROR_FAILURE_TO_CONNECT)}),{address:t._active_address,autoConnect:!1})}))},connect:function(e){this.on_pre_connect(),this._connect(e)},_close:function(){var e=this;$f.mobile.cordova.bluetoothle.close((function(t){e.on_device_disconnected(o.my.ERROR_DISCONNECTION_SUCCESSFUL)}),(function(t){$f.mobile.logging.log_error("Failed to close bluetoothle",{message:t.message}),e.on_device_disconnected(o.my.ERROR_DISCONNECTION_SUCCESSFUL)}),{address:e._active_address})},disconnect:function(){var e=this;$f.mobile.bluetooth.is_scanning?$f.mobile.bluetooth.stop_scan(this.disconnect.bind(this)):$f.mobile.cordova.bluetoothle.disconnect((function(){e._close()}),(function(){e._close("Failed to disconnect bluetoothle")}),{address:this._active_address})},is_device_connected:function(e){$f.mobile.cordova.bluetoothle.isConnected((function(t){e(!0)}),(function(t){e(!1)}),{address:this._active_address})},start_polling:function(e){(e=e||{}).error=e.error||function(){};var t=this;if(e.success)throw new Error("Programmer Error: unexpected success callback in start_polling(). Use on_reading_received()");setTimeout((function(){$f.mobile.cordova.bluetoothle.isDiscovered((function(i){if(i.isDiscovered)return t.subscribe(e);$f.mobile.cordova.bluetoothle.discover((function(){t.subscribe(e)}),(function(t){e.error(o.my.ERROR_FAILURE_TO_POLL,t.message)}),{address:t._active_address})}),(function(t){e.error(o.my.ERROR_FAILURE_TO_POLL,t.message)}),{address:t._active_address,clearCache:!0})}),this.DISCOVERY_DELAY_MS)},subscribe:function(e){throw new Error("Programmer Error: subscribe() not implemented")},on_failure_to_subscribe:function(e,t){e.message.toLowerCase().indexOf("already subscribed")>-1||t(e.message.includes("Code=15")?o.my:o.my.ERROR_FAILURE_TO_POLL,e.message)},stop_polling:function(){this.UUIDS.BLE_TEMPERATURE_CHARACTERISTIC_NOTIF&&this.unsubscribe_from_temperature_characteristic(this.UUIDS.BLE_TEMPERATURE_CHARACTERISTIC_NOTIF),this.unsubscribe_from_temperature_characteristic(this.UUIDS.BLE_TEMPERATURE_CHARACTERISTIC)},unsubscribe_from_temperature_characteristic:function(e){$f.mobile.cordova.bluetoothle.unsubscribe(this.on_success_to_unsubscribe,this.on_failure_to_unsubscribe,{address:this._active_address,service:this.UUIDS.BLE_TEMPERATURE_SERVICE,characteristic:e})},on_success_to_unsubscribe:function(e){"unsubscribed"!==e.status&&this.on_failure_to_unsubscribe({message:"Response status does not match unsubscribed"})},on_failure_to_unsubscribe:function(e){console.error("Unable to unsubscribe")},convert_base64_to_string:function(e){try{var t=atob(e).trim(),i=parseFloat(t.match(/((\-)??[0-9]*(\.)??[0-9]*)+/))}catch(t){return $f.mobile.logging.log_error("Unable to parse BLE temperature data",{probe_type:$f.mobile.bluetooth.device.get("type"),response_value:e}),null}return!i||isNaN(i)?null:(t.indexOf("C")>-1&&(i=$f.utils.centigrade_to_fahrenheit(i,2)),i)}}),s=Backbone.Model.extend({defaults:{name:"(unknown)",address:"",selected:!1,type:""}}),l=Backbone.Collection.extend({selected_device:null,select_device:function(e){this.selected_device=e},unselect_device:function(){this.selected_device=null}}),r=a.extend({UUIDS:{BLE_TEMPERATURE_SERVICE:"F2B32C77-EA68-464B-9CD7-A22CBFFB98BD",BLE_TEMPERATURE_CHARACTERISTIC:"78544003-4394-4FC2-8CFD-BE6A00AA701B",BLE_SLEEP_TIME:"FB441C3A-87FC-477D-9F53-7F1C53F0BB03"},STATUS:{WRITTEN:"written",SUBSCRIBED:"subscribed"},SLEEP_TIME_STRING_5:"5",parse_ble_response_to_fahrenheit:function(e){return this.convert_base64_to_string(e)},did_ble_button_press:function(e){try{var t=atob(e).trim()}catch(t){return $f.mobile.logging.log_error("Unable to parse BLE temperature data",{probe_type:"cooperatkins",response_value:e}),!1}return t.indexOf("S")>-1},subscribe:function(e){var t=this;(e=e||{}).error=e.error||function(){},this._write_sleep_time({success:function(){t._subscribe(e.error)}})},_write_sleep_time:function(e){var t=this;if((e=e||{}).error=e.error||function(){},!e.success)throw new Error("Programmer Error: missing success callback in _write_sleep_time()");$f.mobile.cordova.bluetoothle.write((function(i){i.status===t.STATUS.WRITTEN&&e.success()}),(function(t){e.error(t)}),{address:t._active_address,service:t.UUIDS.BLE_TEMPERATURE_SERVICE,characteristic:t.UUIDS.BLE_SLEEP_TIME,value:t._get_encoded_sleep_time()})},_get_encoded_sleep_time:function(){var e=$f.mobile.cordova.bluetoothle.stringToBytes(this.SLEEP_TIME_STRING_5);return $f.mobile.cordova.bluetoothle.bytesToEncodedString(e)},_subscribe:function(e){var t=this;$f.mobile.cordova.bluetoothle.subscribe((function(e){if(e.status!==t.STATUS.SUBSCRIBED&&e.value){var i=t.parse_ble_response_to_fahrenheit(e.value);i&&(t.did_ble_button_press(e.value)?t.on_button_pressed(i):t.on_reading_received(i))}}),(function(i){t.on_failure_to_subscribe(i,e)}),{address:t._active_address,service:t.UUIDS.BLE_TEMPERATURE_SERVICE,characteristic:t.UUIDS.BLE_TEMPERATURE_CHARACTERISTIC})}}),_=a.extend({UUIDS:{BLE_TEMPERATURE_SERVICE:"45544942-4C55-4554-4845-524DB87AD700",BLE_TEMPERATURE_CHARACTERISTIC:"45544942-4C55-4554-4845-524DB87AD701",BLE_TEMPERATURE_CHARACTERISTIC_NOTIF:"45544942-4C55-4554-4845-524DB87AD705"},parse_ble_response_to_fahrenheit:function(e){try{var t=new DataView($f.mobile.cordova.bluetoothle.encodedStringToBytes(e).buffer).getFloat32(null,!0)}catch(t){return $f.mobile.logging.log_error("Unable to parse BLE temperature data",{probe_type:"bluetherm",response_value:e}),null}return isNaN(t)?null:$f.utils.centigrade_to_fahrenheit(t,2)},did_ble_button_press:function(e){try{var t=new DataView($f.mobile.cordova.bluetoothle.encodedStringToBytes(e).buffer).getUint16(null,!0)}catch(t){return $f.mobile.logging.log_error("Unable to parse BLE temperature data",{probe_type:"bluetherm",response_value:e}),!1}return 1===t},subscribe:function(e){var t=this;(e=e||{}).error=e.error||function(){};var i=null;$f.mobile.cordova.bluetoothle.subscribe((function(e){"subscribed"!==e.status&&e.value&&t.did_ble_button_press(e.value)&&i&&t.on_button_pressed(i)}),(function(i){t.on_failure_to_subscribe(i,e.error)}),{address:t._active_address,service:t.UUIDS.BLE_TEMPERATURE_SERVICE,characteristic:t.UUIDS.BLE_TEMPERATURE_CHARACTERISTIC_NOTIF}),$f.mobile.cordova.bluetoothle.subscribe((function(e){if("subscribed"!==e.status&&e.value){var n=t.parse_ble_response_to_fahrenheit(e.value);n&&(i=n,t.on_reading_received(n))}}),(function(i){t.on_failure_to_subscribe(i,e.error)}),{address:t._active_address,service:t.UUIDS.BLE_TEMPERATURE_SERVICE,characteristic:t.UUIDS.BLE_TEMPERATURE_CHARACTERISTIC})}}),c=a.extend({UUIDS:{BLE_TEMPERATURE_SERVICE:"9D55A000-BC06-40EC-94CB-266609000419",BLE_TEMPERATURE_CHARACTERISTIC:"9D55C000-BC06-40EC-94CB-266609000419"},_get_decimal_from_hex:function(e){var t=(e=e.replace(/0x/g,"")).split(" ");t.reverse();var i=t.join("");return this._hex_to_signed_int(i)*Math.pow(10,-2)},_hex_to_signed_int:function(e){e.length%2!=0&&(e="0"+e);var t=parseInt(e,16),i=Math.pow(2,e.length/2*8);return t>i/2-1&&(t-=i),t},parse_ble_response_to_fahrenheit:function(e){try{var t=$f.mobile.cordova.bluetoothle.encodedStringToBytes(e).slice(1,4),i=$f.mobile.cordova.bluetoothle.bytesToHex(t),n=this._get_decimal_from_hex(i)}catch(t){return $f.mobile.logging.log_error("Unable to parse BLE temperature data",{probe_type:"tempalert",response_value:e}),null}return isNaN(n)?null:$f.utils.centigrade_to_fahrenheit(n,2)},subscribe:function(e){var t=this;(e=e||{}).error=e.error||function(){},$f.mobile.cordova.bluetoothle.subscribe((function(e){if("subscribed"!==e.status&&e.value){var i=t.parse_ble_response_to_fahrenheit(e.value);i&&t.on_reading_received(i)}}),(function(i){t.on_failure_to_subscribe(i,e.error)}),{address:t._active_address,service:t.UUIDS.BLE_TEMPERATURE_SERVICE,characteristic:t.UUIDS.BLE_TEMPERATURE_CHARACTERISTIC})}}),u=a.extend({UUIDS:{BLE_TEMPERATURE_SERVICE:"00005A90-3354-11E8-B467-0ED5F89F718B",BLE_TEMPERATURE_CHARACTERISTIC_PLUNGE:"00005A93-3354-11E8-B467-0ED5F89F718B",BLE_TEMPERATURE_CHARACTERISTIC_SURFACE:"00005A92-3354-11E8-B467-0ED5F89F718B"},parse_ble_response_to_fahrenheit:function(e){return this.convert_base64_to_string(e)},subscribe:function(e){(e=e||{}).error=e.error||function(){},this._subscribe($.extend(e,{BLE_TEMPERATURE_CHARACTERISTIC:this.UUIDS.BLE_TEMPERATURE_CHARACTERISTIC_PLUNGE})),this._subscribe($.extend(e,{BLE_TEMPERATURE_CHARACTERISTIC:this.UUIDS.BLE_TEMPERATURE_CHARACTERISTIC_SURFACE}))},stop_polling:function(){this.unsubscribe_from_temperature_characteristic(this.UUIDS.BLE_TEMPERATURE_CHARACTERISTIC_PLUNGE),this.unsubscribe_from_temperature_characteristic(this.UUIDS.BLE_TEMPERATURE_CHARACTERISTIC_SURFACE)},_subscribe:function(e){var t=this;$f.mobile.cordova.bluetoothle.subscribe((function(e){if("subscribed"!==e.status&&e.value){var i=t.parse_ble_response_to_fahrenheit(e.value);i&&t.on_button_pressed(i)}}),(function(i){t.on_failure_to_subscribe(i,e.error)}),{address:t._active_address,service:t.UUIDS.BLE_TEMPERATURE_SERVICE,characteristic:e.BLE_TEMPERATURE_CHARACTERISTIC})}})},"./src/backbone/shared/models/CommentsPageLayoutMixin.js":function(e,t,i){i.d(t,{R:function(){return o}});var n=i("./src/backbone-unorganized/shared/comments/models.js"),o={comments:null,initialize:function(e){(e=e||{}).comments&&(this.comments=e.comments)},fetch_comments:function(e){(e=e||{}).success=e.success||function(){},e.error=e.error||function(){};var t=null;if(e.submission?t=new n.zP({id:e.submission._id.$oid,instance:e.submission}):e.task&&(t=new n.ql({id:e.task.id,instance:e.task})),this.comments=new n.HW(null,{target:t}),!$f.mobile.is.connected())return e.error({message:_t("mobile_empty_list_message_must_be_online")});this.comments.fetch({success:function(t){e.success()},error:function(t){e.error(t)}})},add_comments_tab:function(){return e=this,t=void 0,o=function(){var e,t;return function(e,t){var i,n,o,a,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(a){return function(l){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,n=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((o=(o=s.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){s.label=a[1];break}if(6===a[0]&&s.label<o[1]){s.label=o[1],o=a;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(a);break}o[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],n=0}finally{i=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}}(this,(function(n){switch(n.label){case 0:return e="",this.comments&&this.comments.display_length()&&(e="(".concat(this.comments.display_length(),")")),[4,Promise.resolve().then(i.bind(i,"./src/backbone-unorganized/comments/views.js"))];case 1:return t=n.sent(),this.tabs.push({id:$f.shared.comments.utils.COMMENTS_TAB_ID,tab_class:this.comments.has_unread_comments()?"has_unread_comments":"",name:"".concat(_t("mobile_tasks_tab_title_comments")," ").concat(e),view_class:t.CommentsTab,view_options:{collection:this.comments,task:this.model,submission:this.collection}}),this._update_nav_item_name(),[2]}}))},new((n=void 0)||(n=Promise))((function(i,a){function s(e){try{r(o.next(e))}catch(e){a(e)}}function l(e){try{r(o.throw(e))}catch(e){a(e)}}function r(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,l)}r((o=o.apply(e,t||[])).next())}));var e,t,n,o},_update_nav_item_name:function(){var e=this;this.listenTo(this.comments,"add change",(function(){e.r_tabbed_layout.currentView.update_tab({id:$f.shared.comments.utils.COMMENTS_TAB_ID,changes:{name:"".concat(_t("mobile_tasks_tab_title_comments")," (").concat(e.comments.display_length(),")"),tab_class:e.comments.has_unread_comments()?"has_unread_comments":""}})}))},go_back_comments_tab:function(){$f.application.vent.trigger("comments_tab:go_back:post_comment")},is_comments_tab:function(){return this.r_tabbed_layout.currentView.active_tab_id===$f.shared.comments.utils.COMMENTS_TAB_ID}}},"./src/backbone/shared/models/MobileMediaField.js":function(e,t,i){i.d(t,{u:function(){return a}});var n=i("./src/backbone/features/mobileForm/BaseField/models.js"),o=i("./src/backbone/shared/models/files.js"),a=n.q_.extend({submodels:{file:o.pm},validation:{file:{required:function(e,t,i){return this._validate_field(e,t,i)}}},_validate_field:function(e,t,i){return!!this._is_required(e,t,i)&&!this.has_value()},initialize:function(e,t){a.__super__.initialize.apply(this,arguments),this._repair_corrupted_images_on_web(),$f.mobile.debugging.get_flag("disable_background_uploading")||this.on("change:file",this.queue_field_files_for_upload.bind(this))},get_local_and_remote_files:function(){var e=new o.pm;return this.get("value")&&_.each(this.get("value"),(function(t){e.add({url_s3:t})})),this.get("file")&&this.get("file").each((function(t){e.add(t)})),e},save_files:function(e,t){(e=e||{}).add=e.add||new o.pm,e.modify=e.modify||new o.pm,e.delete=e.delete||new o.pm,t=t||function(){};var i=this;if(e.add.length||e.modify.length||e.delete.length){var n=[],a=function(e,t,i){if((i=i||0)===e.length)return t();e.at(i).process_for_zenput((function(n){a(e,t,i+1)}),(function(){n.push(e.at(i)),a(e,t,i+1)}))};a(e.add,(function(){a(e.modify,(function(){_.each(n,(function(e){e.collection.remove(e)})),i._set_files(e),t()}))}))}},_set_files:function(e){(e=e||{}).add=e.add||new o.pm,e.modify=e.modify||new o.pm,e.delete=e.delete||new o.pm;var t=this,i=function(){t.collection&&t.collection.trigger("change")},n=(this.get("file")||new o.pm).filter((function(t){return $f.mobile.is.web()?!e.delete.get(t.id):!e.delete.findWhere({url_native:t.get_url_native()})})),a=_.filter(this.get("value")||[],(function(t){return e.delete.findWhere({url_s3:t})?null:t}));if(e.modify.each((function(e){var t=_.filter(n,(function(t){return t.get_url_native()===e.get("original_url_native")}))[0];if(!t)return $f.mobile.logging.log_error("Unable to find original file after editing in Zencam",{original_url_native:e.get("original_url_native")}),!0;n.splice(n.indexOf(t),1,e)})),this.set({file:n.length?new o.pm(n):null,value:a.length?a:""}),e.add.length){if("video"===this.get("type")||"document"===this.get("type")&&!this.allow_multiple)this.set("file",new o.pm([e.add.first().toJSON()]));else{var s=this.get("file")||new o.pm;s.add(e.add.toJSON()),this.set("file",s,{silent:!0}),this.trigger("change:file",this)}i()}else i()},prepare_for_submission:function(){var e=this.get("value")||[];this.get("file")&&(e.length&&this.get("file").length&&"signature"===this.get("type")&&(e=[]),this.get("file").each((function(t){var i=t.get("raw_file").name;if(!$f.mobile.uploads.get_pending_upload(i).is_upload_finished())throw new Error("Critical: submitting form field before files are uploaded");if($f.mobile.uploads.get_pending_upload(i).is_upload_missing())return!0;var n=$f.mobile.uploads.get_pending_upload(i),o=n.get("server_filename")||n.get("upload_filename");if(!o)return!0;e.push(o)})),this.set({file:null,value:e.length?e:""},{silent:!0}))},queue_field_files_for_upload:function(){var e=this,t=this.get("file");t&&t.length&&t.each((function(t){if(!t.get("raw_file"))return $f.mobile.logging.log_error("Skipping file upload. Missing raw_file.",{url_native:t.get_url_native()}),!0;var i=e.create_field_upload_filename(t.get("raw_file"));t.get("path")||t.set("path",i,{silent:!0}),$f.mobile.uploads.add_pending_file_upload({file:t,file_type:e.get("type"),parent_upload_guid:e.get_parent_upload_guid(),upload_filename:i})}))},_repair_corrupted_images_on_web:function(){if($f.mobile.is.web()&&"signature"!==this.get("type")&&this.get("file")&&this.get("file").length){var e=new o.pm;this.get("file").each((function(t){if(t.get("raw_file")instanceof window.File)return e.add(t),!0;var i=$f.mobile.uploads.web_filestore.get_file(t.id);if(!i)return!0;e.add(i)})),this.set("file",e.length?e:null)}},get_parent_upload_guid:function(){throw new Error("Programmer Error: get_parent_upload_guid() not implemented")},create_field_upload_filename:function(e){throw new Error("Programmer Error: create_field_upload_filename() not implemented")},toJSON:function(){var e=a.__super__.toJSON.apply(this,arguments);if(!$f.mobile.is.web())return e;if(!e.file||!e.file.length)return e;var t=JSON.parse(JSON.stringify(e.file));return _.each(t,(function(e){e.url_base64=null})),e.file=t,e},get_attributes_for_autofill:function(){return{}},get_submission_value:function(){return(this.get("value")||[]).map((function(e){return{s3_key:e}}))}})},"./src/backbone/shared/models/files.js":function(e,t,i){i.d(t,{$r:function(){return a},pm:function(){return s},AE:function(){return l}});var n=i("./src/backbone-unorganized/shared/forms.js"),o=i("./src/backbone-unorganized/utils/files/index.js"),a=n.Dn.extend({defaults:{id:null,raw_file:null,mimetype:"",metadata:null,url_base64:null,url_native:"",url_cdva:null,url_s3:"",original_url_native:"",legacy_file_structure:null,size:null,path:null},constructor:function(e,t){if(e&&(e.uuid||e.raw)){var i;i=e.raw?{name:e.name,raw:e.raw}:e,e={id:e.uuid||e.name,raw_file:i,mimetype:e.type,metadata:e.metadata,url_native:e.nativeURL,url_cdva:e.url,url_base64:i.raw?"data:".concat(e.type,",").concat(i.raw):null,legacy_file_structure:e}}a.__super__.constructor.call(this,e,t)},initialize:function(e,t){$f.mobile.is.native()&&this.set("url_native",this.get_url_native(),{silent:!0})},get_url_native:function(){return $f.mobile.is.ios()&&this.get("raw_file")?$f.mobile.is.android()&&this.get("url_cdva")?this.get("url_cdva"):"".concat($f.mobile.cordova.file.dataDirectory).concat(this.get("raw_file").name):this.get("url_native")},get_display_url:function(e,t){if(t=t||!1,this.get("raw_file"))return $f.mobile.is.web()?this.get("url_base64"):e&&$f.mobile.is.ios()?this.convert_file_src_for_ios(this.get_url_native()):this.get_url_native();var i=$f.storage.get_storage_full_url(this.get("url_s3"));return e&&!t?$f.storage.get_thumbnail(i,"234"):i},convert_file_src_for_ios:function(e){if(!e)return e;var t=$f.base_url.replace(/https?:\/\//,"zenput://");return 0===e.indexOf("/")?t+"/_app_file_"+e:0===e.indexOf("file://")?t+e.replace("file://","/_app_file_"):0===e.indexOf("content://")?t+e.replace("content:/","/_app_content_"):e},process_for_zenput:function(e,t){$f.mobile.is.web()?this._process_web(e,t):this._process_native(e,t)},_process_web:function(e,t){var i=this;this.set("mimetype",this.get("raw_file").type);var n=new FileReader;n.readAsDataURL(this.get("raw_file")),i.set("size",this.get("raw_file").size,{silent:!0}),n.onload=function(t){i.set("url_base64",t.target.result),e(this)}},_getCdvaFileSize:function(e){return new Promise((function(t,i){e.file?e.file((function(e){t(e.size)}),i):t(0)}))},_process_native:function(e,t){return i=this,n=void 0,s=function(){var i,n,a,s,l;return function(e,t){var i,n,o,a,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(a){return function(l){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,n=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((o=(o=s.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){s.label=a[1];break}if(6===a[0]&&s.label<o[1]){s.label=o[1],o=a;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(a);break}o[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],n=0}finally{i=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,l])}}}(this,(function(r){switch(r.label){case 0:return(i=this.get_url_native())?(this.set("original_url_native",i),[4,(0,o.a)(i,this.get("mimetype"))]):($f.mobile.logging.log_error("Found null in file in _process_file_for_native()"),[2,t()]);case 1:return n=r.sent(),a=n[0],s=n[1],a?($f.mobile.logging.log_error("Failed to copy file to app directory",{path:i,error:JSON.stringify(a)}),t(),[2]):(s.name||($f.mobile.logging.log_error("saved new image/video with undefined name.",{url_cdva:s.toInternalURL(),url_native:s.toURL()}),s.name="zenput-file.jpg"),[4,this._getCdvaFileSize(s)]);case 2:return l=r.sent(),this.set({url_native:s.nativeURL,url_cdva:s.toInternalURL(),raw_file:s,size:l}),e(this),[2]}}))},new((a=void 0)||(a=Promise))((function(e,t){function o(e){try{r(s.next(e))}catch(e){t(e)}}function l(e){try{r(s.throw(e))}catch(e){t(e)}}function r(t){var i;t.done?e(t.value):(i=t.value,i instanceof a?i:new a((function(e){e(i)}))).then(o,l)}r((s=s.apply(i,n||[])).next())}));var i,n,a,s}}),s=n.DR.extend({model:a}),l=n.Dn.extend({defaults:{file:null,filename:"",upload_filename:"",server_filename:"",file_type:"",parent_upload_guid:"",response:"",status:null,upload_percentage:0},submodels:{file:a},_active_jquery_request:null,initialize:function(e,t){this.on("change:upload_percentage",(function(){$f.mobile.notifications.show_upload_progress()}))},cancel_upload:function(){this.get("status")===$f.mobile.uploads.upload_states.PENDING&&this.set("status",$f.mobile.uploads.upload_states.ERROR),this._active_jquery_request&&this._active_jquery_request.abort()},get_timeout:function(){return this.get("file_type").indexOf("video")>-1?9e5:9e4},needs_upload:function(){return _.contains([$f.mobile.uploads.upload_states.ERROR,$f.mobile.uploads.upload_states.PENDING],this.get("status"))},is_upload_finished:function(){return _.contains([$f.mobile.uploads.upload_states.SUCCESS,$f.mobile.uploads.upload_states.MISSING_FILE],this.get("status"))},is_upload_missing:function(){return this.get("status")===$f.mobile.uploads.upload_states.MISSING_FILE},is_upload_active:function(){return this.get("status")===$f.mobile.uploads.upload_states.ACTIVE},upload:function(e){if(e.success=e.success||function(){},e.error=e.error||function(){},$f.mobile.debugging.get_flag("fail_file_uploads"))return e.error();var t=this,i=this.get("file_type");this.set("status",$f.mobile.uploads.upload_states.ACTIVE);var n=function(n,o){$f.mobile.is.native()&&"signature"!=i?t._upload_native(n,o,e.auth):t._upload_web(n,o,e.auth)},o=function(i){t.get("status")!==$f.mobile.uploads.upload_states.MISSING_FILE&&t.set("status",$f.mobile.uploads.upload_states.SUCCESS),e.success(t)},a=function(i){t.set("status",$f.mobile.uploads.upload_states.ERROR),e.error(t,i)};if($f.mobile.is.web()||"signature"===i)n(o,a);else{var s=this.get("file").get_url_native();if(!s)return $f.mobile.logging.log_error("get_url_native() returned null. Skipping file..."),o();$f.mobile.cordova.resolveLocalFileSystemURL(s,(function(e){n(o,a)}),(function(e){$f.mobile.logging.log_error("Unable to resolveLocalFileSystemURL()",{url_native:t.get("file").get_url_native(),error:e}),t.set("status",$f.mobile.uploads.upload_states.MISSING_FILE),o()}))}},_upload_native:function(e,t,i){var n=this,o=this.get("file").get("mimetype");$f.mobile.cordova.resolveLocalFileSystemURL(this.get("file").get_url_native(),(function(a){a.file((function(a){var s=new FileReader;s.onloadend=function(){var a=new Blob([new Uint8Array(this.result)],{type:o});n._perform_xhr(a,o,i,e,t)},s.onerror=function(){s.abort(),t()},s.readAsArrayBuffer(a)}))}))},_upload_web:function(e,t,i){var n=this.get("file").get("raw_file"),o=this.get("file").get("mimetype");if("signature"===this.get("file_type"))return this._perform_xhr(function(e,t){t=t||"";for(var i=1024,n=atob(e),o=n.length,a=Math.ceil(o/i),s=new Array(a),l=0;l<a;++l){for(var r=l*i,_=Math.min(r+i,o),c=new Array(_-r),u=r,d=0;u<_;++d,++u)c[d]=n[u].charCodeAt(0);s[l]=new Uint8Array(c)}return new Blob(s,{type:t})}(n.raw,o),o,i,e,t);this._perform_xhr(n,o,i,e,t)},_perform_xhr:function(e,t,i,n,o){var a=this;this._active_jquery_request=$f.storage.perform_file_upload({file:e,filename:this.get("upload_filename"),mime_type:t,timeout:this.get_timeout(),on_progress:function(e){a.set("upload_percentage",e)},success:n,error:o})}})},"./src/backbone/shared/views/EmptyListMessage.js":function(e,t,i){i.d(t,{G:function(){return n}});var n=i("./src/backbone/shared/views/baseLayoutViews.js").Pz.extend({template:"#tpl_empty_list_message",icon_class:"df-form",i18n_key_title:null,i18n_key_message:"mobile_empty_list_message_no_forms_available",image_filename:null,zenput_code:null,allow_retry:!1,action_button_title:null,events:{click:"retry_fetch"},templateHelpers:function(){this.image_filename&&this.icon_class&&$f.mobile.logging.log_error("Cannot have EmptyListMessage with both icon and image. Defaulting to image.",{image_filename:this.image_filename,icon_class:this.icon_class});var e={icon_class:this.icon_class,image_filename:this.image_filename,allow_retry:this.allow_retry,title:this.i18n_key_title&&_t(this.i18n_key_title),message:_t(this.i18n_key_message)||this.i18n_key_message,action_button_title:this.action_button_title&&_t(this.action_button_title)};return $f.mobile.is.connected()?this.zenput_code===$f.zenput_codes.UNKNOWN_ERROR?(e.icon_class="df-alert",e.image_filename=null,e.title=null,e.message=_t("mobile_dashboard_zenput_code_unknown_error"),e):e:(e.icon_class="df-alert",e.image_filename=null,e.title=null,e.message=_t("mobile_empty_list_message_must_be_online"),e)},initialize:function(e){e=e||{},$.extend(this,e),$f.mobile.set_viewport()},retry_fetch:function(){this.allow_retry&&this.trigger("empty_view:retry_fetch")}})},"./src/backbone/shared/views/ImagePreviewModal.js":function(e,t,i){i.d(t,{e:function(){return o}});var n=i("./src/backbone-unorganized/utils/setStatusBarColor.ts"),o=i("./src/backbone/shared/views/baseLayoutViews.js").IO.extend({template:"#tpl_image_preview_dialog",is_modal:!0,src:null,allow_delete:!0,templateHelpers:function(){return{src:this.src,allow_delete:this.allow_delete}},events:{"click .delete_image":"remove_image"},initialize:function(e){if(e=e||{},$.extend(this,e),!this.src)throw new Error("Programmer Error: no src set for ImagePreviewModal");(0,n.Q)()},onRender:function(){this.$el.addClass("image_preview_modal"),this.on_orientation_change();var e=this.$el.find("#image_preview"),t=this.$el.find(".loading_spinner"),i=this.$el.find(".preview_failed");e.css("opacity",0),t.show();var n=$f.storage.get_high_res_url_from_thumbnail(this.src,234),o=$('<img src="'.concat(n,'" />')),a=this;o.load((function(){e.attr("src",n),a.on_orientation_change(),t.hide(),e.velocity({opacity:1},300,(function(){a.enable_pinch_to_zoom(e),a.on_orientation_change()}))})),o.error((function(){t.hide(),i.velocity("fadeIn")}))},on_orientation_change:function(){o.__super__.on_orientation_change.apply(this,arguments);var e=this.$el.find("#image_preview");e.css("margin","-".concat(e.height()/2,"px auto 0 auto"))},on_click_delete:function(){throw new Error("Programmer Error: on_click_delete() not implemented in ImagePreviewModal")},remove_image:function(){var e=this;return $f.mobile.notifications.confirm(_t("mobile_message_image_confirm_remove_image"),(function(t){t&&(e.on_click_delete(),e.close())})),!1},enable_pinch_to_zoom:function(e){e instanceof jQuery&&(e=e.get(0));var t=new Hammer(e,{});t.get("pinch").set({enable:!0});var i=0,n=0,o=1,a=1,s=0,l=0,r=0,_=0,c="",u=e;t.on("doubletap pan pinch panend pinchend",(function(e){if("doubletap"==e.type){c="translate3d(0, 0, 0) scale3d(2, 2, 1) ",o=2,a=2;try{"matrix(1, 0, 0, 1, 0, 0)"!=window.getComputedStyle(u,null).getPropertyValue("-webkit-transform").toString()&&(c="translate3d(0, 0, 0) scale3d(1, 1, 1) ",o=1,a=1)}catch(e){}u.style.webkitTransform=c,c=""}1!=o&&(i=s+e.deltaX,n=l+e.deltaY,r=Math.ceil((o-1)*u.clientWidth/2),_=Math.ceil((o-1)*u.clientHeight/2),i>r&&(i=r),i<-r&&(i=-r),n>_&&(n=_),n<-_&&(n=-_)),"pinch"==e.type&&(o=Math.max(.999,Math.min(a*e.scale,4))),"pinchend"==e.type&&(a=o),"panend"==e.type&&(s=i<r?i:r,l=n<_?n:_),1!=o&&(c="translate3d("+i+"px,"+n+"px, 0) scale3d("+o+", "+o+", 1)"),c&&(u.style.webkitTransform=c)}))},close:function(){o.__super__.close.apply(this,arguments),(0,n.Q)()}})},"./src/backbone/shared/views/MobileNotificationView.js":function(e,t,i){i.d(t,{m:function(){return n}});var n=Backbone.Marionette.Layout.extend({template:"#tpl_notification",TOP_START:"-100px",TOP_TARGET:null,parent_page:null,_default_classnames:null,events:{click:"hide_notification"},initialize:function(e){e=e||{},$.extend(this,e),this._default_classnames||(this._default_classnames=this.$el.attr("class"))},onRender:function(){this._calculate_top_target(),this._restore_notification()},on_show:function(){this._isShown=!0,this._calculate_top_target(),this._restore_notification()},_calculate_top_target:function(){if(!this.TOP_TARGET&&this._isShown){var e=this.$el.parents(".main_content:not(.stale), #content_overlay");e.find(".toolbarnav").length?this.TOP_TARGET=e.find(".toolbarnav").offset().top+e.find(".toolbarnav").outerHeight():$("html").hasClass("fullscreen")?this.TOP_TARGET="".concat($(".fullscreen_filler").height()+43,"px"):this.TOP_TARGET="43px"}},_restore_notification:function(){this._isShown&&this.parent_page&&!this.parent_page.is_modal&&$f.mobile.notifications.restore_active_toast()},show_notification:function(e){(e=e||{}).show_method||(e.show_method="normal");var t=this;this._reset_notification_classes(!0),this.$el.css({top:"normal"!=e.show_method?this.TOP_TARGET:this.TOP_START,display:"block"});var i=function(){t.$el.find(".msg").html(e.msg),t.$el.find(".msg_icon").attr("class","msg_icon"),e.icon?t.$el.find(".msg_icon").addClass(e.icon).show():t.$el.find(".msg_icon").hide()};"replace"==e.show_method?this.$el.find(".toast_body").velocity({opacity:0},{duration:300,complete:function(){i(),t.$el.find(".toast_body").velocity({opacity:1},{duration:300})}}):i(),this._reset_notification_classes(!1),this.$el.addClass(e.html_class),"normal"==e.show_method&&this.$el.velocity({top:this.TOP_TARGET},{duration:500,easing:"easeOutQuint"})},hide_notification:function(){var e=this;return $f.application.vent.trigger("notification:hiding"),$(".toast_notification").not(this.$el).hide(),this.$el.velocity("stop"),this.$el.velocity({top:this.TOP_START},{duration:300,complete:function(){e._reset_notification_classes(!0)}}),!1},_reset_notification_classes:function(e){e&&this.$el.attr("style",""),this.$el.attr("class",this._default_classnames)}})},"./src/backbone/shared/views/MobileSearchBar.js":function(e,t,i){i.d(t,{R:function(){return n}});var n=Backbone.Marionette.Layout.extend({template:"#tpl_search_bar",className:"search_wrapper",collection:null,i18n_key_placeholder:"mobile_placeholder_search_bar",default_value:"",is_search_running:0,search_delay:1e3,min_chars:1,on_search_clear:function(){},search:function(e,t){throw new Error("Programmer Error: MobileSearchBar needs implemented search() method.")},events:{"keyup .search":"search_keypress","click .clear_search":"clear_search","focus .search":"on_focus","blur .search":"on_blur"},templateHelpers:function(){return{default_value:this.default_value,placeholder:_t(this.i18n_key_placeholder)||this.i18n_key_placeholder}},initialize:function(e){e=e||{},$.extend(this,e)},onRender:function(){this.determine_has_value()},search_keypress:function(e){var t=this,i=e.target.value;0==i.length&&(i=""),i.length<=this.min_chars&&0!=i.length||(clearTimeout(this.is_search_running),this.is_search_running=setTimeout((function(){t.search(i)}),t.search_delay))},clear_search:function(e){return this.$el.find(".search").val(""),this.search(""),this.on_search_clear(e),this.determine_has_value(),!1},on_focus:function(e){this.$el.addClass("search_active")},on_blur:function(e){this.$el.removeClass("search_active"),this.determine_has_value()},determine_has_value:function(){this.$el.find(".search").val()?this.$el.addClass("search_has_val"):this.$el.removeClass("search_has_val")}})},"./src/backbone/shared/views/ModalOptionsView.js":function(e,t,i){i.d(t,{Z:function(){return n}});var n=Backbone.Marionette.Layout.extend({template:"#tpl_modal_options",class_name:"",top:null,right:null,buttons:null,text:"",events:{"click .flyout_touchblock":"non_button_close","touchdown .flyout_touchblock":"non_button_close"},templateHelpers:function(){return{buttons:this.buttons,text:this.text,class_name:this.class_name}},initialize:function(e){var t=this;if(e=e||{},$.extend(this,e),null===this.top||null===this.right)throw new Error("Programmer Error: ModalOptionsView requires top and right position.");if(0===this.buttons.length)throw new Error("Programmer Error: ModalOptionsView must receive at least one button.");_.each(this.buttons,(function(e,i){var n="click .btn_".concat(i);t.events[n]=function(){t.callback(i+1),t.close()}}))},onShow:function(){this.$el.find(".flyout").css({right:this.right,top:this.top}),$(".page_scrollable").on("scroll",this.non_button_close.bind(this)),window.addEventListener("resize",this.non_button_close.bind(this))},onBeforeClose:function(){$(".page_scrollable").off("scroll",this.non_button_close.bind(this)),window.removeEventListener("resize",this.non_button_close.bind(this))},non_button_close:function(){this.callback(3,!1),this.close()}})},"./src/backbone/shared/views/SelectAccountModal.js":function(e,t,i){i.d(t,{H:function(){return c}});var n=i("./src/backbone-unorganized/models.js"),o=i("./src/backbone-unorganized/shared/forms.js"),a=i("./src/backbone/shared/views/EmptyListMessage.js"),s=i("./src/backbone/shared/views/baseLayoutViews.js"),l=i("./src/backbone/shared/views/typeaheads.js"),r=s.IO.extend({template:"#tpl_create_account",is_modal:!0,className:"dialog",attributes:{id:"create_account"},toolbarnav_title:function(){return _t("mobile_toolbarnav_title_add_location")},toolbarnav_center_title:!0,model:null,form_field_model:null,events:{'change select[name="country"]':"change_select_country","click .save_account":"save"},initialize:function(e){e=e||{},$.extend(this,e),this.model||(this.model=new o.mR),Backbone.Validation.unbind(this),Backbone.Validation.bind(this)},onShow:function(){r.__super__.onShow.apply(this,arguments),this.prefill_account_details()},change_select_country:function(e){return this._change_country($(e.target).val()),!1},_change_country:function(e){"US"==e?(this.$el.find(".new_account_region").hide().val(""),this.$el.find(".new_account_state").show().val("")):(this.$el.find(".new_account_region").show().val(""),this.$el.find(".new_account_state").hide().val(""))},prefill_account_details:function(){if($f.mobile.is.connected()){$f.mobile.notifications.show_loading_dialog();var e=this;$f.mobile.load_google_maps_api({success:function(){$f.mobile.get_device_location({success:function(t){var i=new google.maps.LatLng(t.coords.lat,t.coords.lon);(new google.maps.Geocoder).geocode({latLng:i},(function(t,i){if($f.mobile.notifications.hide_loading_dialog(),i==google.maps.GeocoderStatus.OK&&0!=t.length){var n,o,a,s,l=t[0];$.each(l.address_components,(function(e,t){"locality"==t.types[0]?n=t.long_name:"country"==t.types[0]?s=t.short_name:"administrative_area_level_1"==t.types[0]?o=t.short_name:"postal_code"==t.types[0]&&(a=t.long_name)})),e.$el.find(".new_account_country").val(s),e._change_country(s),e.$el.find(".new_account_city").val(n),e.$el.find(".new_account_state").val(o),e.$el.find(".new_account_region").val(o),e.$el.find(".new_account_zipcode").val(a)}}))},error:function(){$f.mobile.notifications.hide_loading_dialog()}})},error:function(){$f.mobile.notifications.hide_loading_dialog()}})}},save:function(e){var t=this,i=this.$el.find(".new_account_country").val(),n=this.$el.find(".new_account_state").val();return"US"!=i&&(n=this.$el.find(".new_account_region").val()),this.model.set({name:this.$el.find(".new_account_name").val(),city:this.$el.find(".new_account_city").val(),address:this.$el.find(".new_account_address").val(),state:n,country:i,zipcode:this.$el.find(".new_account_zipcode").val(),email:this.$el.find(".new_account_email").val(),phone:this.$el.find(".new_account_phone").val()}),this.model.isValid(!0)?this.form_field_model?(this.form_field_model.set("account",this.model.toJSON()),this.close(),!1):($f.mobile.notifications.show_loading_dialog(),this.model.save({},{success:function(){$f.mobile.notifications.hide_loading_dialog(),t.close(),$f.mobile.notifications.show_success_msg(_t("mobile_message_create_account_success_location_created"))},error:function(){$f.mobile.notifications.hide_loading_dialog(),$f.mobile.notifications.show_error_msg()}}),!1):($f.mobile.notifications.show_error_msg(_t("mobile_message_create_account_error_fields")),!1)},onBeforeClose:function(){Backbone.Validation.unbind(this)}}),c=l.kG.extend({collection:null,form_collection:null,toolbarnav_title:function(){return _t("mobile_toolbarnav_title_select_location")},focus_search_on_open:!1,form_field_model:null,itemView:l.Ec,events:_.extend({"click .add_account":"click_add_account"},l.kG.prototype.events),format_result:function(e){var t=e.get("distance")?e.get("distance").toFixed(1)+" mi":"";return _.template("<div class='listitem_title'><%- location_name %></div> <div class='clear'></div> <div class='listitem_distance'><%- distance_section %></div> <div class='listitem_subtitle'><%- address %></div>")({location_name:e.get("name"),distance_section:t,address:e.get("address")})},getEmptyView:function(){return a.G.extend({icon_class:"df-location",i18n_key_message:"mobile_empty_list_message_no_accounts"})},initialize:function(e){e=e||{},$.extend(this,e),this.is_historic_view&&(this.default_value=this.collection.paginator.get("search_query"));var t=null;try{t=this.form_field_model.get("options")[0]}catch(e){}var i=null,o=!1;this.form_collection&&!0===this.form_collection.metadata.get("allow_auditors_access_locations")&&(i=this.form_collection.metadata.get("rdbms_id"),o=!0),this.collection=this.collection||new n.RM([],{tag_id:t,form_collection:this.form_collection,rdbms_id:i,allow_cross_company_access:o}),c.__super__.initialize.apply(this,arguments)},on_toolbarnav_init:function(){c.__super__.on_toolbarnav_init.apply(this,arguments);var e=this;$f.active_company.has_feature("add_account_mobile")&&e.toolbarnav.add_actions([{container_class:"add_account",icon_class:"df-plus",i18n_key_text:"mobile_toolbarnav_title_add_location",display:"text"}])},click_add_account:function(e){return this.is_modal&&this.close(),$f.mobile.nav.show_modal(r,{form_field_model:this.form_field_model}),!1}})},"./src/backbone/shared/views/baseLayoutViews.js":function(e,t,i){i.d(t,{HN:function(){return a},Pz:function(){return s},c1:function(){return l},mp:function(){return r},IO:function(){return c},R1:function(){return u}});var n=i("./src/backbone/features/toolbarNav/views.js"),o=i("./src/backbone/shared/views/MobileNotificationView.js"),a=Backbone.Marionette.View.extend(),s=Backbone.Marionette.CompositeView.extend({on_orientation_change:function(){},on_resume:function(){}}),l=s.extend({initialize:function(e){e=e||{},$.extend(this,e);var t=this;this.listenTo($f.application.vent,"app:orientation_change",(function(){$f.mobile.orientation.wait_orientation_change_landscape().then((function(){t.on_orientation_change()}))}))}}),r=s.extend({toolbarnav:null,toolbarnav_class:n.MV,toolbarnav_title:null,toolbarnav_subtitle:null,toolbarnav_actions:null,toolbarnav_show_add_task:!0,toolbarnav_show_edit_sensor:!1,toolbarnav_create_task_options:null,toolbarnav_center_title:!1,notification:null,use_transitions:!1,allow_reverse_transitions:!0,is_top_level_page:!1,is_historic_view:!1,auto_resize_page_scrollable:!0,_base_toolbarnav_page_class:null,constructor:function(){return c.prototype.constructor.apply(this,arguments)},render:function(){return c.prototype.render.apply(this,arguments)},init_toolbarnav:function(){return c.prototype.init_toolbarnav.apply(this,arguments)},onShow:function(){return c.prototype.onShow.apply(this,arguments)},on_toolbarnav_init:function(){return c.prototype.on_toolbarnav_init.apply(this,arguments)},on_orientation_change:function(){return c.prototype.on_orientation_change.apply(this,arguments)},scroll_to_element:function(){return c.prototype.scroll_to_element.apply(this,arguments)},go_back:function(){return c.prototype.go_back.apply(this,arguments)},show_back_button:function(){return c.prototype.show_back_button.apply(this,arguments)}}),c=Backbone.Marionette.Layout.extend({toolbarnav:null,toolbarnav_class:n.MV,toolbarnav_title:null,toolbarnav_subtitle:null,toolbarnav_actions:null,toolbarnav_select_options:null,toolbarnav_show_add_task:!0,toolbarnav_show_edit_sensor:!1,toolbarnav_toggle_search:!1,toolbarnav_create_task_options:null,toolbarnav_center_title:!1,is_modal:!1,notification:null,use_transitions:!1,allow_reverse_transitions:!0,is_top_level_page:!1,is_historic_view:!1,auto_resize_page_scrollable:!0,_base_toolbarnav_page_class:null,constructor:function(e){e=e||{};var t=this;this instanceof c?this._base_toolbarnav_page_class=c:this instanceof r&&(this._base_toolbarnav_page_class=r),(this.is_modal||e&&e.is_modal)&&(this.className="dialog typeahead_modal",this.toolbarnav_show_add_task=!1),$f.storage.refresh(),this._base_toolbarnav_page_class.__super__.constructor.apply(this,arguments),this.listenTo($f.application.vent,"app:orientation_change",(function(){t.on_orientation_change()})),this.listenTo($f.application.vent,"cordova:keyboard:show cordova:keyboard:hide",(function(e){if(t.$el)return t.auto_resize_page_scrollable?$f.mobile.update_page_scrollable_height(t.$el):void $f.application.vent.trigger("comments_tab:on_orientation_change")}))},on_resume:function(){},render:function(){this._base_toolbarnav_page_class.__super__.render.call(this),this.init_toolbarnav(),0==this.$el.find(".toast_notification").length&&this.$el.prepend('<div class="toast_notification"></div>'),this.notification=new o.m({el:this.$el.find(".toast_notification").get(0),$el:this.$el.find(".toast_notification"),parent_page:this}).render(),this._isShown&&(this.notification.on_show(),this.on_orientation_change())},init_toolbarnav:function(){if(this.toolbarnav_class){var e=this;this.toolbarnav&&this.toolbarnav.close(),0==this.$el.find(".toolbarnav").length&&this.$el.prepend('<header class="toolbarnav"></header>'),$("html").hasClass("fullscreen")&&this.$el.prepend('<div class="fullscreen_filler"></div>'),this.page_title&&_.isFunction(this.page_title)&&(this.page_title=this.page_title()),this.page_subtitle&&_.isFunction(this.page_subtitle)&&(this.page_subtitle=this.page_subtitle()),this.toolbarnav=new this.toolbarnav_class({el:this.$el.find(".toolbarnav").get(0),$el:this.$el.find(".toolbarnav"),parent_page:this,page_title:_.isFunction(this.toolbarnav_title)?this.toolbarnav_title():this.toolbarnav_title,page_subtitle:_.isFunction(this.toolbarnav_subtitle)?this.toolbarnav_subtitle():this.toolbarnav_subtitle,show_back_button:this.show_back_button(),actions:this.toolbarnav_actions,toolbarnav_select_options:this.toolbarnav_select_options,primary_action:this.primary_action,show_add_task:this.toolbarnav_show_add_task,show_edit_sensor:this.toolbarnav_show_edit_sensor,toggle_search:this.toolbarnav_toggle_search,create_task_options:this.toolbarnav_create_task_options,center_title:this.toolbarnav_center_title}).render(),this._isShown&&this.toolbarnav.on_show(),this.listenTo(this.toolbarnav,"toolbarnav:go_back",(function(){e.go_back()})),this.on_toolbarnav_init()}},onShow:function(){var e=this.$el.parents(".main_content, #content_overlay");this.$el.find(".search_bar:visible").length>0?e.addClass("has_search_bar"):e.removeClass("has_search_bar"),this.toolbarnav&&this.toolbarnav.on_show&&this.toolbarnav.on_show(),this.notification&&this.notification.on_show&&this.notification.on_show(),this.is_historic_view&&$f.mobile.nav.restore_scroll_position(),this.on_orientation_change()},on_toolbarnav_init:function(e){},show_back_button:function(){return!this.is_top_level_page},scroll_to_element:function(e,t,i){$f.mobile.scroll_to_element(this.$el.find(".page_scrollable"),e,t,i)},on_orientation_change:function(e){(e=e||this.$el).find(".search_bar").height()>0?e.find(".toggle_search").addClass("active"):e.find(".toggle_search").removeClass("active"),this.auto_resize_page_scrollable&&$f.mobile.update_page_scrollable_height(e)},go_back:function(){this.is_modal?this.close():$f.mobile.nav.go_back()}}),u=Backbone.Marionette.Layout.extend({template:"#tpl_bottom_sheet",className:"bottom_sheet",ANIMATION_TIME_MS:500,title:null,events:{"click .close_bottom_sheet":"close"},regions:{r_bottom_sheet_body:".bottom_sheet_body"},initialize:function(e){if(e=e||{},$.extend(this,e),!this.title)throw new Error("Programmer Error: no title specified for BottomSheet")},onBeforeRender:function(){this._isRendered||this.$el.css("transform","translateY(100%)")},onShow:function(){var e=this;this._animate(!0,(function(){setTimeout((function(){e.$el.find(".page_scrollable").css("height",$(window).outerHeight()-e.$el.find(".page_scrollable").offset().top)}),10)})),$f.mobile.nav.show_modal_touchblock({duration:this.ANIMATION_TIME_MS},(function(){e.close()}))},_animate:function(e,t){t=t||function(){},this.$el.velocity({translateY:e?["0%","100%"]:["100%","0%"]},{duration:this.ANIMATION_TIME_MS,easing:"easeOutCirc",complete:t})},close:function(){var e=this,t=arguments;return $f.mobile.nav.hide_modal_touchblock({duration:this.ANIMATION_TIME_MS}),this._animate(!1,(function(){u.__super__.close.apply(e,t)})),!1}})},"./src/backbone/shared/views/tabs.js":function(e,t,i){i.d(t,{WD:function(){return s},OY:function(){return l}});var n=Backbone.Marionette.ItemView.extend({template:"#tpl_tabbed_nav_item",model:null,className:"tabbed_nav_item",tagName:"a",attributes:{href:"#"},triggers:{set_active_tab__noop:"set_active_tab"},events:{click:"on_click"},initialize:function(e){e=e||{},$.extend(this,e)},onRender:function(){var e=this.model.get("tab_class"),t="".concat(this.className," ").concat(e);this.$el.hasClass("active")&&(t+=" active"),this.$el.attr("class",t)},on_click:function(e){return this.trigger("set_active_tab",this),!1}}),o=Backbone.Marionette.CompositeView.extend({template:"#tpl_tabbed_nav",className:"tabbed_nav",collection:null,itemView:n,itemViewContainer:".tabs_list",itemViewEventPrefix:"tab",is_tabs_full_width:!1,active_tab_id:null,CLASSNAME_TABS_FULL_WIDTH:"is_tabs_full_width",on_tab_selected:function(e){},initialize:function(e){e=e||{},$.extend(this,e);var t=this;this.is_tabs_full_width&&this.listenTo($f.application.vent,"app:orientation_change",(function(){t._adjust_nav_marker()}))},onShow:function(){this.render()},onRender:function(){if(this._isShown&&this.collection.length){if(!this.$el.outerWidth(!0))throw new Error("Programmer Error: TabbedNav calculating tab widths before attaching to DOM");this.is_tabs_full_width?this.$el.addClass(this.CLASSNAME_TABS_FULL_WIDTH):this.$el.removeClass(this.CLASSNAME_TABS_FULL_WIDTH);var e=this;this.off("tab:set_active_tab"),this.on("tab:set_active_tab",(function(t){e.set_active_tab(t)})),this.active_tab_id&&this.collection.get(this.active_tab_id)?this.set_active_tab(this.children.findByModel(this.collection.get(this.active_tab_id))):this.set_active_tab(this.children.first())}},set_active_tab:function(e){this.active_tab_id=e.model.id,this.$el.find(".active").removeClass("active"),e.$el.addClass("active"),this._adjust_nav_marker(),this.on_tab_selected(e.model)},_adjust_nav_marker:function(){var e=this.$el.find(".active"),t=e.position().left-e.parent().position().left,i=(e.offset().left-this.$el.find(".nav_marker").offset().left)/3,n=e.parents(".tabbed_nav").scrollLeft()+i;this.$el.find(".nav_marker").css({left:t+"px",width:e.outerWidth(!0)}),e.is(":first-child")&&(n=0),this.$el.animate({scrollLeft:n},200)}}),a=Backbone.Marionette.CollectionView.extend({collection:null,itemViewOptions:function(e,t){return $.extend({},{__tabbed_nav_page_lists_item:e,model:null},e.get("view_options")||{})},getItemView:function(e){var t=e.get("view_class");if(!t)throw new Error("Programmer Error: view_class not set on TabbedLayoutPageListItem");return t}}),s=Backbone.Marionette.Layout.extend({template:"#tpl_tabbed_layout",tab_pages:null,hide_tabs:!1,is_tabs_full_width:!1,active_tab_id:null,regions:{r_tabbed_nav:".tabbed_nav_container",r_tab_pages:".tabbed_layout_pages"},initialize:function(e){e=e||{},$.extend(this,e)},onShow:function(){this.render()},onRender:function(){var e=this;if(this._isShown){var t=this;this.r_tab_pages.show(new a({collection:this.tab_pages})),this.hide_tabs||(this.r_tabbed_nav.show(new o({collection:this.tab_pages,is_tabs_full_width:this.is_tabs_full_width,active_tab_id:this.active_tab_id,on_tab_selected:function(t){e.jump_to_page(t.id,!0,!0),e.trigger("change_active_tab",t.id)}})),this.stopListening($f.application.vent,"app:orientation_change"),this.listenTo($f.application.vent,"app:orientation_change",(function(){t.jump_to_page(t.active_tab_id,!1,!1)})),this.listenTo($f.application.vent,"tabbed_layout:jump_to_page",(function(e){t.active_tab_id=e;var i=t.r_tabbed_nav.currentView;i.set_active_tab(i.children.findByModel(i.collection.get(t.active_tab_id))),t.jump_to_page(t.active_tab_id,!0,!1)})))}},jump_to_page:function(e,t,i){var n=this;if(e&&(t=!1!==t,i=!1!==i,this.tab_pages.get(e))){var o=this.$el.find(".tabbed_layout_pages"),a=this.r_tab_pages.currentView.children.find((function(t){return t.__tabbed_nav_page_lists_item.get("id")===e}));if(!a)throw new Error("Programmer Eror: unable to find TabbedLayout page "+e);this.active_tab_id=e,i&&setTimeout((function(){n.$el.find(".tabbed_layout_page.active").removeClass("active"),a.$el.addClass("active"),a.on_tab_focused()}),210),o.velocity({translateX:"-".concat(100*a.$el.index(),"%")},{duration:t?210:0})}},update_tab:function(e){var t;if(!(e=e||{}).id)throw new Error("Programmer Error: tab_id is missing from update_tab method");if(!e.changes)throw new Error("Programmer Error: changes is missing from update_tab method");(t=this.tab_pages.get(e.id))&&this.r_tabbed_nav.currentView.children.findByModel(t).render()}}),l=Backbone.Marionette.Layout.extend({template:"#tpl_tabbed_layout_page",className:"tabbed_layout_page",__tabbed_nav_page_lists_item:null,initialize:function(e){e=e||{},$.extend(this,e)},render:function(){l.__super__.render.apply(this,arguments);var e=this;this.$el.addClass(this.__tabbed_nav_page_lists_item.id),setTimeout((function(){$f.mobile.update_page_scrollable_height(e.$el)}),$f.mobile.DELAY_ON_ORIENTATION_CHANGE_MS)},on_tab_focused:function(){}})},"./src/backbone/shared/views/typeaheads.js":function(e,t,i){i.d(t,{y3:function(){return r},g5:function(){return c},Ec:function(){return u},kG:function(){return d}});var n=i("./src/backbone/shared/views/EmptyListMessage.js"),o=i("./src/backbone/shared/views/MobileSearchBar.js"),a=i("./src/backbone/shared/views/baseLayoutViews.js"),s=Backbone.Marionette.ItemView.extend({template:"#tpl_select_field_selection_item",className:"select_field_selection_item",model:null,events:{"click .remove":"unselect_item"},initialize:function(e){e=e||{},$.extend(this,e)},unselect_item:function(e){return this.model.trigger("destroy",this.model,this.model.collection),!1}}),l=Backbone.Marionette.CollectionView.extend({collection:null,itemView:s,on_item_removed:function(e){},on_item_clicked:function(e){},events:{"click .select_field_selection_item:not(.remove)":"on_item_clicked"},initialize:function(e){e=e||{},$.extend(this,e);var t=this;this.stopListening(this.collection,"remove"),this.listenTo(this.collection,"remove",(function(){t.on_item_removed(t.collection)}))}}),r=Backbone.Marionette.Layout.extend({template:"#tpl_zp_autocomplete",model:null,collection:null,i18n_key_placeholder:"",modal_class:null,allow_multiple:!1,collection_class:null,html_name:null,is_create_context:!1,events:{"focus input":"launch_modal"},regions:{r_selections:".selected_list_container"},templateHelpers:function(){return{default_value:this.get_default_value(),allow_multiple:this.allow_multiple,placeholder:_t(this.i18n_key_placeholder)||this.i18n_key_placeholder,html_name:this.html_name}},post_on_select:function(e){},on_clear:function(){},get_default_value:function(){throw new Error("Programmer error: BaseTypeahead.get_default_value() not implemented.")},get_current_selections:function(){throw new Error("Programmer error: BaseTypeahead.get_current_selections() not implemented.")},on_item_removed:function(e){},get_modal_options:function(){var e={model:this.model,post_on_select:this.post_on_select,on_clear:this.on_clear,default_value:this.get_default_value(),allow_multiple:this.allow_multiple,default_selections:this.allow_multiple?this.get_current_selections():null,is_create_context:this.is_create_context};return this.collection&&(e.collection=this.collection),this.collection_class&&(e.collection_class=this.collection_class),this.allow_multiple&&(e.default_selections=this.get_current_selections()),e},initialize:function(e){if(e=e||{},$.extend(this,e),!this.modal_class)throw new Error("Programmer Error: must pass modal_class to MobileBaseTypeahead.");this.allow_multiple&&(this.i18n_key_placeholder="mobile_placeholder_select");var t=this.post_on_select,i=this;this.post_on_select=function(e){t(e),i.render()};var n=this.on_clear;this.on_clear=function(){n(),i.render()}},render:function(){if(r.__super__.render.apply(this,arguments),this.allow_multiple){var e=this,t=this.get_current_selections();if(!(t instanceof Backbone.Collection)){if(!this.collection_class)throw new Error("Programmer Error: collection_class not defined, and MobileBaseTypeahead.get_current_selections() not returning Collection.");t=new this.collection_class(t)}this.r_selections.show(new l({collection:t,on_item_removed:this.on_item_removed,on_item_clicked:function(t){e.launch_modal(t)}}))}},launch_modal:function(e){$(e.target).hasClass("fake_input")&&$f.mobile.nav.show_modal(this.modal_class,this.get_modal_options())}}),_=Backbone.Marionette.CollectionView.extend({tagName:"ul",className:"typeahead_modal_content pagelist results",collection:null,itemView:null,itemViewOptions:null,itemViewEventPrefix:"item",triggers:{item_selected__noop:"item_selected"},getEmptyView:function(){return n.G.extend({i18n_key_message:"mobile_empty_list_message_no_results_found"})},initialize:function(e){e=e||{},$.extend(this,e);var t=this;this.on("item:select_toggled",(function(e,i){t.trigger("item_selected",e,i)})),this.listenTo(this.collection,"sort",this.render)}}),c=Backbone.Marionette.ItemView.extend({template:"#tpl_typeahead_item",tagName:"li",show_checkmark:!1,format_result:function(e){},triggers:{selected__noop:"select_toggled"},modelEvents:{change:"render"},events:{click:"on_clicked"},templateHelpers:function(){return{formatted_result:this.format_result(this.model),show_checkmark:this.show_checkmark,is_checked:this.model.is_checked}},initialize:function(e){e=e||{},$.extend(this,e)},on_clicked:function(e){return this.show_checkmark&&this.toggle_checked(),this.trigger("select_toggled",this.model),!1},toggle_checked:function(){this.model.is_checked?(this.model.is_checked=!1,this.render()):(this.model.is_checked=!0,this.render())}}),u=c.extend({template:"#tpl_typeahead_html_item"}),d=a.IO.extend({template:"#tpl_typeahead_modal",is_modal:!0,collection:null,toolbarnav_title:"",default_value:"",default_search:"",allow_multiple:!1,focus_search_on_open:!0,toolbarnav_center_title:!0,collection_class:null,default_selections:null,_default_selections_json:null,_selected_models:null,itemView:c,itemViewOptions:function(){return{format_result:this.format_result,show_checkmark:this.allow_multiple}},regions:{r_results:".typeahead_results_region"},events:{"click .multiselect_done":"click_multiselect_done"},templateHelpers:function(){return{placeholder:this.placeholder||_t("mobile_placeholder_search_bar"),display_name:this.default_value,allow_multiple:this.allow_multiple}},initialize:function(e){if(e=e||{},$.extend(this,e),!this.collection&&!this.collection_class)throw new Error("Programmer Error: must pass collection to BaseTypeaheadModal.");if(this.collection_class&&!this.collection&&(this.collection=new this.collection_class),this.addRegion("r_search_bar",".search_bar"),this.allow_multiple){if(!this.collection_class)throw new Error("Programmer Error: must pass collection_class to BaseTypeaheadModal.");if(this.default_selections){var t;t=this.default_selections instanceof Backbone.Collection?this.default_selections.toJSON():this.default_selections,this._default_selections_json=$f.utils.deepclone(t)}else this._default_selections_json=[];this._selected_models=new this.collection_class(this._default_selections_json),this.collection.length>0&&this.register_selected_results()}},render:function(){d.__super__.render.apply(this,arguments);var e=this;this.r_search_bar.show(new o.R({collection:this.collection,placeholder:this.placeholder,default_value:this.default_value,on_search_clear:function(t){e.on_clear()},search:function(t,i){e.search(t,i)}})),this.r_results.show(new _({collection:this.collection,itemView:this.itemView,itemViewOptions:this.itemViewOptions(),getEmptyView:this.getEmptyView})),this.listenTo(this.r_results.currentView,"item_selected",(function(t,i){!e.allow_multiple||i.is_checked?e.on_select(i):e.on_deselect(i)}))},onShow:function(){d.__super__.onShow.apply(this,arguments),$f.application.vent.trigger("mobile:close_leftmenu");var e=this;this.focus_search_on_open&&setTimeout((function(){e.$el.find("input.search").focus()}),100);var t=this.collection.paginator&&this.collection.paginator.get("search_query");t&&this.default_value!==t?this.search(this.default_value):this.is_historic_view||this.search(this.default_search)},on_select:function(e){return this.allow_multiple?(this._selected_models.add(e),!1):(this.post_on_select(e),this.close(),!1)},on_deselect:function(e){return this.allow_multiple?(this._selected_models.remove(e),!1):(console.warn("on_deselect() called for single select typeahead."),!1)},search:function(e,t){t||(t=function(){}),e||(e="");var i=this,n=$f.mobile.is.web()||$f.mobile.is.connected();$f.mobile.notifications.show_loading_dialog(),this.collection.typeahead_search(e,(function(e){$f.mobile.notifications.hide_loading_dialog();var n=i.transform_collection(e);n!==e&&(n instanceof Backbone.Collection&&(n=n.toJSON()),i.collection.reset(n)),i.allow_multiple&&i.register_selected_results(),t()}),n)},register_selected_results:function(){var e=this;this.collection.each((function(t){e._selected_models.get(t.get(t.idAttribute))?(t.is_checked=!0,t.trigger("change")):(t.is_checked=!1,t.trigger("change"))}))},transform_collection:function(e){return e},post_on_select:function(e){},on_clear:function(){return!1},format_result:function(e){if(e.get("title"))return e.get("title");throw new Error("Programmer Error: BaseTypeaheadModal subclass must implement format_result. Default 'title' not found.",{item_id:e.id,model:e.toJSON()})},values_have_changed:function(){return JSON.stringify(this._selected_models.toJSON())!==JSON.stringify(this._default_selections_json)},click_multiselect_done:function(e){return(e instanceof $.Event||e)&&this.post_on_select(this._selected_models),this.close(),!1},go_back:function(){if(this.allow_multiple&&this.values_have_changed()){var e=this;return $f.mobile.notifications.confirm(_t("mobile_message_typehead_confirm_save_message"),(function(t){t?e.click_multiselect_done(!0):e.click_multiselect_done(!1)}),_t("mobile_message_typehead_confirm_save_title"),_t("mobile_common_button_yes"),_t("mobile_common_button_no")),!1}d.__super__.go_back.apply(this,arguments)}})}}]);
//# sourceMappingURL=bundle-e6d2350c7d9f9b964295.mobile-6431eea9.bundle.js.map